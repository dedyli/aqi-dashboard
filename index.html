<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global AQI Dashboard - Tsinghua University</title>

  <!-- ArcGIS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;overflow:hidden}

    /* Header */
    .header{background:linear-gradient(135deg,#8B2B8B 0%,#2D2D2D 100%);height:70px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1001;position:relative}
    .header-left{display:flex;align-items:center;gap:14px}
    .hamburger,.settings{background:rgba(255,255,255,.22);border:0;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
    .hamburger:hover,.settings:hover{background:rgba(255,255,255,.32)}
    .header h1{font-size:16px;font-weight:700}
    .header h2{font-size:13px;opacity:.9;font-style:italic;font-weight:400}

    /* Layout */
    #viewDiv{position:absolute;top:70px;left:0;right:0;bottom:0;transition:.25s}
    #viewDiv.sidebar-open{left:320px}
    #viewDiv.settings-open{right:320px}

    /* Sidebar & Settings */
    .sidebar,.settings-panel{
      position:fixed;top:70px;width:320px;height:calc(100vh - 70px);
      background:linear-gradient(180deg,#8B2B8B 0%,#4A4A4A 100%);color:#fff;padding:18px;z-index:1000;overflow:auto;transition:.25s
    }
    .sidebar{left:-320px}.sidebar.open{left:0;box-shadow:2px 0 12px rgba(0,0,0,.35)}
    .settings-panel{right:-320px}.settings-panel.open{right:0;box-shadow:-2px 0 12px rgba(0,0,0,.35)}
    h3{border-bottom:1px solid rgba(255,255,255,.3);padding-bottom:8px;margin:14px 0 10px;font-size:15px}

    /* Search */
    .search-input{width:100%;padding:12px;border:0;border-radius:8px;background:rgba(255,255,255,.16);color:#fff;margin:6px 0 10px}
    .search-input::placeholder{color:rgba(255,255,255,.75)}
    .search-btn{width:100%;padding:12px;background:#0079c1;border:0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}

    /* City list */
    .city-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer}
    .city-item:hover{background:rgba(255,255,255,.06)}
    .tag{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag.good{background:#00e400}
    .tag.mod{background:#ffff00;color:#000}
    .tag.bad{background:#ff4444}

    /* Basemap options */
    .basemap-option{background:rgba(255,255,255,.1);padding:10px;margin:6px 0;border-radius:8px;text-align:center;cursor:pointer}
    .basemap-option.active{background:#0079c1;font-weight:700}

    /* Legend */
    .esri-legend{background:rgba(255,255,255,.92)!important;border-radius:10px!important;box-shadow:0 8px 18px rgba(0,0,0,.25)!important}

    /* Loading */
    #loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#8B2B8B}

    /* Floating Chat (draggable + minimizable) */
    #chat{position:fixed;right:20px;bottom:20px;width:340px;max-height:70vh;background:#1f1f1f;color:#f5f5f5;border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.35);z-index:1200;display:flex;flex-direction:column;overflow:hidden}
    #chatHead{background:linear-gradient(135deg,#9a3bb8,#612aa1);color:#fff;padding:10px 12px;font-weight:800;display:flex;align-items:center;justify-content:space-between;cursor:move;user-select:none}
    .cbtn{background:transparent;border:0;color:#fff;font-size:16px;font-weight:800;cursor:pointer}
    #chatBody{display:flex;flex-direction:column}
    #msgs{padding:10px;height:240px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{padding:8px 10px;border-radius:10px;line-height:1.4;font-size:14px;max-width:88%}
    .me{align-self:flex-end;background:#2f2f2f}
    .bot{align-self:flex-start;background:#f2ecf4;color:#111}
    #composer{display:flex;border-top:1px solid rgba(255,255,255,.12)}
    #q{flex:1;padding:10px;border:0;background:#121212;color:#fff}
    #send{padding:10px 12px;border:0;background:#0079c1;color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <button id="hamburgerBtn" class="hamburger">‚ò∞</button>
      <div>
        <h1>Group 62 IEDE Research Topic</h1>
        <h2>AI-Driven Environmental Monitoring for a Green Economy</h2>
      </div>
    </div>
    <button id="settingsBtn" class="settings">‚öôÔ∏è Settings</button>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="search">
      <h3>üîç Location Search</h3>
      <input id="searchInput" class="search-input" placeholder="Enter city name‚Ä¶">
      <button id="searchBtn" class="search-btn">Search Location</button>
    </div>

    <h3>üè≠ Most Polluted Cities (Live)</h3>
    <div id="topCities"><div style="opacity:.85">Loading‚Ä¶</div></div>

    <h3>üìà Notes</h3>
    <div style="opacity:.9;font-size:13px">Data: OpenAQ via Esri Living Atlas (latest ~hour). Values filtered to 0‚Äì500 ¬µg/m¬≥ and cities with ‚â•3 stations.</div>

    <h3>‚ÑπÔ∏è Status</h3>
    <div id="status" style="opacity:.9;font-size:13px"></div>
  </aside>

  <!-- Settings Panel -->
  <aside id="settingsPanel" class="settings-panel">
    <h3>üó∫Ô∏è Map Style</h3>
    <div class="basemap-option active" data-basemap="satellite">Satellite</div>
    <div class="basemap-option" data-basemap="streets">Streets</div>
    <div class="basemap-option" data-basemap="hybrid">Hybrid</div>
    <div class="basemap-option" data-basemap="terrain">Terrain</div>
    <div class="basemap-option" data-basemap="dark-gray">Dark Gray</div>
    <div class="basemap-option" data-basemap="topo">Topographic</div>
    <div class="basemap-option" data-basemap="gray">Light Gray</div>
    <div class="basemap-option" data-basemap="oceans">Oceans</div>

    <h3>üìä Data Layers</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
      <span>PM2.5 (OpenAQ Live)</span>
      <label><input type="checkbox" id="layerAQI" checked> Visible</label>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
      <span>World Cities</span>
      <label><input type="checkbox" id="layerCities" checked> Visible</label>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
      <span>Legend</span>
      <label><input type="checkbox" id="layerLegend" checked> Visible</label>
    </div>
  </aside>

  <!-- Map -->
  <div id="viewDiv">
    <div id="loading">Loading map‚Ä¶</div>
  </div>

  <!-- Floating Chat -->
  <section id="chat" aria-live="polite">
    <div id="chatHead">
      <span>AQI Assistant</span>
      <button id="minBtn" class="cbtn" title="Minimize">‚Äì</button>
    </div>
    <div id="chatBody">
      <div id="msgs">
        <div class="bubble bot">Hi! Ask me about air quality (PM2.5/AQI). Try: ‚ÄúTop 5 polluted cities now‚Äù, ‚ÄúWhat‚Äôs PM2.5 in Hanoi?‚Äù, or ‚ÄúZoom to Delhi‚Äù.</div>
      </div>
      <div id="composer">
        <input id="q" placeholder="Ask about PM2.5 / AQI‚Ä¶"/>
        <button id="send">Send</button>
      </div>
    </div>
  </section>

  <script>
    /************ MAP + DATA ************/
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend"
    ], function(Map, MapView, FeatureLayer, Legend) {

      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map, center: [0,20], zoom: 3,
        popup: { dockEnabled: true, dockOptions:{ buttonEnabled:false, breakpoint:false, position:"bottom-right" } }
      });

      // Live PM2.5 (OpenAQ latest hour)
      const pm25Layer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
        title: "PM2.5 (OpenAQ, latest hour)",
        outFields: ["*"],
        popupTemplate: {
          title: "{location} ({country_name})",
          content: `
            <div style="line-height:1.5">
              <b>City:</b> {city}<br>
              <b>PM2.5:</b> {value} {unit}<br>
              <b>Provider:</b> {provider_name}<br>
              <b>Updated:</b> {lastUpdated}<br>
              <a href="{url}" target="_blank" rel="noopener">Station link</a>
            </div>`
        },
        renderer: {
          type:"class-breaks", field:"value",
          classBreakInfos:[
            {minValue:0,maxValue:10,   symbol:{type:"simple-marker",size:8,  color:"#00e400", outline:{color:"#fff",width:1}}, label:"Good (0‚Äì10)"},
            {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10, color:"#ffff00", outline:{color:"#fff",width:1}}, label:"Moderate (10‚Äì25)"},
            {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12, color:"#ff7e00", outline:{color:"#fff",width:1}}, label:"USG (25‚Äì50)"},
            {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14, color:"#ff0000", outline:{color:"#fff",width:1}}, label:"Unhealthy (50‚Äì75)"},
            {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16, color:"#8f3f97", outline:{color:"#fff",width:1}}, label:"Very Unhealthy (75‚Äì100)"},
            {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18, color:"#7e0023", outline:{color:"#fff",width:1}}, label:"Hazardous (100+)"}
          ]
        }
      });
      map.add(pm25Layer);

      const citiesLayer = new FeatureLayer({
        url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
        title:"World Cities", definitionExpression:"POP > 100000",
        renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
        labelingInfo:[{
          symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
          labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000
        }],
        popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
      });
      map.add(citiesLayer);

      // Legend + init
      let legendWidget=null;
      view.whenLayerView(pm25Layer).then(()=>{
        legendWidget = new Legend({ view, layerInfos:[{ layer: pm25Layer, title:"PM2.5 Air Quality (¬µg/m¬≥)" }] });
        view.ui.add(legendWidget, "bottom-left");
        document.getElementById("loading").style.display="none";
        updateStatus();
        refreshTopCities();
        setInterval(refreshTopCities, 30*60*1000);
      });

      function updateStatus(){
        pm25Layer.queryFeatureCount().then(c=>{
          document.getElementById("status").textContent = `‚úì Live layer connected (${c.toLocaleString()} stations)`;
        }).catch(()=>{ document.getElementById("status").textContent = "‚ö†Ô∏è Connected, but could not count features."; });
      }

      // Top-10 polluted cities (sane values + ‚â•3 stations)
      async function refreshTopCities(){
        const box = document.getElementById("topCities");
        box.innerHTML = '<div style="opacity:.85">Updating‚Ä¶</div>';
        try{
          const q = pm25Layer.createQuery();
          q.where = "value BETWEEN 0 AND 500 AND city IS NOT NULL AND unit IN ('¬µg/m¬≥','ug/m3')";
          q.groupByFieldsForStatistics = ["city","country_name"];
          q.outStatistics = [
            { statisticType:"avg",   onStatisticField:"value", outStatisticFieldName:"avg_pm25" },
            { statisticType:"count", onStatisticField:"value", outStatisticFieldName:"n_stations" }
          ];
          q.havingClause = "COUNT(value) >= 3";
          q.orderByFields = ["avg_pm25 DESC"];
          q.num = 10; q.returnGeometry = false;

          const res = await pm25Layer.queryFeatures(q);
          if(!res.features.length){ box.innerHTML = '<div style="opacity:.85">No data right now.</div>'; return; }

          const cls = v => v<=10 ? "tag good" : v<=25 ? "tag mod" : "tag bad";
          box.innerHTML = "";
          res.features.forEach(f=>{
            const a = f.attributes, v = a.avg_pm25;
            const row = document.createElement("div");
            row.className = "city-item";
            row.innerHTML = `<span>${a.city}, ${a.country_name}</span><span class="${cls(v)}" title="Avg of ${a.n_stations} stations">${Math.round(v)}</span>`;
            row.addEventListener("click", ()=>zoomToCity(a.city, a.country_name));
            box.appendChild(row);
          });
        }catch(e){ console.error(e); box.innerHTML = '<div style="opacity:.85">Failed to load top cities.</div>'; }
      }

      // Zoom helper (also used by chatbot action)
      async function zoomToCity(city, country){
        const esc=s=>String(s).replace(/'/g,"''");
        const q = pm25Layer.createQuery();
        q.where = `city='${esc(city)}' AND country_name='${esc(country)}' AND value BETWEEN 0 AND 500`;
        q.outFields = ["*"]; q.returnGeometry = true; q.num = 1;
        const res = await pm25Layer.queryFeatures(q);
        if(res.features.length){
          const g = res.features[0].geometry;
          view.goTo({ center:g, zoom:11 }, { duration:1500 });
        }
      }
      window.zoomToCity = zoomToCity;

      /* UI wiring */
      function togglePanel(id, cls){
        const panel = document.getElementById(id);
        const viewDiv = document.getElementById("viewDiv");
        const isOpen = panel.classList.toggle("open");
        viewDiv.classList.toggle(cls, isOpen);
        if(id==="sidebar"){ document.getElementById("settingsPanel").classList.remove("open"); viewDiv.classList.remove("settings-open");}
        else { document.getElementById("sidebar").classList.remove("open"); viewDiv.classList.remove("sidebar-open");}
        setTimeout(()=>view.resize(),250);
      }
      document.getElementById("hamburgerBtn").addEventListener("click", ()=>togglePanel("sidebar","sidebar-open"));
      document.getElementById("settingsBtn").addEventListener("click", ()=>togglePanel("settingsPanel","settings-open"));

      document.querySelectorAll(".basemap-option").forEach(opt=>{
        opt.addEventListener("click", function(){
          map.basemap = this.dataset.basemap;
          document.querySelectorAll(".basemap-option").forEach(o=>o.classList.remove("active"));
          this.classList.add("active");
        });
      });

      document.getElementById("layerAQI").addEventListener("change", e=> pm25Layer.visible = e.target.checked);
      document.getElementById("layerCities").addEventListener("change", e=> citiesLayer.visible = e.target.checked);
      document.getElementById("layerLegend").addEventListener("change", e=> { if(legendWidget) legendWidget.visible = e.target.checked; });

      // Simple search
      function performSearch(){
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        if(!q) return;
        const cities = {
          'beijing':[116.4074,39.9042,12], 'delhi':[77.2090,28.6139,12], 'new york':[-74.0060,40.7128,11],
          'london':[-0.1278,51.5074,11], 'tokyo':[139.6503,35.6762,11], 'mumbai':[72.8777,19.0760,12],
          'lahore':[74.3587,31.5204,12], 'dhaka':[90.4125,23.8103,12], 'shanghai':[121.4737,31.2304,11],
          'paris':[2.3522,48.8566,11], 'los angeles':[-118.2437,34.0522,10], 'cairo':[31.2357,30.0444,11],
          'bangkok':[100.5018,13.7563,11], 'jakarta':[106.8456,-6.2088,11], 'seoul':[126.9780,37.5665,11],
          'mexico city':[-99.1332,19.4326,11], 'singapore':[103.8198,1.3521,12], 'sydney':[151.2093,-33.8688,10],
          'dubai':[55.2708,25.2048,11]
        };
        const p = cities[q];
        if(p) view.goTo({ center:[p[0],p[1]], zoom:p[2] }, { duration:1500 });
        else alert("City not in quick list. Try: Beijing, Delhi, New York, London, Tokyo‚Ä¶");
      }
      document.getElementById("searchBtn").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", e=>{ if(e.key==="Enter") performSearch(); });

      document.addEventListener("keydown", e=>{
        if(e.key==="Escape"){
          document.getElementById("sidebar").classList.remove("open");
          document.getElementById("settingsPanel").classList.remove("open");
          document.getElementById("viewDiv").classList.remove("sidebar-open","settings-open");
          view.resize();
        }
      });
    });

    /************ CHATBOT (drag + minimize + history + server call) ************/
    (function(){
      const chat = document.getElementById("chat");
      const head = document.getElementById("chatHead");
      const body = document.getElementById("chatBody");
      const minBtn = document.getElementById("minBtn");
      const msgs = document.getElementById("msgs");
      const q = document.getElementById("q");
      const send = document.getElementById("send");
      const chatHistory = []; // {role:'user'|'assistant', content:string}

      // Drag
      let drag=false, offX=0, offY=0;
      head.addEventListener("mousedown", (e)=>{
        if(e.target===minBtn) return;
        drag=true;
        const r=chat.getBoundingClientRect();
        offX = e.clientX - r.left; offY = e.clientY - r.top;
        chat.style.right="auto"; chat.style.bottom="auto";
      });
      window.addEventListener("mousemove", (e)=>{
        if(!drag) return;
        chat.style.left = (e.clientX - offX) + "px";
        chat.style.top  = (e.clientY - offY) + "px";
      });
      window.addEventListener("mouseup", ()=>drag=false);

      // Minimize to small bar with title
      minBtn.addEventListener("click", ()=>{
        const isOpen = body.style.display !== "none";
        body.style.display = isOpen ? "none" : "flex";
        minBtn.textContent = isOpen ? "+" : "‚Äì";
      });

      function addBubble(text, who="bot"){
        const d=document.createElement("div");
        d.className=`bubble ${who}`; d.innerHTML=text;
        msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
      }

      async function sendMsg(){
        const text = q.value.trim(); if(!text) return;
        addBubble(text,"me"); q.value="";
        const thinking = document.createElement("div");
        thinking.className="bubble bot"; thinking.textContent="Thinking‚Ä¶";
        msgs.appendChild(thinking); msgs.scrollTop = msgs.scrollHeight;

        // keep short history (last 8 turns)
        chatHistory.push({ role:"user", content:text });

        try{
          const resp = await fetch("/.netlify/functions/AQI-Chat", {
            method:"POST",
            headers:{ "Content-Type":"application/json", "Cache-Control":"no-store" },
            cache:"no-store",
            body: JSON.stringify({ userMessage: text, history: chatHistory.slice(-8) })
          });
          const data = await resp.json();
          const reply = data.reply || "Sorry, I couldn't respond.";
          thinking.innerHTML = reply;
          chatHistory.push({ role:"assistant", content: reply });

          if(data.action && data.action.type==="zoomTo" && data.action.city){
            window.zoomToCity(data.action.city, data.action.country || "");
          }
        }catch(err){
          console.error(err);
          thinking.innerHTML = "Error connecting to server.";
        }
      }
      send.addEventListener("click", sendMsg);
      q.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMsg(); });
    })();
  </script>
</body>
</html>
