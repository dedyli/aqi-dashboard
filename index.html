<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AirLux — Ultra‑Luxury Global Air Quality Intelligence</title>

<link href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

<style>
:root {
  --bg-primary: #05070D;
  --bg-glass: rgba(15, 20, 34, 0.6);
  --ink-primary: #E5ECFF;
  --ink-secondary: #9BA8C3;
  --stroke-primary: rgba(255, 255, 255, 0.12);
  --stroke-secondary: rgba(255, 255, 255, 0.2);
  --accent-cyan: #00F2FE;
  --accent-iris: #7C8CFF;
  --accent-glow: 0 0 14px rgba(0, 242, 254, 0.28), 0 0 24px rgba(0, 242, 254, 0.18);
  --brass: linear-gradient(135deg, #F6E39A, #D4AF37, #B88A2B);
  --brass-ink: #1f1500;
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --shadow-hud: 0 30px 100px rgba(0,0,0,0.55);
}
* { box-sizing: border-box }
html, body { height: 100%; margin: 0; background: var(--bg-primary); color: var(--ink-primary); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; overflow: hidden; }

/* ===== Immersive Stage (Map) ===== */
.stage { position: fixed; inset: 0; }
#viewDiv { position: absolute; inset: 0; }
#loading { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-weight: 600; font-size: 15px; color: var(--ink-secondary); letter-spacing: .4px; text-transform: uppercase; }
#toast { position: absolute; top: 18px; left: 50%; transform: translateX(-50%); z-index: 1002; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--stroke-primary); background:var(--bg-glass); backdrop-filter: blur(20px); display: none; }
#gradientOverlay { pointer-events: none; position: absolute; inset: 0; background: radial-gradient(1400px 700px at 50% 0%, rgba(124,140,255,.12) 0%, rgba(0,0,0,0) 60%), radial-gradient(900px 500px at 100% 20%, rgba(0,242,254,.10) 0%, rgba(0,0,0,0) 60%); }

/* ===== Crown Bar (Header) ===== */
.header { position: fixed; top: 14px; left: 14px; right: 14px; z-index: 1001; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 12px; padding: 10px; border-radius: 20px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); backdrop-filter: blur(24px) saturate(1.5); box-shadow: var(--shadow-hud); }
.brand { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 14px; background: rgba(255,255,255,.04); border: 1px solid var(--stroke-primary); }
.brand-mark { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; font: 700 18px 'Playfair Display', serif; background: var(--brass); color: var(--brass-ink); box-shadow: inset 0 6px 24px rgba(0,0,0,.25); }
.brand-name { font-family: 'Playfair Display', serif; font-size: 20px; letter-spacing: .5px; }

.global-search { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 16px; border: 1px solid var(--stroke-primary); background: rgba(5,7,13,.7); }
.global-search input { flex: 1; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--stroke-primary); background: rgba(255,255,255,.04); color: var(--ink-primary); outline: none; font-size: 16px; font-weight: 500; }
.global-search input::placeholder { color: var(--ink-secondary); }
.global-search button { padding: 0 18px; height: 44px; border-radius: 12px; border: none; background: var(--accent-cyan); color: #000; font-weight: 800; letter-spacing: .5px; cursor: pointer; box-shadow: var(--accent-glow); text-transform: uppercase; }

.header-actions { display: flex; align-items: center; gap: 8px; }
.icon-btn { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--stroke-primary); background: rgba(255,255,255,.04); color: var(--ink-secondary); display: grid; place-items: center; font-size: 18px; cursor: pointer; transition: all .2s ease; }
.icon-btn:hover { background: rgba(255,255,255,.10); color: var(--ink-primary); }
.icon-btn.primary { background: var(--accent-cyan); color: #000; border-color: transparent; box-shadow: var(--accent-glow); }

/* ===== KPI Shelf ===== */
.kpi-shelf { position: fixed; left: 14px; right: 14px; top: 82px; z-index: 1000; display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
.kpi { grid-column: span 3; min-height: 84px; border-radius: 18px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); backdrop-filter: blur(22px) saturate(1.4); box-shadow: var(--shadow-hud); padding: 14px 16px; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; }
.kpi .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent-cyan); box-shadow: var(--accent-glow); }
.kpi .meta { color: var(--ink-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: .7px; }
.kpi .value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; }
.kpi .trend { font-size: 12px; color: var(--ink-secondary); }

/* ===== Layer Pills ===== */
.layer-pills { position: fixed; top: 180px; left: 14px; z-index: 999; display: flex; gap: 8px; flex-wrap: wrap; max-width: 50vw; }
.pill { padding: 8px 14px; border-radius: 999px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; opacity: .85; transition: all 0.2s ease; backdrop-filter: blur(12px); }
.pill:hover { opacity: 1; background: rgba(15, 20, 34, 0.8); }
.pill.active { opacity: 1; border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: var(--accent-glow); }
.pill .dot { display: none; }
.pill.active .dot { display: block; width: 8px; height: 8px; border-radius: 50%; background: var(--accent-cyan);}

/* ===== Insights / Settings Panel (Right) ===== */
.side-panel { position: fixed; inset: 14px 14px 14px auto; width: 420px; max-width: 88vw; z-index: 1001; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 28px; backdrop-filter: blur(28px) saturate(1.8); box-shadow: var(--shadow-hud); padding: 20px; overflow-y: auto; transform: translateX(110%); transition: transform 0.6s var(--ease-out), opacity 0.6s var(--ease-out); opacity: 0; visibility: hidden; }
.side-panel.open { transform: translateX(0); opacity: 1; visibility: visible; }
.panel-section { margin-bottom: 24px; }
.panel-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--stroke-primary); }
.panel-header .icon { font-size: 20px; }
.panel-header .title { font-size: 18px; font-weight: 700; }
.list { display: flex; flex-direction: column; gap: 8px; }
.list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: background .2s ease, border-color .2s ease; border: 1px solid transparent; }
.list-row:hover { background: rgba(255,255,255,0.1); }
.list-row.active { background: rgba(0, 242, 254, 0.1); border-color: var(--accent-cyan); }
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.settings-control { display:flex; flex-direction:column; gap: 8px; color: var(--ink-secondary); }
.settings-control input[type="range"] { width: 100%; }
.preset-buttons { display: flex; gap: 8px; }
.preset-buttons .list-row { flex: 1; justify-content: center; }

/* ===== Assistant Modal ===== */
#chatModal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90vw; max-width: 640px; height: 75vh; max-height: 720px; z-index: 2000; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 28px; backdrop-filter: blur(28px) saturate(1.8); box-shadow: var(--shadow-hud); display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: all 0.4s var(--ease-out); }
#chatModal.open { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
#chatHeader { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--stroke-primary); font-weight: 700; font-size: 18px; }
#closeChat { background: none; border: none; color: var(--ink-secondary); font-size: 24px; cursor: pointer; transition: color .2s ease; }
#closeChat:hover { color: var(--ink-primary); }
#chatMessages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
.message { max-width: 80%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; }
.message.user { align-self: flex-end; background: var(--accent-cyan); color: #000; border-radius: 18px 18px 4px 18px; }
.message.bot { align-self: flex-start; background: rgba(255,255,255,0.08); border-radius: 18px 18px 18px 4px; }
.message.bot.typing { font-style: italic; color: var(--ink-secondary); }
#chatInputArea { padding: 16px; border-top: 1px solid var(--stroke-primary); display: flex; gap: 12px; }
#chatInput { flex: 1; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--stroke-primary); background: rgba(5,7,13,.8); color: var(--ink-primary); font-size: 16px; }
#chatSend { padding: 0 24px; border-radius: 12px; border: none; background: var(--accent-cyan); color: #000; font-weight: 800; letter-spacing: .4px; text-transform: uppercase; cursor: pointer; box-shadow: var(--accent-glow); }

/* ===== Responsive ===== */
@media (max-width: 1280px) {
  .kpi { grid-column: span 4; }
}
@media (max-width: 860px) {
  .kpi { grid-column: span 6; }
  .layer-pills { max-width: unset; right: 14px; }
}
@media (max-width: 640px) {
  .kpi { grid-column: span 12; }
  .header { grid-template-columns: auto 1fr; grid-template-rows: auto auto; }
  .header-actions { grid-column: 1 / -1; justify-content: flex-end; }
}
</style>
</head>
<body>

<main class="stage">
  <div id="viewDiv">
    <div id="gradientOverlay"></div>
    <div id="loading">Initializing Global Intelligence…</div>
    <div id="toast"></div>
  </div>
</main>

<!-- Crown Bar -->
<header class="header" role="banner">
  <div class="brand">
    <div class="brand-mark">AL</div>
    <div class="brand-name">AirLux</div>
  </div>
  <div class="global-search" role="search">
    <input id="searchInput" placeholder="Analyze any city or region — try ‘Jakarta’, ‘Delhi’, or a coordinates pair…"/>
    <button id="searchBtn">Analyze</button>
  </div>
  <div class="header-actions">
    <button class="icon-btn" id="btnLegend" title="Legend">🏷️</button>
    <button class="icon-btn" id="btnSettings" title="Settings">⚙️</button>
    <button class="icon-btn primary" id="btnAssistant" title="AI Assistant">💬</button>
  </div>
</header>

<!-- KPI Shelf -->
<section class="kpi-shelf" aria-label="Key metrics">
  <div class="kpi" title="Live station count">
    <div class="dot"></div>
    <div>
      <div class="meta">Live Stations</div>
      <div class="value" id="kStations">0</div>
    </div>
    <div class="trend" id="kStationsHint">—</div>
  </div>
  <div class="kpi" title="Cities monitored">
    <div class="dot"></div>
    <div>
      <div class="meta">Cities Monitored</div>
      <div class="value" id="kCities">0</div>
    </div>
    <div class="trend" id="kCitiesHint">—</div>
  </div>
  <div class="kpi" title="Active fires globally (24h)">
    <div class="dot"></div>
    <div>
      <div class="meta">Active Fires</div>
      <div class="value" id="kFires">0</div>
    </div>
    <div class="trend" id="kFiresHint">≥ 365K brightness</div>
  </div>
  <div class="kpi" title="Flow simulation status">
    <div class="dot"></div>
    <div>
      <div class="meta">Ocean Flow</div>
      <div class="value" id="kFlow">On</div>
    </div>
    <div class="trend">animated</div>
  </div>
</section>

<!-- Layer Pills -->
<div class="layer-pills">
  <div class="pill" data-layer="aqi" title="PM2.5 Stations (placeholder)"><span class="dot"></span>PM2.5</div>
  <div class="pill" data-layer="gaqi" title="City AQI (placeholder)"><span class="dot"></span>City AQI</div>
  <div class="pill active" data-layer="fire" title="Active Fires"><span class="dot"></span>Fires</div>
  <div class="pill active" data-layer="flow" title="Ocean Flow"><span class="dot"></span>Flow</div>
</div>

<!-- Insights / Settings Panel -->
<aside class="side-panel" id="sidePanel" aria-live="polite"></aside>

<!-- Assistant Modal -->
<div id="chatModal" role="dialog" aria-modal="true" aria-labelledby="chatHeader">
  <div id="chatHeader"><span>AirLux Assistant</span><button id="closeChat" aria-label="Close">×</button></div>
  <div id="chatMessages"><div class="message bot">Ask me about air quality anywhere. Try “What’s the PM2.5 in Delhi?” or “How is the air in Jakarta right now?”.</div></div>
  <div id="chatInputArea"><input id="chatInput" placeholder="Send a message…" autocomplete="off" /><button id="chatSend">Send</button></div>
</div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/GeoJSONLayer",
  "esri/layers/ImageryTileLayer", "esri/renderers/FlowRenderer", "esri/widgets/Legend",
  "esri/rest/locator"
], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryTileLayer, FlowRenderer, Legend, locator) {

  // ===== GLOBALS =====
  let view, map, legendWidget;
  let pm25Layer = null, cityAqiLayer = null, fireLayer = null, flowLayer = null;
  const geocodeUrl = "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";

  // ===== INIT =====
  (function initialize(){
    setupMap();
    setupUI();
  })();

  // ===== MAP SETUP =====
  function setupMap(){
    map = new Map({ basemap: "hybrid" });
    view = new MapView({
      container: "viewDiv",
      map,
      center: [115, -2],
      zoom: 5,
      popup: { dockEnabled: true, dockOptions: { buttonEnabled: false, breakpoint: false, position: "bottom-right" } },
      ui: { components: ["attribution"] }
    });

    // Client-side placeholder layer for PM2.5 stations (keeps UI functional without external APIs)
    pm25Layer = new FeatureLayer({
      title: "PM2.5 Stations",
      source: [], // no features yet
      fields: [
        { name: "ObjectID", type: "oid" },
        { name: "pm25", type: "double" },
        { name: "city", type: "string" }
      ],
      objectIdField: "ObjectID",
      geometryType: "point",
      renderer: {
        type: "simple",
        symbol: { type: "simple-marker", size: 8, color: [0,242,254,0.9], outline: { color: [0,0,0,0.6], width: 0.5 } }
      },
      popupTemplate: { title: "{city}", content: "PM2.5: <b>{pm25}</b> µg/m³" },
      visible: false
    });

    // Client-side placeholder layer for City AQI
    cityAqiLayer = new FeatureLayer({
      title: "City AQI",
      source: [],
      fields: [ { name: "ObjectID", type: "oid" }, { name: "aqi", type: "integer" }, { name: "city", type: "string" } ],
      objectIdField: "ObjectID",
      geometryType: "point",
      renderer: { type: "simple", symbol: { type: "simple-marker", size: 10, color: [124,140,255,0.9], outline: { color: [0,0,0,0.6], width: 0.5 } } },
      popupTemplate: { title: "{city}", content: "City AQI: <b>{aqi}</b>" },
      visible: false
    });

    // Active Fires (VIIRS 24h, brightness threshold filtered later)
    fireLayer = new FeatureLayer({
      url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
      definitionExpression: "ACQ_DATE >= CURRENT_DATE - 1 AND (BRIGHT_TI4 >= 365)",
      title: "Active Fires"
    });

    // Ocean Currents (FlowRenderer)
    flowLayer = new ImageryTileLayer({
      url: "https://tiledimageservices.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Spilhaus_UV_ocean_currents/ImageServer",
      title: "Ocean Flow",
      renderer: new FlowRenderer({ density: 0.7, flowSpeed: 6, trailLength: 120, trailWidth: "2px" })
    });

    map.addMany([pm25Layer, cityAqiLayer, fireLayer, flowLayer]);

    view.when(() => {
      document.getElementById("loading").style.display = "none";
      setupLegend();
      updateCounters();
      showToast("Welcome to AirLux — Ultra‑Luxury mode activated ✨", 2200);
    });
  }

  function setupLegend(){
    legendWidget = new Legend({ view });
    view.ui.add(legendWidget, "bottom-left");
    // Hidden by default until user toggles it
    legendWidget.container.parentElement.style.display = 'none';
  }

  // ===== UI & INTERACTIONS =====
  function setupUI(){
    // Search
    document.getElementById("searchBtn").addEventListener("click", locateByText);
    document.getElementById("searchInput").addEventListener("keydown", e => { if (e.key === "Enter") locateByText(); });

    // Header actions
    document.getElementById('btnSettings').addEventListener('click', () => showSettingsPanel());
    document.getElementById('btnLegend').addEventListener('click', () => toggleLegend());
    document.getElementById('btnAssistant').addEventListener('click', () => openChat());

    // Layer pills
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        p.classList.toggle('active');
        const key = p.dataset.layer;
        const layer = ({ aqi: pm25Layer, gaqi: cityAqiLayer, fire: fireLayer, flow: flowLayer })[key];
        if (layer) layer.visible = p.classList.contains('active');
        updateCounters();
      });
    });

    // Keyboard: ESC closes panels/modals
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){ closePanel(); closeChat(); }
    });
  }

  function toggleLegend(){
    const cont = legendWidget.container.parentElement;
    const isHidden = getComputedStyle(cont).display === 'none';
    cont.style.display = isHidden ? 'block' : 'none';
    showToast(isHidden ? 'Legend shown' : 'Legend hidden');
  }

  // ===== Panels =====
  function showSettingsPanel(){
    const panel = document.getElementById('sidePanel');
    panel.innerHTML = `
      <section class="panel-section">
        <div class="panel-header"><div class="icon">🗺️</div><div class="title">Map Visualization</div></div>
        <div class="settings-grid">
          <div class="list-row basemap-option" data-basemap="hybrid">Hybrid</div>
          <div class="list-row basemap-option" data-basemap="satellite">Satellite</div>
          <div class="list-row basemap-option" data-basemap="streets-vector">Streets</div>
          <div class="list-row basemap-option" data-basemap="dark-gray-vector">Dark</div>
        </div>
      </section>
      <section class="panel-section">
        <div class="panel-header"><div class="icon">🔥</div><div class="title">Fire Intensity Filter</div></div>
        <div class="settings-control">
          <label>Minimum Brightness (K): <b id="brightnessValue">365</b></label>
          <input type="range" id="brightnessSlider" min="365" max="500" value="365" step="5">
        </div>
      </section>
      <section class="panel-section">
        <div class="panel-header"><div class="icon">🌊</div><div class="title">Flow Animation</div></div>
        <div class="settings-control">
          <label>Speed: <b id="speedValue">${flowLayer.renderer.flowSpeed}</b></label>
          <input type="range" id="windSpeed" min="1" max="20" value="${flowLayer.renderer.flowSpeed}">
          <label>Density: <b id="densityValue">${flowLayer.renderer.density}</b></label>
          <input type="range" id="windDensity" min="0.1" max="1" step="0.1" value="${flowLayer.renderer.density}">
          <div class="preset-buttons">
            <button class="list-row preset-btn" data-p="subtle">Subtle</button>
            <button class="list-row preset-btn active" data-p="normal">Normal</button>
            <button class="list-row preset-btn" data-p="intense">Intense</button>
          </div>
        </div>
      </section>
      <section class="panel-section">
        <div class="panel-header"><div class="icon">🧠</div><div class="title">Insights</div></div>
        <div class="list">
          <div class="list-row">Legend: <span style="opacity:.8">Use the 🏷️ button to toggle</span></div>
          <div class="list-row">Click on the map to explore features</div>
        </div>
      </section>`;

    panel.classList.add('open');

    // Basemap selection
    panel.querySelectorAll('.basemap-option').forEach(el => {
      if (map.basemap && map.basemap.id === el.dataset.basemap) el.classList.add('active');
      el.addEventListener('click', () => {
        panel.querySelectorAll('.basemap-option').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        map.basemap = el.dataset.basemap;
      });
    });

    // Fire slider
    const brightSlider = document.getElementById("brightnessSlider");
    brightSlider.addEventListener("input", () => {
      document.getElementById("brightnessValue").textContent = brightSlider.value;
      fireLayer.definitionExpression = `ACQ_DATE >= CURRENT_DATE - 1 AND (BRIGHT_TI4 >= ${brightSlider.value})`;
      updateCounters();
    });

    // Flow controls
    const applyFlow = () => {
      const s = Number(document.getElementById("windSpeed").value);
      const d = Number(document.getElementById("windDensity").value);
      document.getElementById("speedValue").textContent = s;
      document.getElementById("densityValue").textContent = d;
      const r = flowLayer.renderer.clone(); r.flowSpeed = s; r.density = d; flowLayer.renderer = r;
    };
    document.getElementById("windSpeed").addEventListener("input", applyFlow);
    document.getElementById("windDensity").addEventListener("input", applyFlow);
    panel.querySelectorAll(".preset-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const preset = btn.dataset.p; let speed, density;
        if (preset === 'subtle') { speed = 3; density = 0.4; }
        else if (preset === 'intense') { speed = 12; density = 0.9; }
        else { speed = 6; density = 0.7; }
        panel.querySelector("#windSpeed").value = speed;
        panel.querySelector("#windDensity").value = density;
        panel.querySelectorAll(".preset-btn").forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        applyFlow();
      });
    });
  }

  function closePanel(){ document.getElementById('sidePanel').classList.remove('open'); }

  // ===== Search / Geocode =====
  async function locateByText(){
    const q = document.getElementById("searchInput").value.trim();
    if(!q) return showToast("Type a city or coordinates");
    try{
      const res = await locator.addressToLocations(geocodeUrl, { address: { SingleLine: q }, maxLocations: 5 });
      if (!res || !res.length) return showToast('No results');
      const loc = res[0].location;
      await view.goTo({ center: loc, zoom: 9 }, { duration: 800, easing: 'ease' });
      showToast(`Centered on ${res[0].attributes.LongLabel || q}`);
    } catch(err){
      console.error(err); showToast('Search failed');
    }
  }

  // ===== Counters =====
  async function updateCounters(){
    try {
      // pm25 & city aqi are client-side placeholders
      document.getElementById('kStations').textContent = pm25Layer.visible ? (pm25Layer.source ? pm25Layer.source.length : 0) : 0;
      document.getElementById('kCities').textContent = cityAqiLayer.visible ? (cityAqiLayer.source ? cityAqiLayer.source.length : 0) : 0;
      // fires
      const fireCount = await fireLayer.queryFeatureCount({ where: fireLayer.definitionExpression || '1=1' });
      document.getElementById('kFires').textContent = fireLayer.visible ? fireCount.toLocaleString() : 0;
      document.getElementById('kFlow').textContent = flowLayer.visible ? 'On' : 'Off';
    } catch(e){ console.warn('Counter update failed', e); }
  }

  // ===== Assistant (UI only placeholder) =====
  function openChat(){
    const modal = document.getElementById('chatModal'); modal.classList.add('open');
  }
  function closeChat(){ document.getElementById('chatModal').classList.remove('open'); }
  document.getElementById('closeChat').addEventListener('click', closeChat);
  document.getElementById('chatSend').addEventListener('click', sendMessage);
  document.getElementById('chatInput').addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

  function addMessageToChat(content, role){
    const wrap = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = `message ${role}`; div.textContent = content; wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
  }
  async function sendMessage(){
    const input = document.getElementById('chatInput');
    const text = input.value.trim(); if(!text) return; input.value='';
    addMessageToChat(text, 'user');
    const typing = document.createElement('div'); typing.className='message bot typing'; typing.textContent='Thinking…'; document.getElementById('chatMessages').appendChild(typing);
    // placeholder response
    await new Promise(r=>setTimeout(r, 600));
    typing.remove();
    addMessageToChat("I’m your on‑board copilot. The premium AI endpoint isn’t connected yet in this build, but I can be wired to OpenAI/OpenRouter or your serverless function in minutes.", 'bot');
  }

  // ===== Utilities =====
  function showToast(msg, ms = 2000){
    const el = document.getElementById('toast'); el.textContent = msg; el.style.display = 'block';
    clearTimeout(showToast._t); showToast._t = setTimeout(()=> el.style.display='none', ms);
  }

});
</script>

</body>
</html>
