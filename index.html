<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Global AQI Dashboard - Tsinghua University</title>
<link href="https://js.arcgis.com/4.29/esri/themes/light/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;overflow:hidden}
    .header{background:linear-gradient(135deg,#8B2B8B 0%,#2D2D2D 100%);height:70px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1001;position:relative}
    .header-left{display:flex;align-items:center;gap:14px}
    .hamburger,.settings{background:rgba(255,255,255,.22);border:0;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .2s}
    .hamburger:hover,.settings:hover{background:rgba(255,255,255,.32)}
    .header h1{font-size:16px;font-weight:700}
    .header h2{font-size:13px;opacity:.9;font-style:italic;font-weight:400}

    #viewDiv{position:absolute;top:70px;left:0;right:0;bottom:0;transition:.25s}
    #viewDiv.sidebar-open{left:320px}
    #viewDiv.settings-open{right:320px}

    .sidebar,.settings-panel{position:fixed;top:70px;width:320px;height:calc(100vh - 70px);background:linear-gradient(180deg,#8B2B8B 0%,#4A4A4A 100%);color:#fff;padding:18px;z-index:1000;overflow:auto;transition:.25s}
    .sidebar{left:-320px}.sidebar.open{left:0;box-shadow:2px 0 12px rgba(0,0,0,.35)}
    .settings-panel{right:-320px}.settings-panel.open{right:0;box-shadow:-2px 0 12px rgba(0,0,0,.35)}
    h3{border-bottom:1px solid rgba(255,255,255,.3);padding-bottom:8px;margin:14px 0 10px;font-size:15px}

    .search-input{width:100%;padding:12px;border:0;border-radius:8px;background:rgba(255,255,255,.16);color:#fff;margin:6px 0 10px}
    .search-btn{width:100%;padding:12px;background:#0079c1;border:0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}

    .city-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer}
    .city-item:hover{background:rgba(255,255,255,.06)}
    .tag{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag.good{background:#00e400}.tag.mod{background:#ffff00;color:#000}.tag.bad{background:#ff4444}

    .esri-legend{background:rgba(255,255,255,.92)!important;border-radius:10px!important;box-shadow:0 8px 18px rgba(0,0,0,.25)!important}

    .basemap-option{background:rgba(255,255,255,.12);padding:10px 12px;margin:8px 0;border-radius:8px;cursor:pointer;user-select:none;transition:transform .1s, background .2s, box-shadow .2s}
    .basemap-option:hover{background:rgba(255,255,255,.22);transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .basemap-option.active{background:#0079c1;box-shadow:0 4px 12px rgba(0,0,0,.35);font-weight:700}

    #loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#8B2B8B}
    #overlayStatus{position:absolute;top:78px;right:12px;z-index:1002;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;display:none}

    /* Mascot and Chat Bubble Styles */
    #mascotContainer {
        position: fixed;
        z-index: 2000;
        left: calc(100% - 120px);
        top: calc(100% - 140px);
        user-select: none;
    }

    #mascotBtn {
        background: transparent;
        border: none;
        padding: 0;
        cursor: move;
        display: block;
        transition: transform 0.2s;
    }

    #mascotBtn:hover {
        transform: scale(1.05);
    }

    #mascotBtn.dragging {
        cursor: grabbing;
        transform: scale(1.1);
    }

    #mascotBtn img {
        width: 84px;
        height: 84px;
        display: block;
        filter: drop-shadow(0 3px 8px rgba(0,0,0,.35));
    }

    /* Chat Bubble */
    #chatBubble {
        position: absolute;
        display: none;
        width: 380px;
        height: 480px;
        background: linear-gradient(135deg, #11141cee, #1a1d26ee);
        border: 1px solid rgba(255,255,255,.2);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,.5);
        overflow: hidden;
    }

    #chatBubble.open {
        display: block;
    }

    /* Bubble arrow/tail */
    #chatBubble::after {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border: 12px solid transparent;
    }

    /* Position bubble to the left of mascot */
    #chatBubble.left {
        right: 100px;
        top: -200px;
    }

    #chatBubble.left::after {
        right: -24px;
        top: 210px;
        border-left-color: #11141cee;
    }

    /* Position bubble to the right of mascot */
    #chatBubble.right {
        left: 100px;
        top: -200px;
    }

    #chatBubble.right::after {
        left: -24px;
        top: 210px;
        border-right-color: #11141cee;
    }

    /* Chat Interface Inside Bubble */
    #chatInterface {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    #chatHeader {
        background: linear-gradient(135deg, #9a3bb8, #612aa1);
        color: white;
        padding: 12px 16px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 16px 16px 0 0;
    }

    #closeChat {
        background: transparent;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    #closeChat:hover {
        background: rgba(255,255,255,0.2);
    }

    #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(0,0,0,0.2);
    }

    .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
    }

    .message.user {
        align-self: flex-end;
        background: #2a2d36;
        color: white;
    }

    .message.bot {
        align-self: flex-start;
        background: linear-gradient(135deg, #f2ecf4, #e8e0eb);
        color: #111;
    }

    #chatInputArea {
        display: flex;
        padding: 12px;
        background: rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    #chatInput {
        flex: 1;
        padding: 10px 14px;
        border: none;
        background: rgba(255,255,255,0.1);
        color: white;
        border-radius: 8px 0 0 8px;
        font-size: 14px;
    }

    #chatInput::placeholder {
        color: rgba(255,255,255,0.5);
    }

    #chatSend {
        padding: 10px 20px;
        border: none;
        background: #0079c1;
        color: white;
        font-weight: 600;
        cursor: pointer;
        border-radius: 0 8px 8px 0;
        transition: background 0.2s;
    }

    #chatSend:hover:not(:disabled) {
        background: #005a91;
    }

    #chatSend:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Scrollbar styling */
    #chatMessages::-webkit-scrollbar {
        width: 6px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
</style>
</head>
<body>
<div class="header">
<div class="header-left">
<button class="hamburger" id="hamburgerBtn">‚ò∞</button>
<div>
<h1>Group 62 IEDE Research Topic</h1>
<h2>AI-Driven Environmental Monitoring for a Green Economy</h2>
</div>
</div>
<button class="settings" id="settingsBtn">‚öôÔ∏è Settings</button>
</div>
<aside class="sidebar" id="sidebar">
<div class="search">
<h3>üîç Location Search</h3>
<input class="search-input" id="searchInput" placeholder="Enter city name‚Ä¶"/>
<button class="search-btn" id="searchBtn">Search Location</button>
</div>
<h3>üè≠ Most Polluted Cities (Live)</h3>
<div id="topCities"><div style="opacity:.85">Loading‚Ä¶</div></div>
<h3>üåè Google AQI Cities</h3>
<div id="googleAqiList"><div style="opacity:.85">Loading data...</div></div>
<h3>üìà Notes</h3>
<div style="opacity:.9;font-size:13px">
      ‚Ä¢ Live stations: OpenAQ via Esri Living Atlas<br/>
      ‚Ä¢ World cities: Major cities worldwide<br/>
      ‚Ä¢ Regional AQI: Google Air Quality API<br/>
      ‚Ä¢ Wind data: NOAA METAR weather stations<br/>
      ‚Ä¢ Fire data: NASA VIIRS thermal hotspots (24hr)
    </div>
<h3>‚ÑπÔ∏è Status</h3>
<div id="status" style="opacity:.9;font-size:13px"></div>
</aside>
<aside class="settings-panel" id="settingsPanel">
<h3>üó∫Ô∏è Map Style</h3>
<div class="basemap-option active" data-basemap="satellite">Satellite</div>
<div class="basemap-option" data-basemap="streets">Streets</div>
<div class="basemap-option" data-basemap="hybrid">Hybrid</div>
<div class="basemap-option" data-basemap="terrain">Terrain</div>
<div class="basemap-option" data-basemap="dark-gray">Dark Gray</div>
<div class="basemap-option" data-basemap="topo">Topographic</div>
<div class="basemap-option" data-basemap="gray">Light Gray</div>
<div class="basemap-option" data-basemap="oceans">Oceans</div>
<h3>üìä Data Layers</h3>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>PM2.5 Stations (OpenAQ)</span>
<label><input checked="" id="layerAQI" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Cities (Google AQI)</span>
<label><input checked="" id="layerGoogleAQI" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Weather & Wind Stations</span>
<label><input checked="" id="layerWind" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Active Fire Hotspots</span>
<label><input checked="" id="layerFire" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>World Cities</span>
<label><input checked="" id="layerCities" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Legend</span>
<label><input checked="" id="layerLegend" type="checkbox"/> Visible</label>
</div>
</aside>
<div id="viewDiv">
<div id="loading">Loading map‚Ä¶</div>
<div id="overlayStatus"></div>
</div>

<!-- Mascot Container -->
<div id="mascotContainer">
    <button id="mascotBtn" title="Click to chat with AQI Assistant">
        <img src="./mascot.png" alt="AQI Warrior mascot" />
    </button>
    <div id="chatBubble" class="left">
        <div id="chatInterface">
            <div id="chatHeader">
                <span>üåç AQI Assistant</span>
                <button id="closeChat" title="Close chat">√ó</button>
            </div>
            <div id="chatMessages">
                <div class="message bot">Hi! I'm your AQI Assistant. Ask me about air quality anywhere in the world. Try: "What's the PM2.5 in Beijing?" or "Show me the most polluted cities."</div>
            </div>
            <div id="chatInputArea">
                <input id="chatInput" type="text" placeholder="Ask about air quality..." />
                <button id="chatSend">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Map initialization
    require([
      "esri/Map","esri/views/MapView",
      "esri/layers/FeatureLayer","esri/layers/GeoJSONLayer",
      "esri/layers/ImageryLayer","esri/layers/MapImageLayer",
      "esri/widgets/Legend","esri/config"
    ], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryLayer, MapImageLayer, Legend, esriConfig) {

      let googleAqiLayer = null;
      let googleAqiData = null;
      let windLayer = null;
      let fireLayer = null;
      
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map, center: [105, 35], zoom: 4,
        popup: { dockEnabled: true, dockOptions:{ buttonEnabled: false, breakpoint: false, position: "bottom-right" } }
      });

      try { esriConfig.request.corsEnabledServers.push(window.location.origin); } catch(e) {}

      const toast = (msg, ms = 2200) => {
        const el = document.getElementById("overlayStatus");
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(el._t);
        el._t = setTimeout(() => el.style.display = "none", ms);
      };

      function createGoogleAqiLayer(geoJsonData) {
        const blob = new Blob([JSON.stringify(geoJsonData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        return new GeoJSONLayer({
          url: url,
          title: "Cities (Google AQI)",
          copyright: "¬© Google Air Quality API - Live Data",
          renderer: {
            type: "class-breaks",
            field: "aqi",
            classBreakInfos: [
              { minValue: 0, maxValue: 50, symbol: { type: "simple-marker", style: "triangle", size: 12, color: "#00e400", outline: { color: "#fff", width: 1.5 } }, label: "Good (0‚Äì50)" },
              { minValue: 51, maxValue: 100, symbol: { type: "simple-marker", style: "triangle", size: 14, color: "#ffff00", outline: { color: "#fff", width: 1.5 } }, label: "Moderate (51‚Äì100)" },
              { minValue: 101, maxValue: 150, symbol: { type: "simple-marker", style: "triangle", size: 16, color: "#ff7e00", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy for Sensitive (101‚Äì150)" },
              { minValue: 151, maxValue: 200, symbol: { type: "simple-marker", style: "triangle", size: 18, color: "#ff0000", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy (151‚Äì200)" },
              { minValue: 201, maxValue: 300, symbol: { type: "simple-marker", style: "triangle", size: 20, color: "#8f3f97", outline: { color: "#fff", width: 1.5 } }, label: "Very Unhealthy (201‚Äì300)" },
              { minValue: 301, maxValue: 9999, symbol: { type: "simple-marker", style: "triangle", size: 22, color: "#7e0023", outline: { color: "#fff", width: 1.5 } }, label: "Hazardous (300+)" }
            ]
          },
          popupTemplate: {
            title: "{name} - Google AQI",
            content: `<div style="line-height:1.5">
              <b>üå¨Ô∏è US AQI:</b> <span style="font-size:18px;font-weight:bold;">{aqi}</span><br>
              <b>üìä Category:</b> {category}<br>
              <b>üí® Dominant Pollutant:</b> {main_pollutant}<br>
              <b>üïí Last Updated:</b> {time}<br>
              <b>üìç Location:</b> {name}<br>
              <b>üìä Data Source:</b> {source}
            </div>`
          }
        });
      }

      async function loadGoogleAqiData() {
        try {
          toast("Loading Google AQI data...", 3000);
          const response = await fetch('/.netlify/functions/google-aqi');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          googleAqiData = await response.json();

          if (googleAqiData.warning) console.warn("API Warning:", googleAqiData.warning);

          googleAqiLayer = createGoogleAqiLayer(googleAqiData);
          map.add(googleAqiLayer, 1);

          await googleAqiLayer.load();
          toast("‚úÖ Google AQI data loaded!");
          updateStatus();
          updateLegend();
          updateGoogleAqiList(googleAqiData);
        } catch (error) {
          console.error("Failed to load Google AQI data:", error);
          toast("‚ùå Failed to load Google AQI data");
          document.getElementById("googleAqiList").innerHTML = `<div style="opacity:.85; color: #ffdddd;">Failed to load.</div>`;
          updateStatus();
        }
      }
      
      function updateGoogleAqiList(geoJsonData) {
          const listElement = document.getElementById("googleAqiList");
          if (!geoJsonData || !geoJsonData.features || geoJsonData.features.length === 0) {
              listElement.innerHTML = '<div style="opacity:.85">No data available</div>';
              return;
          }
          const cities = geoJsonData.features.map(f => f.properties).sort((a, b) => b.aqi - a.aqi);
          const getAqiClass = (aqi) => {
              if (aqi <= 50) return "tag good";
              if (aqi <= 100) return "tag mod";
              return "tag bad";
          };
          listElement.innerHTML = "";
          cities.forEach(city => {
              const row = document.createElement("div");
              row.className = "city-item";
              row.innerHTML = `<span>${city.name}</span><span class="${getAqiClass(city.aqi)}">${city.aqi}</span>`;
              row.addEventListener("click", () => {
                  const feature = geoJsonData.features.find(f => f.properties.name === city.name);
                  if (feature) {
                      view.goTo({ center: feature.geometry.coordinates, zoom: 11 }, { duration: 1500 });
                  }
              });
              listElement.appendChild(row);
          });
      }

      const pm25Layer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
        title:"PM2.5 Stations (OpenAQ)", outFields:["*"],
        popupTemplate:{ title:"{location} ({country_name})", content:`<div style="line-height:1.5">
          <b>City:</b> {city}<br><b>PM2.5:</b> {value} {unit}<br><b>Provider:</b> {provider_name}<br>
          <b>Updated:</b> {lastUpdated}<br><a href="{url}" target="_blank" rel="noopener">Station link</a></div>` },
        renderer:{ type:"class-breaks", field:"value", classBreakInfos:[
          {minValue:0,maxValue:10,symbol:{type:"simple-marker",size:8,color:"#00e400",outline:{color:"#fff",width:1}},label:"Good (0‚Äì10)"},
          {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10,color:"#ffff00",outline:{color:"#fff",width:1}},label:"Moderate (10‚Äì25)"},
          {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12,color:"#ff7e00",outline:{color:"#fff",width:1}},label:"USG (25‚Äì50)"},
          {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14,color:"#ff0000",outline:{color:"#fff",width:1}},label:"Unhealthy (50‚Äì75)"},
          {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16,color:"#8f3f97",outline:{color:"#fff",width:1}},label:"Very Unhealthy (75‚Äì100)"},
          {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18,color:"#7e0023",outline:{color:"#fff",width:1}},label:"Hazardous (100+)"}
        ]}
      });
      map.add(pm25Layer);

      const citiesLayer = new FeatureLayer({
        url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
        title:"World Cities", definitionExpression:"POP > 100000",
        renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
        labelingInfo:[{ symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
          labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000 }],
        popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
      });
      map.add(citiesLayer);

      // Add Wind Layer from Living Atlas - Updated working URL
      windLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/NOAA_METAR_current_wind_speed_direction/FeatureServer/0",
        title: "Current Weather and Wind Stations",
        opacity: 0.8,
        visible: true,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            style: "triangle",
            size: 8,
            color: [0, 150, 255, 0.8],
            outline: {
              color: "white",
              width: 1
            }
          },
          visualVariables: [{
            type: "rotation",
            field: "WIND_DIRECT",
            rotationType: "geographic"
          }, {
            type: "size",
            field: "WIND_SPEED",
            minDataValue: 0,
            maxDataValue: 50,
            minSize: 6,
            maxSize: 20
          }]
        },
        popupTemplate: {
          title: "Weather Station: {STATION_NAME}",
          content: `<div style="line-height:1.5">
            <b>üå¨Ô∏è Wind Speed:</b> {WIND_SPEED} mph<br>
            <b>üß≠ Wind Direction:</b> {WIND_DIRECT}¬∞<br>
            <b>üå°Ô∏è Temperature:</b> {TEMP} ¬∞F<br>
            <b>üíß Humidity:</b> {R_HUMIDITY}%<br>
            <b>üìç Location:</b> {STATION_NAME}<br>
            <b>üïí Observation Time:</b> {DATE_TIME}
          </div>`
        }
      });
      map.add(windLayer, 2);

      // Add Fire Layer from NASA FIRMS - Direct WMS service
      fireLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
        title: "Active Fires & Thermal Hotspots (VIIRS)",
        opacity: 0.9,
        visible: true,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            style: "circle",
            size: 8,
            color: [255, 69, 0, 0.8],
            outline: {
              color: "yellow",
              width: 1
            }
          }
        },
        popupTemplate: {
          title: "üî• Active Fire Detection",
          content: `<div style="line-height:1.5">
            <b>üî• Fire Brightness:</b> {BRIGHT_TI4} K<br>
            <b>üìÖ Detection Date:</b> {ACQ_DATE}<br>
            <b>üïê Detection Time:</b> {ACQ_TIME}<br>
            <b>üõ∞Ô∏è Satellite:</b> {SATELLITE}<br>
            <b>üîç Confidence:</b> {CONFIDENCE}<br>
            <b>üìç Coordinates:</b> {LATITUDE}, {LONGITUDE}<br>
            <b>üìä Data Source:</b> NASA VIIRS
          </div>`
        },
        definitionExpression: "ACQ_DATE >= CURRENT_DATE - 1" // Show only fires from last 24 hours
      });
      map.add(fireLayer, 3);

      let legendWidget = null;
      function updateLegend() {
        if (!legendWidget) return;
        const layerInfos = [];
        if (pm25Layer && pm25Layer.visible) {
            layerInfos.push({ layer: pm25Layer, title: "PM2.5 (Œºg/m¬≥) ‚Äî Live Stations" });
        }
        if (googleAqiLayer && googleAqiLayer.visible) {
            layerInfos.push({ layer: googleAqiLayer, title: "Cities (Google AQI)" });
        }
        if (fireLayer && fireLayer.visible) {
            layerInfos.push({ layer: fireLayer, title: "Active Fires & Thermal Hotspots (VIIRS)" });
        }
        if (windLayer && windLayer.visible) {
            layerInfos.push({ layer: windLayer, title: "Current Weather & Wind Stations" });
        }
        legendWidget.layerInfos = layerInfos;
      }

      view.whenLayerView(pm25Layer).then(() => {
        legendWidget = new Legend({ view, layerInfos:[] });
        view.ui.add(legendWidget, "bottom-left");
        document.getElementById("loading").style.display = "none";
        
        loadGoogleAqiData();
        updateStatus();
        updateLegend();
        refreshTopCities();
        setInterval(refreshTopCities, 30 * 60 * 1000);
      });

      function updateStatus() {
        const statusParts = [];
        pm25Layer.queryFeatureCount().then(c => {
            statusParts.push(`‚úì PM2.5 stations connected (${c.toLocaleString()})`);
            if (googleAqiLayer && googleAqiLayer.loaded) {
                const count = googleAqiData ? googleAqiData.features.length : 0;
                statusParts.push(`‚úì Google AQI active (${count} cities)`);
            } else if (googleAqiLayer) {
                statusParts.push(`... Google AQI loading...`);
            } else {
                 statusParts.push(`‚ùå Google AQI failed to load.`);
            }
            document.getElementById("status").innerHTML = statusParts.join('<br>');
        }).catch(() => {
            document.getElementById("status").textContent = "‚ö†Ô∏è Could not connect to all data sources.";
        });
      }

      async function refreshTopCities(){
        const box=document.getElementById("topCities"); box.innerHTML='<div style="opacity:.85">Updating‚Ä¶</div>';
        try{
          const q=pm25Layer.createQuery();
          q.where="value BETWEEN 0 AND 500 AND city IS NOT NULL AND unit IN ('¬µg/m¬≥','ug/m3')";
          q.groupByFieldsForStatistics=["city","country_name"];
          q.outStatistics=[
            {statisticType:"avg",onStatisticField:"value",outStatisticFieldName:"avg_pm25"},
            {statisticType:"count",onStatisticField:"value",outStatisticFieldName:"n_stations"}
          ];
          q.havingClause="COUNT(value) >= 3"; q.orderByFields=["avg_pm25 DESC"]; q.num=10; q.returnGeometry=false;
          const res=await pm25Layer.queryFeatures(q);
          if(!res.features.length){ box.innerHTML='<div style="opacity:.85">No data right now.</div>'; return; }
          const cls=v=>v<=10?"tag good":v<=25?"tag mod":"tag bad";
          box.innerHTML="";
          res.features.forEach(f=>{
            const a=f.attributes,v=a.avg_pm25;
            const row=document.createElement("div");
            row.className="city-item";
            row.innerHTML=`<span>${a.city}, ${a.country_name}</span><span class="${cls(v)}" title="Avg of ${a.n_stations} stations">${Math.round(v)}</span>`;
            row.addEventListener("click",()=>zoomToCity(a.city,a.country_name));
            box.appendChild(row);
          });
        }catch(e){ console.error(e); box.innerHTML='<div style="opacity:.85">Failed to load top cities.</div>'; }
      }

      async function zoomToCity(city,country){
        const q = pm25Layer.createQuery();
        const esc=s=>String(s).replace(/'/g,"''");
        q.where=`city='${esc(city)}' AND country_name='${esc(country)}' AND value BETWEEN 0 AND 500`;
        q.outFields=["*"]; q.returnGeometry=true; q.num=1;
        const res=await pm25Layer.queryFeatures(q);
        if(res.features.length){
          view.goTo({ center: res.features[0].geometry, zoom:11 }, { duration:1500 });
        }
      }

      window.zoomToCity = zoomToCity;

      function togglePanel(id,cls){
        const panel=document.getElementById(id);
        const viewDiv=document.getElementById("viewDiv");
        const isOpen=panel.classList.toggle("open");
        viewDiv.classList.toggle(cls,isOpen);
        if(id==="sidebar"){ document.getElementById("settingsPanel").classList.remove("open"); viewDiv.classList.remove("settings-open"); }
        else { document.getElementById("sidebar").classList.remove("open"); viewDiv.classList.remove("sidebar-open"); }
        setTimeout(()=>window.dispatchEvent(new Event("resize")),250);
      }
      document.getElementById("hamburgerBtn").addEventListener("click",()=>togglePanel("sidebar","sidebar-open"));
      document.getElementById("settingsBtn").addEventListener("click",()=>togglePanel("settingsPanel","settings-open"));

      document.querySelectorAll(".basemap-option").forEach(opt=>{
        opt.addEventListener("click",function(){
          map.basemap=this.dataset.basemap;
          document.querySelectorAll(".basemap-option").forEach(o=>o.classList.remove("active"));
          this.classList.add("active");
        });
      });

      document.getElementById("layerAQI").addEventListener("change", e => { pm25Layer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerGoogleAQI").addEventListener("change", e => { if (googleAqiLayer) googleAqiLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerWind").addEventListener("change", e => { if (windLayer) windLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerFire").addEventListener("change", e => { if (fireLayer) fireLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerCities").addEventListener("change", e => citiesLayer.visible = e.target.checked);
      document.getElementById("layerLegend").addEventListener("change", e => { if(legendWidget) legendWidget.visible = e.target.checked; });

      function performSearch(){
        const term = document.getElementById("searchInput").value.toLowerCase().trim();
        if (!term) return;
        
        if (googleAqiData && googleAqiData.features) {
          const match = googleAqiData.features.find(f => f.properties.name.toLowerCase().includes(term));
          if (match) {
            view.goTo({ center: match.geometry.coordinates, zoom: 12 }, { duration: 1500 });
            toast(`üìç Found ${match.properties.name} in Google AQI data`);
            return;
          }
        }
        
        const query = citiesLayer.createQuery();
        query.where = `LOWER(CITY_NAME) LIKE '%${term.replace(/'/g, "''")}%'`;
        query.outFields = ["CITY_NAME", "CNTRY_NAME"];
        query.returnGeometry = true;
        citiesLayer.queryFeatures(query).then(result => {
            if (result.features.length > 0) {
                const feature = result.features[0];
                view.goTo(feature.geometry);
                toast(`üìç Found ${feature.attributes.CITY_NAME}`);
            } else {
                toast("City not found in available data.", 2500);
            }
        });
      }
      document.getElementById("searchBtn").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") performSearch(); });
    });

    // Mascot and Chat Bubble Controller
    (function() {
        const mascotContainer = document.getElementById('mascotContainer');
        const mascotBtn = document.getElementById('mascotBtn');
        const chatBubble = document.getElementById('chatBubble');
        const closeChat = document.getElementById('closeChat');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let containerStartX = 0;
        let containerStartY = 0;
        let clickStartTime = 0;
        let hasDragged = false;
        let chatHistory = [];

        // Constants for click detection
        const CLICK_TIME_THRESHOLD = 300; // ms
        const CLICK_MOVE_THRESHOLD = 5; // pixels

        // Load saved position from localStorage
        function loadPosition() {
            try {
                const saved = localStorage.getItem('mascotPosition');
                if (saved) {
                    const pos = JSON.parse(saved);
                    mascotContainer.style.left = pos.x + 'px';
                    mascotContainer.style.top = pos.y + 'px';
                }
            } catch (e) {
                console.error('Error loading position:', e);
            }
        }

        // Save position to localStorage
        function savePosition() {
            try {
                const rect = mascotContainer.getBoundingClientRect();
                localStorage.setItem('mascotPosition', JSON.stringify({
                    x: rect.left,
                    y: rect.top
                }));
            } catch (e) {
                console.error('Error saving position:', e);
            }
        }

        // Update chat bubble position based on mascot location
        function updateBubblePosition() {
            const rect = mascotContainer.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            
            // Determine if bubble should be on left or right
            if (rect.left > viewportWidth - 500) {
                // Not enough space on right, show on left
                chatBubble.classList.remove('right');
                chatBubble.classList.add('left');
            } else {
                // Show on right
                chatBubble.classList.remove('left');
                chatBubble.classList.add('right');
            }
        }

        // Toggle chat bubble visibility
        function toggleChat() {
            const isOpen = chatBubble.classList.contains('open');
            if (isOpen) {
                chatBubble.classList.remove('open');
            } else {
                chatBubble.classList.add('open');
                updateBubblePosition();
                chatInput.focus();
            }
        }

        // Handle drag start
        mascotBtn.addEventListener('mousedown', function(e) {
            isDragging = true;
            hasDragged = false;
            clickStartTime = Date.now();
            
            const rect = mascotContainer.getBoundingClientRect();
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            containerStartX = rect.left;
            containerStartY = rect.top;
            
            mascotBtn.classList.add('dragging');
            e.preventDefault();
        });

        // Handle drag move
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            // Check if we've moved enough to consider it a drag
            if (Math.abs(deltaX) > CLICK_MOVE_THRESHOLD || Math.abs(deltaY) > CLICK_MOVE_THRESHOLD) {
                hasDragged = true;
            }
            
            // Update position
            const newX = containerStartX + deltaX;
            const newY = containerStartY + deltaY;
            
            // Keep within viewport bounds
            const maxX = window.innerWidth - 84;
            const maxY = window.innerHeight - 84;
            
            mascotContainer.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            mascotContainer.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
            
            // Update bubble position while dragging
            if (chatBubble.classList.contains('open')) {
                updateBubblePosition();
            }
        });

        // Handle drag end
        document.addEventListener('mouseup', function(e) {
            if (!isDragging) return;
            
            isDragging = false;
            mascotBtn.classList.remove('dragging');
            
            const clickDuration = Date.now() - clickStartTime;
            
            // If it was a click (not a drag), toggle the chat
            if (!hasDragged && clickDuration < CLICK_TIME_THRESHOLD) {
                toggleChat();
            } else {
                // Save position after drag
                savePosition();
            }
        });

        // Close button handler
        closeChat.addEventListener('click', function() {
            chatBubble.classList.remove('open');
        });

        // Chat functionality
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Add user message
            addMessage(text, true);
            chatHistory.push({ role: "user", content: text });
            
            // Clear input and disable while processing
            chatInput.value = '';
            chatInput.disabled = true;
            chatSend.disabled = true;

            // Add thinking message
            const thinkingMsg = addMessage('Analyzing...', false);

            try {
                const response = await fetch('/.netlify/functions/AQI-Chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userMessage: text, 
                        history: chatHistory.slice(0, -1) 
                    })
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const data = await response.json();
                
                // Update thinking message with response
                thinkingMsg.textContent = data.reply || "I couldn't process that request. Please try again.";
                
                chatHistory.push({ role: "assistant", content: data.reply });

                // Handle any actions from the assistant
                if (data.action && data.action.type === 'zoomTo') {
                    const { city, country } = data.action;
                    if (window.zoomToCity) {
                        const toast = document.getElementById('overlayStatus');
                        toast.textContent = `üó∫Ô∏è Zooming to ${city}...`;
                        toast.style.display = 'block';
                        setTimeout(() => toast.style.display = 'none', 2200);
                        window.zoomToCity(city, country);
                    }
                }
            } catch (error) {
                console.error('Chat error:', error);
                thinkingMsg.textContent = 'Sorry, I couldn\'t connect to the server. Please try again.';
                chatHistory.pop(); // Remove failed message from history
            } finally {
                chatInput.disabled = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        // Send button click handler
        chatSend.addEventListener('click', sendMessage);

        // Enter key handler
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (chatBubble.classList.contains('open')) {
                updateBubblePosition();
            }
        });

        // Initialize position
        loadPosition();
    })();
  </script>
</body>
</html>
