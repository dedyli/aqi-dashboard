<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Global AQI Dashboard - Tsinghua University</title>
<link href="https://js.arcgis.com/4.29/esri/themes/light/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;overflow:hidden}
    .header{background:linear-gradient(135deg,#8B2B8B 0%,#2D2D2D 100%);height:70px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1001;position:relative}
    .header-left{display:flex;align-items:center;gap:14px}
    .hamburger,.settings{background:rgba(255,255,255,.22);border:0;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .2s}
    .hamburger:hover,.settings:hover{background:rgba(255,255,255,.32)}
    .header h1{font-size:16px;font-weight:700}
    .header h2{font-size:13px;opacity:.9;font-style:italic;font-weight:400}

    #viewDiv{position:absolute;top:70px;left:0;right:0;bottom:0;transition:.25s}
    #viewDiv.sidebar-open{left:320px}
    #viewDiv.settings-open{right:320px}

    .sidebar,.settings-panel{position:fixed;top:70px;width:320px;height:calc(100vh - 70px);background:linear-gradient(180deg,#8B2B8B 0%,#4A4A4A 100%);color:#fff;padding:18px;z-index:1000;overflow:auto;transition:.25s}
    .sidebar{left:-320px}.sidebar.open{left:0;box-shadow:2px 0 12px rgba(0,0,0,.35)}
    .settings-panel{right:-320px}.settings-panel.open{right:0;box-shadow:-2px 0 12px rgba(0,0,0,.35)}
    h3{border-bottom:1px solid rgba(255,255,255,.3);padding-bottom:8px;margin:14px 0 10px;font-size:15px}

    .search-input{width:100%;padding:12px;border:0;border-radius:8px;background:rgba(255,255,255,.16);color:#fff;margin:6px 0 10px}
    .search-btn{width:100%;padding:12px;background:#0079c1;border:0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}

    .city-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer}
    .city-item:hover{background:rgba(255,255,255,.06)}
    .tag{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag.good{background:#00e400}.tag.mod{background:#ffff00;color:#000}.tag.bad{background:#ff4444}

    .esri-legend{background:rgba(255,255,255,.92)!important;border-radius:10px!important;box-shadow:0 8px 18px rgba(0,0,0,.25)!important}

    .basemap-option{background:rgba(255,255,255,.12);padding:10px 12px;margin:8px 0;border-radius:8px;cursor:pointer;user-select:none;transition:transform .1s, background .2s, box-shadow .2s}
    .basemap-option:hover{background:rgba(255,255,255,.22);transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .basemap-option.active{background:#0079c1;box-shadow:0 4px 12px rgba(0,0,0,.35);font-weight:700}

    #loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#8B2B8B}
    #overlayStatus{position:absolute;top:78px;right:12px;z-index:1002;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;display:none}

    /* Chat */
    #chat{position:fixed;right:20px;bottom:20px;width:340px;max-height:70vh;background:#1f1f1f;color:#f5f5f5;border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.35);z-index:1200;display:flex;flex-direction:column;overflow:hidden}
    #chatHead{background:linear-gradient(135deg,#9a3bb8,#612aa1);color:#fff;padding:10px 12px;font-weight:800;display:flex;align-items:center;justify-content:space-between;cursor:move;user-select:none}
    .cbtn{background:transparent;border:0;color:#fff;font-size:16px;font-weight:800;cursor:pointer}
    #msgs{padding:10px;height:240px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{padding:8px 10px;border-radius:10px;line-height:1.4;font-size:14px;max-width:88%}
    .me{align-self:flex-end;background:#2f2f2f}.bot{align-self:flex-start;background:#f2ecf4;color:#111}
    #composer{display:flex;border-top:1px solid rgba(255,255,255,.12)}
    #q{flex:1;padding:10px;border:0;background:#121212;color:#fff}
    #send{padding:10px 12px;border:0;background:#0079c1;color:#fff;font-weight:700;cursor:pointer}
  
/* Mascot chat toggle */
#chat { display: none; }
#chat.open { display: flex; }

/* === Draggable mascot + attached conversation bubble === */
.aqi-float{ user-select:none; touch-action:none; }
#mascotToggle:focus{ outline-offset:4px; }
.chat-bubble{
  position:absolute;
  display:none;
  max-width:min(420px, 86vw);
  max-height:min(70vh, 640px);
  border-radius:16px;
  background:#181b22ee;
  border:1px solid #2a2f3a;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
  overflow:hidden;
  transform: translate(0, -12px);
}
.chat-bubble.open{ display:block; }
.chat-bubble.right{ left: -8px; transform: translate(-100%, -12px); } /* bubble opens to the left of mascot */
.chat-bubble.left{ left: 84px; } /* bubble opens to the right of mascot */
.chat-bubble::after{
  content:"";
  position:absolute; top:36px; width:0; height:0; border:10px solid transparent;
}
.chat-bubble.left::after{
  left:-1px; transform:translateX(-100%);
  border-right-color:#181b22ee; border-left-color:transparent;
}
.chat-bubble.right::after{
  right:-1px; transform:translateX(100%);
  border-left-color:#181b22ee; border-right-color:transparent;
}
/* Fit the existing #chat inside the bubble */
.bubble-chat{ width:min(420px, 86vw); height:min(70vh, 640px); display:flex !important; flex-direction:column; }


/* === High-contrast mascot + bubble visibility on maps === */
#aqiFloat { z-index: 2147483600 !important; }
#mascotToggle{
  position: relative;
  width: 86px; height: 86px;
  padding: 10px !important;
  border-radius: 20px !important;
  background: rgba(10,12,16,.55) !important;
  border: 1px solid rgba(255,255,255,.22) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,.55), 0 0 0 2px rgba(255,255,255,.06) !important;
  backdrop-filter: blur(8px) saturate(1.1);
}
#mascotToggle::before{
  content:""; position:absolute; inset:8px;
  border-radius: 16px;
  background: radial-gradient(ellipse at 50% 45%, rgba(255,255,255,.96), rgba(255,255,255,.92) 60%, rgba(255,255,255,.88));
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.05), 0 2px 8px rgba(0,0,0,.25);
  z-index: 0;
}
#mascotToggle img{
  position:relative; z-index:1;
  width: 66px !important; height: 66px !important;
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 8px 12px rgba(0,0,0,.25)) brightness(1.12) saturate(1.05);
}

/* Bubble: brighter border + stronger shadow for visibility */
.chat-bubble{
  background: rgba(17,20,28,.94) !important;
  border: 1px solid rgba(255,255,255,.35) !important;
  box-shadow: 0 18px 50px rgba(0,0,0,.6), 0 0 0 1px rgba(0,0,0,.25) !important;
}
.chat-bubble.left::after{ border-right-color: rgba(17,20,28,.94) !important; }
.chat-bubble.right::after{ border-left-color: rgba(17,20,28,.94) !important; }

/* Make sure inner chat uses readable text defaults */
.chat-bubble, .chat-bubble *{
  color: #e9edf5;
}


@keyframes ringPulse { 0%{ box-shadow: 0 0 0 0 rgba(106,27,154,.35); } 100%{ box-shadow: 0 0 0 12px rgba(106,27,154,0); } }
#mascotToggle:after{
  content:""; position:absolute; inset:-4px; border-radius:24px;
  animation: ringPulse 2.2s ease-out infinite;
}


/* Draggable wrapper + bubble arrow */
.aqi-float{ user-select:none; touch-action:none; }
.chat-bubble{
  position:absolute; display:none;
  max-width:min(420px, 86vw); max-height:min(70vh, 640px);
  border-radius:16px; background:#11141cee; border:1px solid rgba(255,255,255,.35);
  box-shadow:0 18px 50px rgba(0,0,0,.6), 0 0 0 1px rgba(0,0,0,.25);
  overflow:hidden; transform: translate(0, -12px);
}
.chat-bubble.open{ display:block; }
.chat-bubble::after{ content:""; position:absolute; top:36px; width:0; height:0; border:10px solid transparent; }
.chat-bubble.left{ left: 84px; }
.chat-bubble.left::after{ left:-1px; transform:translateX(-100%); border-right-color:#11141cee; }
.chat-bubble.right{ left: -8px; transform: translate(-100%, -12px); }
.chat-bubble.right::after{ right:-1px; transform:translateX(100%); border-left-color:#11141cee; }
/* Fit existing #chat inside */
.bubble-chat{ width:min(420px, 86vw); height:min(70vh, 640px); display:flex !important; flex-direction:column; }
</style>
</head>
<body>
<div class="header">
<div class="header-left">
<button class="hamburger" id="hamburgerBtn">‚ò∞</button>
<div>
<h1>Group 62 IEDE Research Topic</h1>
<h2>AI-Driven Environmental Monitoring for a Green Economy</h2>
</div>
</div>
<button class="settings" id="settingsBtn">‚öôÔ∏è Settings</button>
</div>
<aside class="sidebar" id="sidebar">
<div class="search">
<h3>üîç Location Search</h3>
<input class="search-input" id="searchInput" placeholder="Enter city name‚Ä¶"/>
<button class="search-btn" id="searchBtn">Search Location</button>
</div>
<h3>üè≠ Most Polluted Cities (Live)</h3>
<div id="topCities"><div style="opacity:.85">Loading‚Ä¶</div></div>
<h3>üåè Google AQI Cities</h3>
<div id="googleAqiList"><div style="opacity:.85">Loading data...</div></div>
<h3>üìà Notes</h3>
<div style="opacity:.9;font-size:13px">
      ‚Ä¢ Live stations: OpenAQ via Esri Living Atlas<br/>
      ‚Ä¢ World cities: Major cities worldwide<br/>
      ‚Ä¢ Regional AQI: Google Air Quality API
    </div>
<h3>‚ÑπÔ∏è Status</h3>
<div id="status" style="opacity:.9;font-size:13px"></div>
</aside>
<aside class="settings-panel" id="settingsPanel">
<h3>üó∫Ô∏è Map Style</h3>
<div class="basemap-option active" data-basemap="satellite">Satellite</div>
<div class="basemap-option" data-basemap="streets">Streets</div>
<div class="basemap-option" data-basemap="hybrid">Hybrid</div>
<div class="basemap-option" data-basemap="terrain">Terrain</div>
<div class="basemap-option" data-basemap="dark-gray">Dark Gray</div>
<div class="basemap-option" data-basemap="topo">Topographic</div>
<div class="basemap-option" data-basemap="gray">Light Gray</div>
<div class="basemap-option" data-basemap="oceans">Oceans</div>
<h3>üìä Data Layers</h3>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>PM2.5 Stations (OpenAQ)</span>
<label><input checked="" id="layerAQI" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Cities (Google AQI)</span>
<label><input checked="" id="layerGoogleAQI" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>World Cities</span>
<label><input checked="" id="layerCities" type="checkbox"/> Visible</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
<span>Legend</span>
<label><input checked="" id="layerLegend" type="checkbox"/> Visible</label>
</div>
</aside>
<div id="viewDiv">
<div id="loading">Loading map‚Ä¶</div>
<div id="overlayStatus"></div>
</div>
<script>
    require([
      "esri/Map","esri/views/MapView",
      "esri/layers/FeatureLayer","esri/layers/GeoJSONLayer",
      "esri/widgets/Legend","esri/config"
    ], function(Map, MapView, FeatureLayer, GeoJSONLayer, Legend, esriConfig) {

      let googleAqiLayer = null;
      let googleAqiData = null; // Store fetched data
      
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map, center: [105, 35], zoom: 4,
        popup: { dockEnabled: true, dockOptions:{ buttonEnabled: false, breakpoint: false, position: "bottom-right" } }
      });

      try { esriConfig.request.corsEnabledServers.push(window.location.origin); } catch(e) {}

      const toast = (msg, ms = 2200) => {
        const el = document.getElementById("overlayStatus");
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(el._t);
        el._t = setTimeout(() => el.style.display = "none", ms);
      };

      function createGoogleAqiLayer(geoJsonData) {
        const blob = new Blob([JSON.stringify(geoJsonData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        return new GeoJSONLayer({
          url: url,
          title: "Cities (Google AQI)",
          copyright: "¬© Google Air Quality API - Live Data",
          renderer: {
            type: "class-breaks",
            field: "aqi",
            classBreakInfos: [
              { minValue: 0, maxValue: 50, symbol: { type: "simple-marker", style: "triangle", size: 12, color: "#00e400", outline: { color: "#fff", width: 1.5 } }, label: "Good (0‚Äì50)" },
              { minValue: 51, maxValue: 100, symbol: { type: "simple-marker", style: "triangle", size: 14, color: "#ffff00", outline: { color: "#fff", width: 1.5 } }, label: "Moderate (51‚Äì100)" },
              { minValue: 101, maxValue: 150, symbol: { type: "simple-marker", style: "triangle", size: 16, color: "#ff7e00", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy for Sensitive (101‚Äì150)" },
              { minValue: 151, maxValue: 200, symbol: { type: "simple-marker", style: "triangle", size: 18, color: "#ff0000", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy (151‚Äì200)" },
              { minValue: 201, maxValue: 300, symbol: { type: "simple-marker", style: "triangle", size: 20, color: "#8f3f97", outline: { color: "#fff", width: 1.5 } }, label: "Very Unhealthy (201‚Äì300)" },
              { minValue: 301, maxValue: 9999, symbol: { type: "simple-marker", style: "triangle", size: 22, color: "#7e0023", outline: { color: "#fff", width: 1.5 } }, label: "Hazardous (300+)" }
            ]
          },
          popupTemplate: {
            title: "{name} - Google AQI",
            content: `<div style="line-height:1.5">
              <b>üå¨Ô∏è US AQI:</b> <span style="font-size:18px;font-weight:bold;">{aqi}</span><br>
              <b>üìä Category:</b> {category}<br>
              <b>üí® Dominant Pollutant:</b> {main_pollutant}<br>
              <b>üïí Last Updated:</b> {time}<br>
              <b>üìç Location:</b> {name}<br>
              <b>üìä Data Source:</b> {source}
            </div>`
          }
        });
      }

      async function loadGoogleAqiData() {
        try {
          toast("Loading Google AQI data...", 3000);
          const response = await fetch('/.netlify/functions/google-aqi');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          googleAqiData = await response.json();

          if (googleAqiData.warning) console.warn("API Warning:", googleAqiData.warning);

          googleAqiLayer = createGoogleAqiLayer(googleAqiData);
          map.add(googleAqiLayer, 1); // Add below PM2.5 layer

          await googleAqiLayer.load();
          toast("‚úÖ Google AQI data loaded!");
          updateStatus();
          updateLegend();
          updateGoogleAqiList(googleAqiData);
        } catch (error) {
          console.error("Failed to load Google AQI data:", error);
          toast("‚ùå Failed to load Google AQI data");
          document.getElementById("googleAqiList").innerHTML = `<div style="opacity:.85; color: #ffdddd;">Failed to load.</div>`;
          updateStatus();
        }
      }
      
      function updateGoogleAqiList(geoJsonData) {
          const listElement = document.getElementById("googleAqiList");
          if (!geoJsonData || !geoJsonData.features || geoJsonData.features.length === 0) {
              listElement.innerHTML = '<div style="opacity:.85">No data available</div>';
              return;
          }
          const cities = geoJsonData.features.map(f => f.properties).sort((a, b) => b.aqi - a.aqi);
          const getAqiClass = (aqi) => {
              if (aqi <= 50) return "tag good";
              if (aqi <= 100) return "tag mod";
              return "tag bad";
          };
          listElement.innerHTML = "";
          cities.forEach(city => {
              const row = document.createElement("div");
              row.className = "city-item";
              row.innerHTML = `<span>${city.name}</span><span class="${getAqiClass(city.aqi)}">${city.aqi}</span>`;
              row.addEventListener("click", () => {
                  const feature = geoJsonData.features.find(f => f.properties.name === city.name);
                  if (feature) {
                      view.goTo({ center: feature.geometry.coordinates, zoom: 11 }, { duration: 1500 });
                  }
              });
              listElement.appendChild(row);
          });
      }

      const pm25Layer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
        title:"PM2.5 Stations (OpenAQ)", outFields:["*"],
        popupTemplate:{ title:"{location} ({country_name})", content:`<div style="line-height:1.5">
          <b>City:</b> {city}<br><b>PM2.5:</b> {value} {unit}<br><b>Provider:</b> {provider_name}<br>
          <b>Updated:</b> {lastUpdated}<br><a href="{url}" target="_blank" rel="noopener">Station link</a></div>` },
        renderer:{ type:"class-breaks", field:"value", classBreakInfos:[
          {minValue:0,maxValue:10,symbol:{type:"simple-marker",size:8,color:"#00e400",outline:{color:"#fff",width:1}},label:"Good (0‚Äì10)"},
          {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10,color:"#ffff00",outline:{color:"#fff",width:1}},label:"Moderate (10‚Äì25)"},
          {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12,color:"#ff7e00",outline:{color:"#fff",width:1}},label:"USG (25‚Äì50)"},
          {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14,color:"#ff0000",outline:{color:"#fff",width:1}},label:"Unhealthy (50‚Äì75)"},
          {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16,color:"#8f3f97",outline:{color:"#fff",width:1}},label:"Very Unhealthy (75‚Äì100)"},
          {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18,color:"#7e0023",outline:{color:"#fff",width:1}},label:"Hazardous (100+)"}
        ]}
      });
      map.add(pm25Layer);

      const citiesLayer = new FeatureLayer({
        url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
        title:"World Cities", definitionExpression:"POP > 100000",
        renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
        labelingInfo:[{ symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
          labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000 }],
        popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
      });
      map.add(citiesLayer);

      let legendWidget = null;
      function updateLegend() {
        if (!legendWidget) return;
        const layerInfos = [];
        if (pm25Layer && pm25Layer.visible) {
            layerInfos.push({ layer: pm25Layer, title: "PM2.5 (Œºg/m¬≥) ‚Äî Live Stations" });
        }
        if (googleAqiLayer && googleAqiLayer.visible) {
            layerInfos.push({ layer: googleAqiLayer, title: "Cities (Google AQI)" });
        }
        legendWidget.layerInfos = layerInfos;
      }

      view.whenLayerView(pm25Layer).then(() => {
        legendWidget = new Legend({ view, layerInfos:[] });
        view.ui.add(legendWidget, "bottom-left");
        document.getElementById("loading").style.display = "none";
        
        loadGoogleAqiData();
        updateStatus();
        updateLegend();
        refreshTopCities();
        setInterval(refreshTopCities, 30 * 60 * 1000);
      });

      function updateStatus() {
        const statusParts = [];
        pm25Layer.queryFeatureCount().then(c => {
            statusParts.push(`‚úì PM2.5 stations connected (${c.toLocaleString()})`);
            if (googleAqiLayer && googleAqiLayer.loaded) {
                const count = googleAqiData ? googleAqiData.features.length : 0;
                statusParts.push(`‚úì Google AQI active (${count} cities)`);
            } else if (googleAqiLayer) {
                statusParts.push(`... Google AQI loading...`);
            } else {
                 statusParts.push(`‚ùå Google AQI failed to load.`);
            }
            document.getElementById("status").innerHTML = statusParts.join('<br>');
        }).catch(() => {
            document.getElementById("status").textContent = "‚ö†Ô∏è Could not connect to all data sources.";
        });
      }

      async function refreshTopCities(){
        const box=document.getElementById("topCities"); box.innerHTML='<div style="opacity:.85">Updating‚Ä¶</div>';
        try{
          const q=pm25Layer.createQuery();
          q.where="value BETWEEN 0 AND 500 AND city IS NOT NULL AND unit IN ('¬µg/m¬≥','ug/m3')";
          q.groupByFieldsForStatistics=["city","country_name"];
          q.outStatistics=[
            {statisticType:"avg",onStatisticField:"value",outStatisticFieldName:"avg_pm25"},
            {statisticType:"count",onStatisticField:"value",outStatisticFieldName:"n_stations"}
          ];
          q.havingClause="COUNT(value) >= 3"; q.orderByFields=["avg_pm25 DESC"]; q.num=10; q.returnGeometry=false;
          const res=await pm25Layer.queryFeatures(q);
          if(!res.features.length){ box.innerHTML='<div style="opacity:.85">No data right now.</div>'; return; }
          const cls=v=>v<=10?"tag good":v<=25?"tag mod":"tag bad";
          box.innerHTML="";
          res.features.forEach(f=>{
            const a=f.attributes,v=a.avg_pm25;
            const row=document.createElement("div");
            row.className="city-item";
            row.innerHTML=`<span>${a.city}, ${a.country_name}</span><span class="${cls(v)}" title="Avg of ${a.n_stations} stations">${Math.round(v)}</span>`;
            row.addEventListener("click",()=>zoomToCity(a.city,a.country_name));
            box.appendChild(row);
          });
        }catch(e){ console.error(e); box.innerHTML='<div style="opacity:.85">Failed to load top cities.</div>'; }
      }

      async function zoomToCity(city,country){
        const q = pm25Layer.createQuery();
        const esc=s=>String(s).replace(/'/g,"''");
        q.where=`city='${esc(city)}' AND country_name='${esc(country)}' AND value BETWEEN 0 AND 500`;
        q.outFields=["*"]; q.returnGeometry=true; q.num=1;
        const res=await pm25Layer.queryFeatures(q);
        if(res.features.length){
          view.goTo({ center: res.features[0].geometry, zoom:11 }, { duration:1500 });
        }
      }

      // Make zoomToCity globally available for the chat assistant
      window.zoomToCity = zoomToCity;

      function togglePanel(id,cls){
        const panel=document.getElementById(id);
        const viewDiv=document.getElementById("viewDiv");
        const isOpen=panel.classList.toggle("open");
        viewDiv.classList.toggle(cls,isOpen);
        if(id==="sidebar"){ document.getElementById("settingsPanel").classList.remove("open"); viewDiv.classList.remove("settings-open"); }
        else { document.getElementById("sidebar").classList.remove("open"); viewDiv.classList.remove("sidebar-open"); }
        setTimeout(()=>window.dispatchEvent(new Event("resize")),250);
      }
      document.getElementById("hamburgerBtn").addEventListener("click",()=>togglePanel("sidebar","sidebar-open"));
      document.getElementById("settingsBtn").addEventListener("click",()=>togglePanel("settingsPanel","settings-open"));

      document.querySelectorAll(".basemap-option").forEach(opt=>{
        opt.addEventListener("click",function(){
          map.basemap=this.dataset.basemap;
          document.querySelectorAll(".basemap-option").forEach(o=>o.classList.remove("active"));
          this.classList.add("active");
        });
      });

      document.getElementById("layerAQI").addEventListener("change", e => { pm25Layer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerGoogleAQI").addEventListener("change", e => { if (googleAqiLayer) googleAqiLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerCities").addEventListener("change", e => citiesLayer.visible = e.target.checked);
      document.getElementById("layerLegend").addEventListener("change", e => { if(legendWidget) legendWidget.visible = e.target.checked; });

      function performSearch(){
        const term = document.getElementById("searchInput").value.toLowerCase().trim();
        if (!term) return;
        
        if (googleAqiData && googleAqiData.features) {
          const match = googleAqiData.features.find(f => f.properties.name.toLowerCase().includes(term));
          if (match) {
            view.goTo({ center: match.geometry.coordinates, zoom: 12 }, { duration: 1500 });
            toast(`üìç Found ${match.properties.name} in Google AQI data`);
            return;
          }
        }
        
        const query = citiesLayer.createQuery();
        query.where = `LOWER(CITY_NAME) LIKE '%${term.replace(/'/g, "''")}%'`;
        query.outFields = ["CITY_NAME", "CNTRY_NAME"];
        query.returnGeometry = true;
        citiesLayer.queryFeatures(query).then(result => {
            if (result.features.length > 0) {
                const feature = result.features[0];
                view.goTo(feature.geometry);
                toast(`üìç Found ${feature.attributes.CITY_NAME}`);
            } else {
                toast("City not found in available data.", 2500);
            }
        });
      }
      document.getElementById("searchBtn").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") performSearch(); });
    
      /* AQI Assistant Chat Controller */
      (function(){
        const chat = document.getElementById("chat");
        const head = document.getElementById("chatHead");
        const body = document.getElementById("chatBody");
        const minBtn = document.getElementById("minBtn");
        const msgs = document.getElementById("msgs");
        const q = document.getElementById("q");
        const send = document.getElementById("send");

        let history = [];
        let drag = false, offX = 0, offY = 0;

        head.addEventListener("mousedown", e => { 
          if (e.target === minBtn) return; 
          drag = true; 
          const r = chat.getBoundingClientRect(); 
          offX = e.clientX - r.left; 
          offY = e.clientY - r.top; 
          chat.style.right = "auto"; 
          chat.style.bottom = "auto"; 
        });
        window.addEventListener("mousemove", e => { 
          if (!drag) return; 
          chat.style.left = (e.clientX - offX) + "px"; 
          chat.style.top = (e.clientY - offY) + "px"; 
        });
        window.addEventListener("mouseup", () => drag = false);
        minBtn.addEventListener("click", () => { 
          const isOpen = body.style.display !== "none"; 
          body.style.display = isOpen ? "none" : "flex"; 
          minBtn.textContent = isOpen ? "‚äï" : "‚Äì"; 
        });

        function addBubble(text, who = "bot", data = {}) {
          const d = document.createElement("div");
          d.className = `bubble ${who}`;
          d.textContent = text;
          msgs.appendChild(d);
          msgs.scrollTop = msgs.scrollHeight;
          return d;
        }

        async function sendMsg(){
          const text = q.value.trim();
          if (!text) return;

          addBubble(text, "me");
          history.push({ role: "user", content: text });
          q.value = "";
          q.disabled = true;
          send.disabled = true;

          const thinking = addBubble("Thinking‚Ä¶", "bot");

          try {
            const resp = await fetch("/.netlify/functions/AQI-Chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userMessage: text, history: history.slice(0, -1) }) // Send history *before* this turn
            });

            if (!resp.ok) throw new Error(`Server error: ${resp.status}`);

            const data = await resp.json();
            thinking.textContent = (typeof data.reply === "string" && data.reply.trim()) ? data.reply : "I don't have a response for that.";
            
            history.push({ role: "assistant", content: data.reply });

            // Handle the action returned by the server function
            if (data.action && data.action.type === 'zoomTo') {
              const { city, country } = data.action;
              if (window.zoomToCity) {
                toast(`üó∫Ô∏è Zooming to ${city}...`);
                window.zoomToCity(city, country);
              }
            }
          } catch(err) {
            console.error("Chat error:", err);
            thinking.textContent = "Sorry, I couldn't connect to the server. Please try again in a moment.";
            history.pop(); // Remove the user message from history if the call failed
          } finally {
            q.disabled = false;
            send.disabled = false;
            q.focus();
          }
        }
        send.addEventListener("click", sendMsg);
        q.addEventListener("keypress", e => { if(e.key === "Enter") sendMsg(); });
      })();
    });
  </script>
<!-- Floating mascot toggle -->
<script>
(function(){
  const btn  = document.getElementById('mascotToggle');
  const chat = document.getElementById('chat');
  const minBtn = document.getElementById('minBtn');
  function setOpen(open){
    chat.classList.toggle('open', open);
    btn.setAttribute('aria-expanded', String(open));
  }
  btn.addEventListener('click', ()=> setOpen(!chat.classList.contains('open')));
  if(minBtn){
    minBtn.addEventListener('click', ()=> setOpen(false));
  }
})();
</script>
<div class="aqi-float" id="aqiFloat" style="position:fixed; left: calc(100% - 100px); top: calc(100% - 120px); z-index: 2147483000; width:max-content;"><button aria-controls="chat" aria-expanded="false" id="mascotToggle" style="border:0;background:#202430;padding:8px;border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);cursor:pointer" title="Open AQI Assistant">
<img alt="AQI Assistant mascot" src="./mascot.png" style="width:72px;height:72px;display:block;object-fit:contain"/>
</button>
<section aria-label="AQI Assistant" aria-modal="false" class="chat-bubble" id="chatBubble" role="dialog">
<div class="bubble-body" id="bubbleMount"><section aria-live="polite" class="bubble-chat" id="chat">
<div id="chatHead">
<span>AQI Assistant</span>
<button class="cbtn" id="minBtn" title="Minimize">‚Äì</button>
</div>
<div id="chatBody">
<div id="msgs">
<div class="bubble bot">Hi! Ask me about air quality. Try: "What's the PM2.5 in Hanoi?" or "Which are the top 5 most polluted cities right now?"</div>
</div>
<div id="composer">
<input id="q" placeholder="Ask about PM2.5 / AQI‚Ä¶"/>
<button id="send">Send</button>
</div>
</div>
</section></div>
</section>
</div>

<script>
(function(){
  const wrapper = document.getElementById('aqiFloat');
  const btn = document.getElementById('mascotToggle');
  const bubble = document.getElementById('chatBubble');
  const chat = document.getElementById('chat');
  const minBtn = document.getElementById('minBtn');
  const LS_POS = 'aqi-float-pos';
  const LS_OPEN = 'aqi-chat-open';

  if(!btn || !wrapper || !bubble){ return; }

  function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }

  function setOpen(open){
    bubble.classList.toggle('open', open);
    btn.setAttribute('aria-expanded', String(open));
    try{ localStorage.setItem(LS_OPEN, open ? '1' : '0'); }catch(_){}
    updateSide();
  }
  function isOpen(){ return bubble.classList.contains('open'); }

  // Decide whether bubble opens to left or right based on viewport
  function updateSide(){
    const rect = wrapper.getBoundingClientRect();
    const vw = window.innerWidth;
    const openLeft = rect.right > vw - 240; // if near right edge, open left
    bubble.classList.toggle('right', openLeft);
    bubble.classList.toggle('left', !openLeft);
  }

  // Restore last pos
  try{
    const saved = JSON.parse(localStorage.getItem(LS_POS)||'null');
    if(saved && typeof saved.x==='number' && typeof saved.y==='number'){
      wrapper.style.left = saved.x + 'px';
      wrapper.style.top  = saved.y + 'px';
    }
  }catch(_){}
  // Restore open state
  try{ if(localStorage.getItem(LS_OPEN)==='1'){ setOpen(true); } }catch(_){}

  // --- Tap vs drag handling ---
  let dragging=false, startX=0, startY=0, origX=0, origY=0, startTime=0;
  const TAP_MAX_DIST = 6;   // px
  const TAP_MAX_TIME = 250; // ms

  function onPointerDown(e){
    // left click or touch only
    if(e.pointerType === 'mouse' && e.button !== 0) return;
    dragging = true;
    startTime = Date.now();
    const rect = wrapper.getBoundingClientRect();
    startX = e.clientX; startY = e.clientY;
    origX = rect.left;  origY = rect.top;
    btn.setPointerCapture && btn.setPointerCapture(e.pointerId);
  }
  function onPointerMove(e){
    if(!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    if(Math.abs(dx) < 1 && Math.abs(dy) < 1) return; // ignore micro jitter
    const vw = window.innerWidth, vh = window.innerHeight;
    const newX = clamp(origX + dx, 8, vw - 96);
    const newY = clamp(origY + dy, 8, vh - 96);
    wrapper.style.left = newX + 'px';
    wrapper.style.top  = newY + 'px';
    updateSide();
  }
  function onPointerUp(e){
    if(!dragging) return;
    dragging = false;
    btn.releasePointerCapture && btn.releasePointerCapture(e.pointerId);
    // Determine tap vs drag
    const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
    const time = Date.now() - startTime;
    if(dist <= TAP_MAX_DIST && time <= TAP_MAX_TIME){
      setOpen(!isOpen()); // treat as click
    }else{
      // persist new pos
      const rect = wrapper.getBoundingClientRect();
      try{ localStorage.setItem(LS_POS, JSON.stringify({x: Math.round(rect.left), y: Math.round(rect.top)})); }catch(_){}
    }
  }
  btn.addEventListener('pointerdown', onPointerDown);
  btn.addEventListener('pointermove', onPointerMove);
  btn.addEventListener('pointerup', onPointerUp);
  btn.addEventListener('pointercancel', onPointerUp);

  // Minimize button inside chat closes the bubble
  if(minBtn){ minBtn.addEventListener('click', ()=> setOpen(false)); }

  window.addEventListener('resize', updateSide);
  updateSide();

  // Ensure the inner chat is visible when bubble is open
  if(chat){ chat.style.display = 'flex'; }
})();
</script></body>
</html>
