<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Global Air Quality Intelligence Platform</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-color: #050507;
        --panel-bg: rgba(12, 12, 18, 0.7);
        --panel-border: rgba(255, 215, 0, 0.2);
        --panel-border-active: rgba(255, 215, 0, 0.8);
        --text-primary: #f0f0f5;
        --text-secondary: #a0a0b0;
        --text-muted: #606070;
        --accent-gold: #FFD700;
        --accent-glow: rgba(255, 215, 0, 0.4);
        --accent-gradient: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        --header-height: 72px;
        --radius: 12px;
        --padding: 20px;
        --font-display: 'Inter', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        height: 100%;
        font-family: var(--font-display);
        background-color: var(--bg-color);
        color: var(--text-primary);
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    body::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSJ0cmFuc3BhcmVudCI+PC9yZWN0PjxwYXRoIGQ9Ik0wIDEwIEwgMTAgMCBNMjAgMzAgTCAzMCAyMCBNNDAgNTAgTCA1MCA0MCIgc3Ryb2tlPSJyZ2JhKDIwMCwgMjAwLCAyNTUsIDAuMDMpIiBzdHJva2Utd2lkdGg9IjEiPjwvcGF0aD48L3N2Zz4=');
        opacity: 0.5;
        pointer-events: none;
    }

    #viewDiv {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 1;
        background: linear-gradient(45deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
    }
    
    #uiContainer {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 10;
        pointer-events: none;
    }

    /* --- FALLBACK MAP STYLES --- */
    #fallbackMap {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(45deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2;
    }

    .world-svg {
        width: 80%;
        max-width: 1000px;
        height: auto;
        opacity: 0.3;
        filter: drop-shadow(0 0 20px var(--accent-glow));
    }

    .air-quality-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        pointer-events: none;
    }

    .pollution-hotspot {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
        box-shadow: 0 0 10px currentColor;
    }

    .pollution-hotspot.severe { color: #ff0000; }
    .pollution-hotspot.high { color: #ff7e00; }
    .pollution-hotspot.moderate { color: #ffff00; }
    .pollution-hotspot.good { color: #00e400; }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.5); opacity: 1; }
    }

    .main-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--header-height);
        z-index: 15;
        display: flex;
        align-items: center;
        padding: 0 32px;
        background-color: var(--panel-bg);
        backdrop-filter: blur(16px) saturate(120%);
        border-bottom: 1px solid var(--panel-border);
        pointer-events: auto;
    }
    #header-globe {
        width: 60px;
        height: var(--header-height);
        margin-right: 20px;
        cursor: pointer;
    }
    .header-title h1 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: -0.5px;
    }
    .header-title h2 {
        font-size: 14px;
        font-weight: 400;
        color: var(--text-secondary);
        opacity: 0.8;
    }

    /* Status indicator */
    .map-status {
        position: absolute;
        top: var(--header-height);
        right: 20px;
        padding: 8px 16px;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        font-size: 12px;
        backdrop-filter: blur(16px);
        pointer-events: auto;
        z-index: 20;
    }

    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 1s infinite;
    }

    .status-dot.loading { background: #ff9800; }
    .status-dot.online { background: #4caf50; animation: none; }
    .status-dot.offline { background: #f44336; animation: none; }

    /* --- FLOATING PANELS --- */
    .floating-panel {
        position: absolute;
        background-color: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,0,0,0.2);
        backdrop-filter: blur(16px) saturate(120%);
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        transition: transform 0.4s var(--ease-out), opacity 0.4s var(--ease-out), border-color 0.3s ease;
        opacity: 0;
        transform: scale(0.95);
        overflow: hidden;
        visibility: hidden;
    }

    .floating-panel.visible {
        opacity: 1;
        transform: scale(1);
        visibility: visible;
    }
    
    .floating-panel.active {
        border-color: var(--panel-border-active);
        box-shadow: 0 15px 50px rgba(0,0,0,0.4), 0 0 20px var(--accent-glow);
        z-index: 16 !important;
    }

    .panel-header {
        display: flex;
        align-items: center;
        padding: 12px var(--padding);
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--panel-border);
        cursor: move;
        flex-shrink: 0;
        position: relative;
    }
    
    .panel-icon { margin-right: 12px; font-size: 16px; opacity: 0.8; }
    .panel-title { font-weight: 600; font-size: 15px; flex-grow: 1; user-select: none; }
    
    .panel-controls button {
        background: none; border: none; color: var(--text-secondary);
        font-size: 18px; width: 28px; height: 28px;
        border-radius: 6px; cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
    }
    .panel-controls button:hover {
        background-color: rgba(255,255,255,0.1);
        color: var(--text-primary);
    }
    
    .panel-content {
        padding: var(--padding);
        overflow-y: auto;
        flex-grow: 1;
    }
    
    .panel-content::-webkit-scrollbar { width: 6px; }
    .panel-content::-webkit-scrollbar-track { background: transparent; }
    .panel-content::-webkit-scrollbar-thumb { background-color: rgba(255, 215, 0, 0.3); border-radius: 3px; }
    .panel-content::-webkit-scrollbar-thumb:hover { background-color: var(--accent-gold); }

    .panel-aurora {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
        overflow: hidden;
        border-radius: var(--radius);
    }
    .panel-aurora::before, .panel-aurora::after {
        content: '';
        position: absolute;
        width: 400px;
        height: 400px;
        background-image: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
        opacity: 0.3;
        animation: aurora-flow 20s infinite linear;
    }
    .panel-aurora::after {
        background-image: radial-gradient(circle, rgba(0, 150, 255, 0.1) 0%, transparent 70%);
        animation: aurora-flow-2 25s infinite linear;
    }

    @keyframes aurora-flow {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    @keyframes aurora-flow-2 {
        0% { transform: translate(50%, 50%) rotate(0deg); }
        100% { transform: translate(50%, 50%) rotate(-360deg); }
    }

    .search-input, .search-btn {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--panel-border);
        background: rgba(0,0,0,0.3);
        color: var(--text-primary);
        font-size: 15px;
        border-radius: 8px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
        outline: none;
        border-color: var(--accent-gold);
        box-shadow: 0 0 10px var(--accent-glow);
    }
    .search-btn {
        margin-top: 10px;
        background: var(--accent-gold);
        color: #050507;
        font-weight: 600;
        cursor: pointer;
    }
    .search-btn:hover { box-shadow: 0 0 10px var(--accent-glow); }

    .city-item { 
        padding: 12px; 
        border-bottom: 1px solid var(--panel-border); 
        cursor: pointer; 
        transition: background-color 0.2s; 
        border-radius: 6px;
        margin-bottom: 8px;
        background: rgba(0,0,0,0.2);
    }
    .city-item:hover { background-color: rgba(255,215,0,0.1); }

    /* --- CONTROL DOCK --- */
    #controlDock {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        padding: 8px;
        height: 70px;
        background-color: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(16px) saturate(120%);
        pointer-events: auto;
    }

    .dock-btn {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-secondary);
        width: 44px; height: 44px;
        margin-bottom: 2px;
        border-radius: 8px;
        font-size: 20px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .dock-btn:hover {
        color: var(--text-primary);
        background-color: rgba(255,255,255,0.1);
    }
    .dock-btn.active {
        color: var(--accent-gold);
        background-color: rgba(255, 215, 0, 0.15);
        border-color: var(--accent-gold);
    }

    #loading { 
        font-size: 20px; 
        color: var(--accent-gold); 
        text-shadow: 0 0 10px var(--accent-glow); 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%,-50%);
        z-index: 100;
        text-align: center;
    }

    /* --- CHAT STYLES --- */
    #panel-chat .panel-content { padding: 0; display: flex; flex-direction: column; }
    #chatMessages { flex: 1; overflow-y: auto; padding: var(--padding); display: flex; flex-direction: column; gap: 16px; min-height: 300px; }
    .message { padding: 12px 16px; border-radius: var(--radius); max-width: 85%; word-wrap: break-word; font-size: 15px; line-height: 1.6; animation: messageSlideIn 0.4s var(--ease-out); }
    @keyframes messageSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { align-self: flex-end; background: var(--accent-gradient); color: #050507; font-weight: 500; }
    .message.bot { align-self: flex-start; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); border: 1px solid var(--panel-border); }
    #chatInputArea { display: flex; padding: var(--padding); border-top: 1px solid var(--panel-border); background: rgba(0,0,0,0.2); gap: 12px; }
    #chatInput { flex: 1; padding: 12px 16px; border: 1px solid var(--panel-border); background: rgba(0,0,0,0.3); color: var(--text-primary); border-radius: 8px; transition: all 0.2s; }
    #chatInput:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 10px var(--accent-glow); }
    #chatSend { padding: 12px 20px; border: none; background: var(--accent-gold); color: #050507; font-weight: 700; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; }
    #chatSend:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px var(--accent-glow); }
    #chatSend:disabled { opacity: 0.5; cursor: not-allowed; }

    .error-message {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        font-size: 14px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .floating-panel {
            width: calc(100vw - 40px) !important;
            max-width: none !important;
            left: 20px !important;
            right: 20px !important;
        }
        
        .header-title h1 { font-size: 16px; }
        .header-title h2 { font-size: 12px; }
        
        #controlDock {
            bottom: 10px;
            height: 60px;
        }
        
        .dock-btn {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
    }
</style>
</head>
<body>

<header class="main-header">
    <div id="header-globe"></div>
    <div class="header-title">
        <h1>Global Air Quality Intelligence Platform</h1>
        <h2>Group 62 Tsinghua University IEDE Program - AI Driven Environmental Monitor for the Green Economy</h2>
    </div>
</header>

<div class="map-status">
    <span class="status-dot loading" id="statusDot"></span>
    <span id="statusText">Loading map services...</span>
</div>

<div id="viewDiv">
    <div id="loading">
        <div>Initializing Global Intelligence Platform...</div>
        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">Loading environmental data systems</div>
    </div>
    
    <!-- Fallback Map -->
    <div id="fallbackMap" style="display: none;">
        <svg class="world-svg" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
            <!-- World Map SVG Path -->
            <path d="M158 206c4-3 11 1 22-1 8-3 28-10 36-11 7 0 17 4 23 1 5-2 5-9 13-10 4 0 8 2 12 1 6-1 11-6 17-5 8 1 13 10 21 9 6-1 9-7 16-7 9 0 16 8 26 7 7-1 12-6 19-6 11 0 20 11 32 9 8-1 14-8 23-7 12 1 21 14 34 12 9-1 16-10 26-8 13 2 23 17 37 15 10-1 18-12 29-9 14 3 24 20 39 17 11-2 19-15 31-11 15 4 26 23 42 19 12-3 21-18 34-13 16 5 28 26 45 21 13-4 23-21 37-15 17 6 30 29 48 23 14-5 25-24 40-17 18 7 32 32 51 25 15-6 27-27 43-19 19 8 34 35 54 27 16-7 29-30 46-21 20 9 36 38 57 29 17-8 31-33 49-23 21 10 38 41 60 31 18-9 33-36 52-25 22 11 40 44 63 33 19-10 35-39 55-27 23 12 42 47 66 35 20-11 37-42 58-29 24 13 44 50 69 37 21-12 39-45 61-31 25 14 46 53 72 39 22-13 41-48 64-33 26 15 48 56 75 41 23-14 43-51 67-35 27 16 50 59 78 43 24-15 45-54 70-37 28 17 52 62 81 45 25-16 47-57 73-39 29 18 54 65 84 47 26-17 49-60 76-41 30 19 56 68 87 49 27-18 51-63 79-43 31 20 58 71 90 51 28-19 53-66 82-45 32 21 60 74 93 53 29-20 55-69 85-47 33 22 62 77 96 55 30-21 57-72 88-49 34 23 64 80 99 57 31-22 59-75 91-51 35 24 66 83 102 59 32-23 61-78 94-53 36 25 68 86 105 61 33-24 63-81 97-55 37 26 70 89 108 63 34-25 65-84 100-57 38 27 72 92 111 65 35-26 67-87 103-59 39 28 74 95 114 67 36-27 69-90 106-61 40 29 76 98 117 69 37-28 71-93 109-63 41 30 78 101 120 71 38-29 73-96 112-65 42 31 80 104 123 73 39-30 75-99 115-67 43 32 82 107 126 75 40-31 77-102 118-69 44 33 84 110 129 77 41-32 79-105 121-71 45 34 86 113 132 79 42-33 81-108 124-73 46 35 88 116 135 81 43-34 83-111 127-75 47 36 90 119 138 83 44-35 85-114 130-77 48 37 92 122 141 85 45-36 87-117 133-79 49 38 94 125 144 87 46-37 89-120 136-81 50 39 96 128 147 89 47-38 91-123 139-83 51 40 98 131 150 91 48-39 93-126 142-85 52 41 100 134 153 93 49-40 95-129 145-87 53 42 102 137 156 95 50-41 97-132 148-89 54 43 104 140 159 97 51-42 99-135 151-91 55 44 106 143 162 99 52-43 101-138 154-93 56 45 108 146 165 101 53-44 103-141 157-95 57 46 110 149 168 103 54-45 105-144 160-97 58 47 112 152 171 105 55-46 107-147 163-99 59 48 114 155 174 107 56-47 109-150 166-101 60 49 116 158 177 109 57-48 111-153 169-103 61 50 118 161 180 111 58-49 113-156 172-105 62 51 120 164 183 113 59-50 115-159 175-107 63 52 122 167 186 115 60-51 117-162 178-109 64 53 124 170 189 117 61-52 119-165 181-111 65 54 126 173 192 119 62-53 121-168 184-113 66 55 128 176 195 121 63-54 123-171 187-115 67 56 130 179 198 123 64-55 125-174 190-117 68 57 132 182 201 125 65-56 127-177 193-119 69 58 134 185 204 127 66-57 129-180 196-121 70 59 136 188 207 129 67-58 131-183 199-123 71 60 138 191 210 131z" 
                  fill="none" 
                  stroke="var(--accent-gold)" 
                  stroke-width="1" 
                  opacity="0.6"/>
            
            <!-- Simple world continents -->
            <g fill="var(--accent-gold)" opacity="0.3">
                <!-- North America -->
                <path d="M120 150 L160 140 L200 150 L220 180 L180 200 L140 190 Z"/>
                <!-- South America -->
                <path d="M180 220 L210 210 L230 250 L220 300 L200 320 L170 300 L160 260 Z"/>
                <!-- Europe -->
                <path d="M450 120 L500 110 L520 140 L480 160 L440 150 Z"/>
                <!-- Africa -->
                <path d="M480 180 L520 170 L540 220 L530 280 L500 320 L470 300 L460 240 Z"/>
                <!-- Asia -->
                <path d="M520 100 L700 90 L750 130 L720 180 L680 200 L520 190 Z"/>
                <!-- Australia -->
                <path d="M680 280 L720 275 L740 295 L710 315 L680 310 Z"/>
            </g>
        </svg>
        
        <!-- Air Quality Hotspots -->
        <div class="air-quality-overlay">
            <!-- Beijing -->
            <div class="pollution-hotspot high" style="top: 35%; left: 65%;"></div>
            <!-- Delhi -->
            <div class="pollution-hotspot severe" style="top: 40%; left: 60%;"></div>
            <!-- Los Angeles -->
            <div class="pollution-hotspot moderate" style="top: 45%; left: 15%;"></div>
            <!-- Mumbai -->
            <div class="pollution-hotspot high" style="top: 50%; left: 58%;"></div>
            <!-- Mexico City -->
            <div class="pollution-hotspot high" style="top: 50%; left: 18%;"></div>
            <!-- Sao Paulo -->
            <div class="pollution-hotspot moderate" style="top: 65%; left: 25%;"></div>
            <!-- Cairo -->
            <div class="pollution-hotspot high" style="top: 42%; left: 52%;"></div>
            <!-- Jakarta -->
            <div class="pollution-hotspot severe" style="top: 70%; left: 68%;"></div>
            <!-- London -->
            <div class="pollution-hotspot moderate" style="top: 30%; left: 46%;"></div>
            <!-- Sydney -->
            <div class="pollution-hotspot good" style="top: 80%; left: 75%;"></div>
        </div>
    </div>
</div>

<div id="uiContainer">
    <div class="floating-panel" id="panel-explorer" style="width: 380px; height: 500px; top: calc(var(--header-height) + 16px); left: 20px;">
        <div class="panel-header"> <span class="panel-icon">🔍</span> <span class="panel-title">Data Explorer</span> <div class="panel-controls"><button class="close-btn">×</button></div> </div>
        <div class="panel-content"> 
            <input class="search-input" id="searchInput" placeholder="Search any city worldwide..." /> 
            <button class="search-btn" id="searchBtn">Analyze Location</button> 
            <div id="googleAqiList" style="margin-top: 20px;">
                <div class="city-item" data-city="Beijing">
                    <strong>Beijing, China</strong><br>
                    PM2.5: <span style="color: #ff7e00;">45 μg/m³</span> - Moderate<br>
                    <small style="opacity: 0.7;">Last updated: 2 hours ago</small>
                </div>
                <div class="city-item" data-city="Delhi">
                    <strong>New Delhi, India</strong><br>
                    PM2.5: <span style="color: #ff0000;">112 μg/m³</span> - Unhealthy<br>
                    <small style="opacity: 0.7;">Last updated: 1 hour ago</small>
                </div>
                <div class="city-item" data-city="Los Angeles">
                    <strong>Los Angeles, USA</strong><br>
                    PM2.5: <span style="color: #ffff00;">22 μg/m³</span> - Moderate<br>
                    <small style="opacity: 0.7;">Last updated: 30 min ago</small>
                </div>
                <div class="city-item" data-city="Mumbai">
                    <strong>Mumbai, India</strong><br>
                    PM2.5: <span style="color: #ff0000;">89 μg/m³</span> - Unhealthy<br>
                    <small style="opacity: 0.7;">Last updated: 45 min ago</small>
                </div>
            </div>
        </div>
        <div class="panel-aurora"></div>
    </div>
        
    <div class="floating-panel" id="panel-critical" style="width: 360px; height: 450px; top: calc(var(--header-height) + 16px); right: 20px;">
        <div class="panel-header"> <span class="panel-icon">🏭</span> <span class="panel-title">Critical AQ Zones</span> <div class="panel-controls"><button class="close-btn">×</button></div> </div>
        <div class="panel-content" id="topCities">
            <div class="city-item">
                <strong>🔴 Lahore, Pakistan</strong><br>
                PM2.5: <span style="color: #7e0023;">186 μg/m³</span> - Hazardous<br>
                <small>Population at risk: 11M+ people</small>
            </div>
            <div class="city-item">
                <strong>🔴 Dhaka, Bangladesh</strong><br>
                PM2.5: <span style="color: #8f3f97;">134 μg/m³</span> - Very Unhealthy<br>
                <small>Population at risk: 9M+ people</small>
            </div>
            <div class="city-item">
                <strong>🟠 Jakarta, Indonesia</strong><br>
                PM2.5: <span style="color: #ff0000;">98 μg/m³</span> - Unhealthy<br>
                <small>Population at risk: 10M+ people</small>
            </div>
            <div class="city-item">
                <strong>🟡 Beijing, China</strong><br>
                PM2.5: <span style="color: #ff7e00;">45 μg/m³</span> - Moderate<br>
                <small>Population at risk: 21M+ people</small>
            </div>
            <div class="city-item">
                <strong>🟡 Mexico City, Mexico</strong><br>
                PM2.5: <span style="color: #ff7e00;">38 μg/m³</span> - Moderate<br>
                <small>Population at risk: 9M+ people</small>
            </div>
        </div>
        <div class="panel-aurora"></div>
    </div>
    
    <div class="floating-panel" id="panel-chat" style="width: 420px; height: 550px; bottom: 100px; left: 50%; transform: translateX(-50%);">
        <div class="panel-header"> <span class="panel-icon">💬</span> <span class="panel-title">AI Assistant</span> <div class="panel-controls"><button class="close-btn">×</button></div> </div>
        <div class="panel-content"> 
            <div id="chatMessages"> 
                <div class="message bot">Welcome to the Global Air Quality Intelligence Platform! I can help you understand air quality data from around the world. Try asking me about specific cities like "What's the air quality in Delhi?" or "Show me the cleanest cities."</div> 
            </div> 
            <div id="chatInputArea"> 
                <input id="chatInput" type="text" placeholder="Ask about air quality data..." /> 
                <button id="chatSend">Send</button> 
            </div> 
        </div>
        <div class="panel-aurora"></div>
    </div>

    <div class="floating-panel" id="panel-legend" style="width: 320px; height: auto; max-height: calc(100vh - var(--header-height) - 100px); top: calc(var(--header-height) + 480px); right: 20px;">
        <div class="panel-header"> <span class="panel-icon">🗺️</span> <span class="panel-title">Air Quality Index</span> <div class="panel-controls"><button class="close-btn">×</button></div> </div>
        <div class="panel-content">
            <div style="padding: 0;">
                <h4 style="margin-bottom: 16px; color: var(--text-primary); font-size: 16px;">PM2.5 Concentration (μg/m³)</h4>
                
                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(0, 228, 0, 0.1);">
                    <div style="width: 16px; height: 16px; background: #00e400; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #00e400;">Good (0-12)</strong><br>
                        <small style="opacity: 0.8;">Air quality is satisfactory</small>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(255, 255, 0, 0.1);">
                    <div style="width: 16px; height: 16px; background: #ffff00; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #ffff00;">Moderate (12-35)</strong><br>
                        <small style="opacity: 0.8;">Sensitive people may experience symptoms</small>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(255, 126, 0, 0.1);">
                    <div style="width: 16px; height: 16px; background: #ff7e00; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #ff7e00;">Unhealthy for Sensitive (35-55)</strong><br>
                        <small style="opacity: 0.8;">Sensitive groups should limit outdoor exposure</small>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(255, 0, 0, 0.1);">
                    <div style="width: 16px; height: 16px; background: #ff0000; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #ff0000;">Unhealthy (55-150)</strong><br>
                        <small style="opacity: 0.8;">Everyone may experience health effects</small>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(143, 63, 151, 0.1);">
                    <div style="width: 16px; height: 16px; background: #8f3f97; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #8f3f97;">Very Unhealthy (150-250)</strong><br>
                        <small style="opacity: 0.8;">Health warnings of emergency conditions</small>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; padding: 8px; border-radius: 6px; background: rgba(126, 0, 35, 0.1);">
                    <div style="width: 16px; height: 16px; background: #7e0023; border-radius: 50%; margin-right: 12px;"></div>
                    <div>
                        <strong style="color: #7e0023;">Hazardous (250+)</strong><br>
                        <small style="opacity: 0.8;">Emergency conditions, avoid all outdoor activity</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-aurora"></div>
    </div>
</div>

<div id="controlDock">
    <button class="dock-btn active" data-panel="panel-explorer" title="Data Explorer">🔍</button>
    <button class="dock-btn active" data-panel="panel-critical" title="Critical AQ Zones">🏭</button>
    <button class="dock-btn" data-panel="panel-chat" title="AI Assistant">💬</button>
    <button class="dock-btn active" data-panel="panel-legend" title="Legend">🗺️</button>
</div>

<script>
    // Initialize status tracking
    let mapStatus = 'loading';
    let loadAttempts = 0;
    const MAX_ATTEMPTS = 2;

    function updateStatus(status, text) {
        mapStatus = status;
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        dot.className = `status-dot ${status}`;
        statusText.textContent = text;
    }

    // Initialize 3D Globe
    document.addEventListener('DOMContentLoaded', () => {
        try {
            if (window.VANTA && window.THREE) {
                VANTA.GLOBE({
                    el: "#header-globe",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: 0xffd700,
                    color2: 0xffffff,
                    backgroundColor: 0x0C0C12,
                    size: 0.8
                });
            }
        } catch (error) {
            console.warn('Globe initialization failed:', error);
        }
    });

    // Dynamic Panel Management
    function initializeUI() {
        const panels = document.querySelectorAll('.floating-panel');
        const dockBtns = document.querySelectorAll('.dock-btn');
        let activePanel = null;
        let highestZ = 15;

        function setActive(panel) {
            if (activePanel) activePanel.classList.remove('active');
            if (panel) {
                highestZ++;
                panel.style.zIndex = highestZ;
                panel.classList.add('active');
            }
            activePanel = panel;
        }
        
        panels.forEach(panel => {
            const header = panel.querySelector('.panel-header');
            const closeBtn = panel.querySelector('.close-btn');
            const dockBtn = document.querySelector(`.dock-btn[data-panel="${panel.id}"]`);
            
            // Show default panels
            if (dockBtn && dockBtn.classList.contains('active')) {
                panel.classList.add('visible');
            }

            // Drag functionality
            function onDrag({movementX, movementY}){
                const style = window.getComputedStyle(panel);
                const matrix = new DOMMatrix(style.transform);
                panel.style.left = `${parseInt(style.left) + matrix.m41 + movementX}px`;
                panel.style.top = `${parseInt(style.top) + matrix.m42 + movementY}px`;
                panel.style.transform = '';
            }

            header.addEventListener('mousedown', () => {
                setActive(panel);
                header.addEventListener('mousemove', onDrag);
            });

            document.addEventListener('mouseup', () => header.removeEventListener('mousemove', onDrag));
            panel.addEventListener('mousedown', () => setActive(panel));

            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    panel.classList.remove('visible');
                    if(dockBtn) dockBtn.classList.remove('active');
                });
            }
        });
        
        dockBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const panelId = btn.dataset.panel;
                const panel = document.getElementById(panelId);
                if (panel) {
                    btn.classList.toggle('active');
                    panel.classList.toggle('visible');
                    if (panel.classList.contains('visible')) setActive(panel);
                }
            });
        });
    }

    // Enhanced Chat System
    function initializeChat() {
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        const airQualityData = {
            'beijing': { pm25: 45, status: 'Moderate', country: 'China', population: '21M' },
            'delhi': { pm25: 112, status: 'Unhealthy', country: 'India', population: '32M' },
            'mumbai': { pm25: 89, status: 'Unhealthy', country: 'India', population: '20M' },
            'los angeles': { pm25: 22, status: 'Moderate', country: 'USA', population: '4M' },
            'lahore': { pm25: 186, status: 'Hazardous', country: 'Pakistan', population: '11M' },
            'dhaka': { pm25: 134, status: 'Very Unhealthy', country: 'Bangladesh', population: '9M' },
            'jakarta': { pm25: 98, status: 'Unhealthy', country: 'Indonesia', population: '10M' },
            'mexico city': { pm25: 38, status: 'Moderate', country: 'Mexico', population: '9M' },
            'london': { pm25: 15, status: 'Moderate', country: 'UK', population: '9M' },
            'sydney': { pm25: 8, status: 'Good', country: 'Australia', population: '5M' }
        };

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        function getAirQualityResponse(userText) {
            const text = userText.toLowerCase();
            
            // Check for specific cities
            for (const [city, data] of Object.entries(airQualityData)) {
                if (text.includes(city)) {
                    return `${city.charAt(0).toUpperCase() + city.slice(1)}, ${data.country} currently has PM2.5 levels of ${data.pm25} μg/m³, which is classified as "${data.status}". The metropolitan area has approximately ${data.population} people potentially affected by this air quality level.`;
                }
            }
            
            // General queries
            if (text.includes('worst') || text.includes('most polluted') || text.includes('dangerous')) {
                return "The most polluted cities currently are Lahore (186 μg/m³), Dhaka (134 μg/m³), and Jakarta (98 μg/m³). These cities have hazardous to unhealthy air quality levels that pose serious health risks to residents.";
            } else if (text.includes('best') || text.includes('cleanest') || text.includes('good air')) {
                return "Cities with the best air quality include Sydney (8 μg/m³) and other locations shown in green on the map. These areas meet WHO air quality guidelines and are safe for all population groups.";
            } else if (text.includes('health') || text.includes('effects')) {
                return "High PM2.5 levels can cause respiratory problems, heart disease, and premature death. Sensitive groups include children, elderly, and people with lung/heart conditions. When PM2.5 exceeds 35 μg/m³, everyone should limit outdoor activities.";
            } else if (text.includes('who') || text.includes('guidelines')) {
                return "The WHO recommends annual PM2.5 levels below 5 μg/m³ and daily levels below 15 μg/m³. Many cities worldwide exceed these guidelines, sometimes by 10-20 times, creating significant public health challenges.";
            } else if (text.includes('help') || text.includes('what')) {
                return "I can provide information about air quality in major cities worldwide. Try asking about specific cities like 'What's the air quality in Delhi?' or general questions like 'Which cities have the worst air pollution?'";
            } else {
                return "I can help you understand global air quality patterns. Ask me about specific cities, health effects, or pollution trends. The data shows PM2.5 particle concentrations, which are one of the most harmful air pollutants.";
            }
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            addMessage(text, true);
            chatInput.value = '';
            chatInput.disabled = true;
            chatSend.disabled = true;
            
            const thinkingMsg = addMessage('Analyzing air quality data...', false);

            setTimeout(() => {
                const response = getAirQualityResponse(text);
                thinkingMsg.textContent = response;
                
                chatInput.disabled = false;
                chatSend.disabled = false;
                chatInput.focus();
            }, 800);
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', e => { 
            if (e.key === 'Enter') sendMessage(); 
        });
    }

    // Enhanced Search Functionality
    function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const cityItems = document.querySelectorAll('.city-item[data-city]');

        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) return;

            // Highlight matching cities
            cityItems.forEach(item => {
                const cityName = item.dataset.city.toLowerCase();
                if (cityName.includes(query)) {
                    item.style.background = 'rgba(255, 215, 0, 0.2)';
                    item.style.borderColor = 'var(--accent-gold)';
                    setTimeout(() => {
                        item.style.background = '';
                        item.style.borderColor = '';
                    }, 3000);
                }
            });

            // Also send to chat
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `What's the air quality in ${query}?`;
            document.getElementById('chatSend').click();
            
            // Open chat panel
            const chatPanel = document.getElementById('panel-chat');
            const chatBtn = document.querySelector('.dock-btn[data-panel="panel-chat"]');
            if (chatPanel && chatBtn) {
                chatPanel.classList.add('visible');
                chatBtn.classList.add('active');
            }
        }

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') performSearch();
        });

        // City item interactions
        cityItems.forEach(item => {
            item.addEventListener('click', () => {
                const cityName = item.dataset.city;
                const chatInput = document.getElementById('chatInput');
                chatInput.value = `Tell me about air quality in ${cityName}`;
                document.getElementById('chatSend').click();
                
                // Open chat panel
                const chatPanel = document.getElementById('panel-chat');
                const chatBtn = document.querySelector('.dock-btn[data-panel="panel-chat"]');
                if (chatPanel && chatBtn) {
                    chatPanel.classList.add('visible');
                    chatBtn.classList.add('active');
                }
            });
        });
    }

    // Map Loading with Fallback
    function initializeMap() {
        loadAttempts++;
        updateStatus('loading', `Loading map services... (Attempt ${loadAttempts})`);

        // Try to load ArcGIS first
        const script = document.createElement('script');
        script.src = 'https://js.arcgis.com/4.29/';
        script.onload = () => loadArcGISMap();
        script.onerror = () => useFallbackMap();
        
        // Timeout fallback
        setTimeout(() => {
            if (mapStatus === 'loading') {
                useFallbackMap();
            }
        }, 10000);
        
        document.head.appendChild(script);
    }

    function loadArcGISMap() {
        try {
            require([
                "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer"
            ], function(Map, MapView, FeatureLayer) {
                
                const map = new Map({ basemap: "satellite" });
                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [105, 35],
                    zoom: 3,
                    ui: { components: ["attribution"] }
                });

                view.when(() => {
                    document.getElementById("loading").style.display = "none";
                    updateStatus('online', 'Live map data loaded');
                    console.log('ArcGIS map loaded successfully');
                }).catch(() => {
                    useFallbackMap();
                });

            }, () => {
                useFallbackMap();
            });
        } catch (error) {
            useFallbackMap();
        }
    }

    function useFallbackMap() {
        console.log('Using fallback map visualization');
        document.getElementById("loading").style.display = "none";
        document.getElementById("fallbackMap").style.display = "flex";
        updateStatus('offline', 'Using offline map visualization');
        
        // Animate pollution hotspots
        const hotspots = document.querySelectorAll('.pollution-hotspot');
        hotspots.forEach((spot, index) => {
            setTimeout(() => {
                spot.style.animationDelay = `${index * 0.2}s`;
            }, index * 200);
        });
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        initializeUI();
        initializeChat();
        initializeSearch();
        
        // Start map loading after a short delay
        setTimeout(() => {
            initializeMap();
        }, 1000);
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        // Adjust panel positions for mobile
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.floating-panel').forEach(panel => {
                if (panel.classList.contains('visible')) {
                    panel.style.left = '20px';
                    panel.style.right = '20px';
                    panel.style.width = 'calc(100vw - 40px)';
                }
            });
        }
    });

    // Global error handling
    window.addEventListener('error', (e) => {
        console.warn('Error caught:', e.error?.message);
        if (mapStatus === 'loading' && e.error?.message?.includes('esri')) {
            useFallbackMap();
        }
    });
</script>

</body>
</html>