<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Global Air Quality Intelligence Platform</title>
<link href="https://js.arcgis.com/4.29/esri/themes/light/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/">
// === ULTRA LUXURY ENHANCEMENTS ===
(function(){
  if (window.__luxuryEnhancementsApplied) return;
  window.__luxuryEnhancementsApplied = true;

  // Entrance animation for cards and headers
  requestAnimationFrame(() => {
    document.querySelectorAll('.section-card').forEach((el, i) => {
      el.style.animationDelay = (i * 90) + 'ms';
      el.classList.add('lux-enter');
    });
  });

  // Mascot parallax tilt (non-intrusive)
  const mascot = document.getElementById('mascotBtn');
  if (mascot){
    const reset = () => mascot.style.transform = '';
    mascot.addEventListener('mousemove', (e) => {
      const r = mascot.getBoundingClientRect();
      const x = (e.clientX - (r.left + r.width/2)) / r.width;
      const y = (e.clientY - (r.top + r.height/2)) / r.height;
      mascot.style.transform = `rotateX(${(-y*6).toFixed(2)}deg) rotateY(${(x*6).toFixed(2)}deg) scale(1.05)`;
    });
    mascot.addEventListener('mouseleave', reset);
    mascot.addEventListener('dragend', reset);
  }

  // Animated counters (requires window.pm25Layer / window.googleAqiData / window.fireLayer)
  function animateNumber(el, to, duration=1200){
    if (!el) return;
    const from = 0;
    const start = performance.now();
    function frame(t){
      const p = Math.min(1, (t - start) / duration);
      const val = Math.floor(from + (to - from) * (0.5 - 0.5*Math.cos(Math.PI*p))); // ease-in-out
      el.textContent = val.toLocaleString();
      if (p < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  function updateCounters(){
    const stationsEl = document.querySelector('[data-stat="stations"]');
    const citiesEl = document.querySelector('[data-stat="cities"]');
    const firesEl = document.querySelector('[data-stat="fires"]');

    try{
      if (stationsEl && window.pm25Layer && typeof window.pm25Layer.queryFeatureCount === 'function'){
        window.pm25Layer.queryFeatureCount().then(c => animateNumber(stationsEl, c || 0));
      }
      if (citiesEl){
        const n = (window.googleAqiData && Array.isArray(window.googleAqiData.features)) ? window.googleAqiData.features.length : 0;
        animateNumber(citiesEl, n);
      }
      if (firesEl && window.fireLayer && typeof window.fireLayer.queryFeatureCount === 'function'){
        window.fireLayer.queryFeatureCount().then(c => animateNumber(firesEl, c || 0));
      }
    }catch(e){ /* silent */ }
  }

  setTimeout(updateCounters, 2500);
  setInterval(updateCounters, 5 * 60 * 1000); // refresh every 5 min

})();

</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        /* Premium Color Palette */
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4338ca 100%);
        --secondary-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #f093fb 100%);
        --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #667eea 100%);
        --luxury-gold: linear-gradient(135deg, #f6d365 0%, #fda085 50%, #d4af37 100%);
        --premium-purple: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #d299c2 100%);
        
        /* Sophisticated Surfaces */
        --surface-primary: rgba(15, 18, 28, 0.98);
        --surface-secondary: rgba(20, 25, 38, 0.95);
        --surface-tertiary: rgba(25, 30, 45, 0.92);
        --surface-elevated: rgba(30, 35, 50, 0.9);
        --surface-glass: rgba(255, 255, 255, 0.03);
        --surface-glass-hover: rgba(255, 255, 255, 0.08);
        --surface-glass-active: rgba(255, 255, 255, 0.12);
        
        /* Premium Text Colors */
        --text-primary: #ffffff;
        --text-secondary: #e2e8f0;
        --text-tertiary: #cbd5e1;
        --text-muted: #94a3b8;
        --text-subtle: #64748b;
        
        /* Elegant Borders & Shadows */
        --border-subtle: rgba(255, 255, 255, 0.06);
        --border-medium: rgba(255, 255, 255, 0.12);
        --border-strong: rgba(255, 255, 255, 0.20);
        --border-glow: rgba(79, 172, 254, 0.3);
        
        /* Luxury Shadows */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.12);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.18);
        --shadow-lg: 0 16px 64px rgba(0, 0, 0, 0.24);
        --shadow-xl: 0 32px 128px rgba(0, 0, 0, 0.32);
        --shadow-luxury: 0 40px 160px rgba(0, 0, 0, 0.4);
        
        /* Premium Radius */
        --radius-xs: 6px;
        --radius-sm: 10px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-xl: 32px;
        --radius-2xl: 40px;
        
        /* Typography Scale */
        --font-display: 'Inter', system-ui, -apple-system, sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        
        /* Animation Curves */
        --ease-luxury: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        --ease-spring: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100%;
        font-family: var(--font-display);
        background: radial-gradient(ellipse at top, rgba(15, 18, 28, 1) 0%, rgba(8, 10, 18, 1) 100%);
        overflow: hidden;
        color: var(--text-primary);
        font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Luxury Header Design */
    .header {
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.95) 0%, 
            rgba(118, 75, 162, 0.95) 30%, 
            rgba(67, 56, 202, 0.95) 70%, 
            rgba(30, 35, 50, 0.98) 100%);
        height: 88px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 40px;
        box-shadow: var(--shadow-lg);
        z-index: 1001;
        position: relative;
        backdrop-filter: blur(40px) saturate(180%);
        border-bottom: 1px solid var(--border-subtle);
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255,255,255,0.06) 25%, 
            rgba(255,255,255,0.12) 50%, 
            rgba(255,255,255,0.06) 75%, 
            transparent 100%);
        pointer-events: none;
        animation: shimmer 8s ease-in-out infinite;
    }

    @keyframes shimmer {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 32px;
    }

    .logo-section {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .logo-icon {
        width: 56px;
        height: 56px;
        background: var(--luxury-gold);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        backdrop-filter: blur(20px);
        border: 2px solid rgba(255, 255, 255, 0.15);
        box-shadow: var(--shadow-md);
        transition: transform 0.4s var(--ease-spring);
        position: relative;
        overflow: hidden;
    }

    .logo-icon::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: rotate(45deg);
        animation: logoShine 3s ease-in-out infinite;
    }

    @keyframes logoShine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
    }

    .logo-icon:hover {
        transform: scale(1.05) rotate(2deg);
    }

    .header-text h1 {
        font-size: 26px;
        font-weight: 800;
        margin-bottom: 4px;
        letter-spacing: -0.8px;
        background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1.1;
    }

    .header-text h2 {
        font-size: 15px;
        opacity: 0.85;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.75);
        letter-spacing: 0.2px;
        line-height: 1.3;
    }

    .header-actions {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .header-btn {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--text-primary);
        padding: 16px 24px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.4s var(--ease-luxury);
        font-weight: 600;
        font-size: 15px;
        backdrop-filter: blur(20px);
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: 0.3px;
        position: relative;
        overflow: hidden;
    }

    .header-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.6s ease;
    }

    .header-btn:hover::before {
        left: 100%;
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle, #10b981 0%, #059669 100%);
        border-radius: 50%;
        box-shadow: 0 0 16px rgba(16, 185, 129, 0.8);
        animation: luxuryPulse 3s ease-in-out infinite;
        position: relative;
    }

    .status-indicator::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.3) 0%, transparent 70%);
        animation: luxuryPulse 3s ease-in-out infinite reverse;
    }

    @keyframes luxuryPulse {
        0%, 100% { 
            opacity: 1; 
            transform: scale(1);
        }
        50% { 
            opacity: 0.6; 
            transform: scale(1.1);
        }
    }

    /* Premium Main Layout */
    #viewDiv {
        position: absolute;
        top: 88px;
        left: 0;
        right: 0;
        bottom: 0;
        transition: left 0.6s var(--ease-luxury);
    }

    #viewDiv.sidebar-open {
        left: 480px;
    }

    /* Luxury Sidebar with Advanced Glassmorphism */
    .sidebar {
        position: fixed;
        top: 88px;
        width: 480px;
        height: calc(100vh - 88px);
        background: linear-gradient(145deg, 
            var(--surface-primary) 0%, 
            var(--surface-secondary) 50%, 
            var(--surface-tertiary) 100%);
        backdrop-filter: blur(40px) saturate(180%);
        border-right: 1px solid var(--border-medium);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        left: -480px;
        transition: left 0.6s var(--ease-luxury);
        box-shadow: var(--shadow-luxury);
        position: relative;
    }

    .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(145deg, 
            rgba(255, 255, 255, 0.02) 0%, 
            rgba(255, 255, 255, 0.05) 50%, 
            rgba(255, 255, 255, 0.02) 100%);
        pointer-events: none;
        z-index: -1;
    }

    .sidebar.open {
        left: 0;
    }

    /* Premium Tab Navigation */
    .sidebar-tabs {
        display: flex;
        background: rgba(0, 0, 0, 0.15);
        border-bottom: 1px solid var(--border-subtle);
        padding: 12px;
        gap: 8px;
        backdrop-filter: blur(20px);
    }

    .tab-btn {
        flex: 1;
        padding: 18px 24px;
        background: transparent;
        border: none;
        color: var(--text-tertiary);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all 0.4s var(--ease-luxury);
        position: relative;
        overflow: hidden;
        letter-spacing: 0.2px;
    }

    .tab-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--accent-gradient);
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: -1;
        border-radius: var(--radius-sm);
    }

    .tab-btn::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 3px;
        background: var(--luxury-gold);
        transform: translateX(-50%);
        transition: width 0.4s var(--ease-luxury);
        border-radius: 2px;
    }

    .tab-btn:hover {
        color: var(--text-primary);
        background: var(--surface-glass-hover);
        transform: translateY(-1px);
    }

    .tab-btn.active {
        color: var(--text-primary);
        font-weight: 700;
        background: var(--surface-glass-active);
    }

    .tab-btn.active::before {
        opacity: 0.15;
    }

    .tab-btn.active::after {
        width: 60%;
    }

    /* Luxury Sidebar Content */
    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
        animation: fadeInUp 0.6s var(--ease-luxury);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Premium Card-based Sections */
    .section-card {
        background: linear-gradient(145deg, 
            var(--surface-glass) 0%, 
            rgba(255, 255, 255, 0.01) 50%, 
            var(--surface-glass) 100%);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 32px;
        margin-bottom: 32px;
        backdrop-filter: blur(20px);
        transition: all 0.4s var(--ease-luxury);
        position: relative;
        overflow: hidden;
    }

    .section-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--luxury-gold);
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .section-card:hover {
        border-color: var(--border-medium);
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
        background: linear-gradient(145deg, 
            var(--surface-glass-hover) 0%, 
            rgba(255, 255, 255, 0.03) 50%, 
            var(--surface-glass-hover) 100%);
    }

    .section-card:hover::before {
        opacity: 0.6;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .section-icon {
        width: 48px;
        height: 48px;
        background: var(--accent-gradient);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: var(--shadow-sm);
        transition: transform 0.3s var(--ease-spring);
    }

    .section-icon:hover {
        transform: scale(1.1) rotate(5deg);
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.4px;
        line-height: 1.2;
    }

    /* Enhanced Premium Search */
    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 20px 24px 20px 60px;
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.4s var(--ease-luxury);
        backdrop-filter: blur(20px);
        font-weight: 500;
        letter-spacing: 0.2px;
    }

    .search-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--border-glow);
        background: var(--surface-glass-hover);
        box-shadow: 0 0 0 6px rgba(79, 172, 254, 0.08), var(--shadow-md);
        transform: translateY(-2px);
    }

    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 20px;
        transition: color 0.3s ease;
    }

    .search-input:focus + .search-icon {
        color: #4facfe;
    }

    .search-btn {
        width: 100%;
        padding: 20px;
        background: var(--accent-gradient);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.4s var(--ease-luxury);
        margin-top: 16px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
    }

    .search-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s ease;
    }

    .search-btn:hover::before {
        left: 100%;
    }

    .search-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .search-btn:active {
        transform: translateY(-1px);
    }

    /* Luxury City Items */
    .cities-container {
        max-height: 360px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .city-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        margin-bottom: 12px;
        background: var(--surface-glass);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.4s var(--ease-luxury);
        position: relative;
        overflow: hidden;
    }

    .city-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--luxury-gold);
        transform: scaleY(0);
        transition: transform 0.3s var(--ease-spring);
    }

    .city-item:hover {
        background: var(--surface-glass-hover);
        border-color: var(--border-medium);
        transform: translateY(-2px) translateX(4px);
        box-shadow: var(--shadow-md);
    }

    .city-item:hover::before {
        transform: scaleY(1);
    }

    .city-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .city-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 15px;
        letter-spacing: 0.2px;
    }

    .city-details {
        font-size: 13px;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Premium AQI Tags */
    .tag {
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 800;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tag::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s ease;
    }

    .tag:hover::before {
        left: 100%;
    }

    .tag.good {
        background: linear-gradient(135deg, #10b981, #059669, #047857);
        color: white;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .tag.mod {
        background: linear-gradient(135deg, #f59e0b, #d97706, #b45309);
        color: white;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
    }

    .tag.bad {
        background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
        color: white;
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
    }

    /* Premium Statistics Dashboard */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--surface-glass);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 20px;
        text-align: center;
        transition: all 0.4s var(--ease-luxury);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-gradient);
        transform: scaleX(0);
        transition: transform 0.4s var(--ease-luxury);
    }

    .stat-card:hover {
        background: var(--surface-glass-hover);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .stat-card:hover::before {
        transform: scaleX(1);
    }

    .stat-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 6px;
        font-family: var(--font-mono);
        letter-spacing: -0.5px;
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-weight: 600;
    }

    /* Premium Settings */
    .settings-grid {
        display: grid;
        gap: 16px;
    }

    .basemap-option, .setting-option {
        background: var(--surface-glass);
        border: 2px solid var(--border-subtle);
        padding: 20px 24px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.4s var(--ease-luxury);
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: 0.2px;
        position: relative;
        overflow: hidden;
    }

    .basemap-option::before, .setting-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(79, 172, 254, 0.1), transparent);
        transition: left 0.6s ease;
    }

    .basemap-option:hover::before, .setting-option:hover::before {
        left: 100%;
    }

    .basemap-option:hover, .setting-option:hover {
        background: var(--surface-glass-hover);
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .basemap-option.active, .setting-option.active {
        background: linear-gradient(135deg, 
            rgba(79, 172, 254, 0.15) 0%, 
            rgba(0, 242, 254, 0.1) 100%);
        border-color: var(--border-glow);
        color: white;
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    /* Premium Flow Controls */
    .flow-type-btn {
        width: 100%;
        padding: 20px 24px;
        margin: 6px 0;
        background: var(--surface-glass);
        border: 2px solid var(--border-subtle);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.4s var(--ease-luxury);
        font-size: 15px;
        font-weight: 600;
        text-align: left;
        letter-spacing: 0.2px;
    }

    .flow-type-btn:hover {
        background: var(--surface-glass-hover);
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .flow-type-btn.active {
        background: var(--accent-gradient);
        border-color: var(--border-glow);
        color: white;
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .flow-control {
        margin: 20px 0;
    }

    .flow-control label {
        display: block;
        margin-bottom: 12px;
        font-size: 15px;
        color: var(--text-primary);
        font-weight: 600;
        letter-spacing: 0.2px;
    }

    .flow-control input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: linear-gradient(to right, 
            var(--border-subtle) 0%, 
            var(--border-medium) 50%, 
            var(--border-subtle) 100%);
        border-radius: 4px;
        outline: none;
        transition: all 0.3s ease;
    }

    .flow-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: var(--accent-gradient);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s var(--ease-spring);
        border: 2px solid white;
    }

    .flow-control input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: var(--shadow-md);
    }

    .flow-control-value {
        font-weight: 800;
        color: #4facfe;
        font-family: var(--font-mono);
    }

    .preset-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .preset-btn {
        flex: 1;
        padding: 16px 20px;
        background: var(--surface-glass);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.4s var(--ease-luxury);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .preset-btn:hover {
        background: var(--surface-glass-hover);
        transform: translateY(-2px);
    }

    .preset-btn.active {
        background: var(--accent-gradient);
        border-color: #4facfe;
        color: white;
        box-shadow: var(--shadow-sm);
    }

    #flowInfo {
        background: var(--surface-secondary);
        padding: 20px;
        border-radius: var(--radius-md);
        margin: 20px 0;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-secondary);
        border: 1px solid var(--border-subtle);
    }

    #flowInfo strong {
        color: #4facfe;
        font-weight: 700;
    }

    .notes {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.8;
        padding: 0 8px;
    }

    .notes li {
        margin-left: 20px;
        margin-bottom: 8px;
        font-weight: 500;
    }

    #status {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.8;
        padding: 8px;
        font-weight: 500;
    }

    /* Premium Layer Controls */
    .layer-control {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid var(--border-subtle);
        transition: all 0.3s ease;
    }

    .layer-control:hover {
        padding-left: 8px;
    }

    .layer-control:last-child {
        border-bottom: none;
    }

    .layer-control label {
        display: flex;
        align-items: center;
        cursor: pointer;
        gap: 12px;
        font-size: 15px;
        color: var(--text-primary);
        font-weight: 600;
        letter-spacing: 0.2px;
    }

    .layer-control input {
        width: 20px;
        height: 20px;
        accent-color: #4facfe;
        cursor: pointer;
    }

    /* Premium Loading States */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        gap: 20px;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border-subtle);
        border-top: 4px solid #4facfe;
        border-radius: 50%;
        animation: luxurySpin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    }

    @keyframes luxurySpin {
        0% { transform: rotate(0deg) scale(1); }
        50% { transform: rotate(180deg) scale(1.1); }
        100% { transform: rotate(360deg) scale(1); }
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.3px;
    }

    /* Luxury Mascot and Chat Interface */
    #mascotContainer {
        position: fixed;
        z-index: 2000;
        left: calc(100% - 140px);
        top: calc(100% - 160px);
        user-select: none;
    }

    #mascotBtn {
        background: none;
        border: none;
        padding: 0;
        cursor: move;
        display: block;
        transition: all 0.4s var(--ease-spring);
        filter: drop-shadow(var(--shadow-lg));
        border-radius: 50%;
        overflow: hidden;
    }

    #mascotBtn:hover {
        transform: scale(1.08) rotate(2deg);
        filter: drop-shadow(var(--shadow-xl));
    }

    #mascotBtn.dragging {
        cursor: grabbing;
        transform: scale(1.15) rotate(5deg);
    }

    #mascotBtn img {
        width: 188px;
        height: 188px;
        display: block;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.1);
    }

    #chatBubble {
        position: absolute;
        display: flex;
        width: 480px;
        height: 580px;
        background: linear-gradient(145deg, 
            var(--surface-primary) 0%, 
            var(--surface-secondary) 100%);
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-luxury);
        overflow: hidden;
        backdrop-filter: blur(40px) saturate(180%);
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transition: all 0.6s var(--ease-luxury);
        pointer-events: none;
    }

    #chatBubble.open {
        display: flex;
        transform: scale(1) translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    #chatBubble.left {
        right: 120px;
        top: -280px;
    }

    #chatBubble.left::after {
        content: "";
        position: absolute;
        right: -16px;
        top: 280px;
        width: 0;
        height: 0;
        border: 16px solid transparent;
        border-left-color: var(--surface-primary);
        filter: drop-shadow(2px 0 4px rgba(0,0,0,0.2));
    }

    #chatBubble.right {
        left: 120px;
        top: -280px;
    }

    #chatBubble.right::after {
        content: "";
        position: absolute;
        left: -16px;
        top: 280px;
        width: 0;
        height: 0;
        border: 16px solid transparent;
        border-right-color: var(--surface-primary);
        filter: drop-shadow(-2px 0 4px rgba(0,0,0,0.2));
    }

    #chatInterface {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
    }

    #chatHeader {
        background: var(--primary-gradient);
        color: white;
        padding: 24px 28px;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        font-size: 18px;
        letter-spacing: 0.3px;
    }

    #closeChat {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.3s var(--ease-luxury);
    }

    #closeChat:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: scale(1.1);
    }

    #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: linear-gradient(145deg, 
            var(--surface-secondary) 0%, 
            var(--surface-tertiary) 100%);
    }

    .message {
        padding: 16px 20px;
        border-radius: var(--radius-md);
        max-width: 85%;
        word-wrap: break-word;
        font-size: 15px;
        line-height: 1.6;
        font-weight: 500;
        animation: messageSlideIn 0.4s var(--ease-luxury);
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        align-self: flex-end;
        background: var(--accent-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .message.bot {
        align-self: flex-start;
        background: var(--surface-glass-hover);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
        backdrop-filter: blur(20px);
    }

    #chatInputArea {
        display: flex;
        padding: 24px;
        background: rgba(0, 0, 0, 0.15);
        border-top: 1px solid var(--border-subtle);
        gap: 16px;
        backdrop-filter: blur(20px);
    }

    #chatInput {
        flex: 1;
        padding: 16px 20px;
        border: 1px solid var(--border-subtle);
        background: var(--surface-glass);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        font-size: 15px;
        transition: all 0.3s var(--ease-luxury);
        font-weight: 500;
    }

    #chatInput::placeholder {
        color: var(--text-muted);
    }

    #chatInput:focus {
        outline: none;
        background: var(--surface-glass-hover);
        border-color: #4facfe;
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }

    #chatSend {
        padding: 16px 24px;
        border: none;
        background: var(--accent-gradient);
        color: white;
        font-weight: 700;
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: all 0.3s var(--ease-luxury);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 14px;
    }

    #chatSend:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    #chatSend:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Premium Scrollbars */
    .sidebar-content::-webkit-scrollbar,
    .cities-container::-webkit-scrollbar,
    #chatMessages::-webkit-scrollbar {
        width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track,
    .cities-container::-webkit-scrollbar-track,
    #chatMessages::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb,
    .cities-container::-webkit-scrollbar-thumb,
    #chatMessages::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, 
            rgba(79, 172, 254, 0.3) 0%, 
            rgba(0, 242, 254, 0.3) 100%);
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover,
    .cities-container::-webkit-scrollbar-thumb:hover,
    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, 
            rgba(79, 172, 254, 0.5) 0%, 
            rgba(0, 242, 254, 0.5) 100%);
    }

    /* Premium Map Overlays */
    #loading {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #667eea;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    #overlayStatus {
        position: absolute;
        top: 32px;
        right: 32px;
        z-index: 1002;
        background: linear-gradient(145deg, 
            var(--surface-primary) 0%, 
            var(--surface-secondary) 100%);
        backdrop-filter: blur(40px) saturate(180%);
        color: var(--text-primary);
        padding: 20px 28px;
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-weight: 600;
        border: 1px solid var(--border-medium);
        box-shadow: var(--shadow-lg);
        display: none;
        max-width: 360px;
        letter-spacing: 0.2px;
    }

    /* Responsive Design for Luxury */
    @media (max-width: 768px) {
        .sidebar {
            width: 100vw;
            left: -100vw;
        }

        .sidebar.open {
            left: 0;
        }

        #viewDiv.sidebar-open {
            left: 0;
        }

        .header {
            padding: 0 20px;
            height: 76px;
        }

        .header-text h1 {
            font-size: 20px;
        }

        .header-text h2 {
            font-size: 13px;
        }

        #chatBubble {
            width: calc(100vw - 32px);
            height: calc(100vh - 140px);
            bottom: 20px;
            right: 16px;
            position: fixed;
            top: auto !important;
            left: 16px !important;
        }

        #chatBubble.left, #chatBubble.right {
            right: 16px;
            left: 16px;
            top: auto;
            bottom: 20px;
        }

        #chatBubble::after {
            display: none;
        }
    }

    /* Custom Map Styling for Premium Look */
    .esri-legend {
        background: linear-gradient(145deg, 
            var(--surface-primary) 0%, 
            var(--surface-secondary) 100%) !important;
        backdrop-filter: blur(40px) saturate(180%) !important;
        border: 1px solid var(--border-medium) !important;
        border-radius: var(--radius-lg) !important;
        box-shadow: var(--shadow-lg) !important;
        color: var(--text-primary) !important;
    }

    .esri-legend__service-label,
    .esri-legend__layer-caption {
        color: var(--text-primary) !important;
        font-weight: 600 !important;
    }

    /* Additional Premium Touches */
    .section-card:nth-child(odd) {
        background: linear-gradient(145deg, 
            var(--surface-glass) 0%, 
            rgba(102, 126, 234, 0.02) 50%, 
            var(--surface-glass) 100%);
    }

    .section-card:nth-child(even) {
        background: linear-gradient(145deg, 
            var(--surface-glass) 0%, 
            rgba(79, 172, 254, 0.02) 50%, 
            var(--surface-glass) 100%);
    }

    /* Luxury hover effects for interactive elements */
    .city-item:hover .city-name {
        color: #4facfe;
        transition: color 0.3s ease;
    }

    .tag:hover {
        transform: translateY(-1px) scale(1.02);
        transition: transform 0.3s var(--ease-spring);
    }

    /* Premium focus states */
    *:focus-visible {
        outline: 2px solid rgba(79, 172, 254, 0.5);
        outline-offset: 2px;
        border-radius: 4px;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
/* === ULTRA LUXURY ADD-ONS (non-breaking) === */
:root{
  --lux-gold-foil: linear-gradient(135deg, #f9e6b3 0%, #e5c86d 35%, #b68a2a 65%, #f1d78a 100%);
  --lux-ink: #d1d5ff;
}
/* Animated premium heading */
.header-text h1{
  font-family: "Playfair Display", serif;
  letter-spacing: -0.6px;
  background: linear-gradient(90deg, #ffffff, #f7f3da, #e7d188, #ffffff);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: luxTitleShimmer 18s linear infinite;
}
@keyframes luxTitleShimmer{
  0%{ background-position: 0% 50%; }
  50%{ background-position: 100% 50%; }
  100%{ background-position: 0% 50%; }
}

/* Backdrop premium glow layer */
#luxuryBackdrop{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 500; /* below header (1001), above map default */
  background:
    radial-gradient(1200px 700px at 10% -10%, rgba(102,126,234,0.08), transparent 60%),
    radial-gradient(1000px 600px at 110% 120%, rgba(212,175,55,0.07), transparent 60%),
    radial-gradient(800px 500px at 50% 120%, rgba(79,172,254,0.05), transparent 60%);
  mix-blend-mode: screen;
}
/* Soft moving light sheen */
#luxuryBackdrop::before{
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(1000px 600px at var(--x,30%) var(--y,20%), rgba(255,255,255,0.08), transparent 60%);
  animation: floatGlow 20s ease-in-out infinite alternate;
}
@keyframes floatGlow{
  0%{ --x: 30%; --y: 20%; opacity: 0.7; }
  50%{ --x: 70%; --y: 50%; opacity: 0.9; }
  100%{ --x: 40%; --y: 70%; opacity: 0.75; }
}

/* Entrance motion for cards/sections */
.lux-enter{
  opacity: 0;
  transform: translateY(14px) scale(0.995);
  animation: luxEnter 700ms var(--ease-luxury) forwards;
}
@keyframes luxEnter{
  to{ opacity: 1; transform: translateY(0) scale(1); }
}

/* Deluxe stat badges */
.stat-card .stat-value{
  background: var(--lux-gold-foil);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 20px rgba(212,175,55,0.15);
}

/* Mascot 3D tilt illusion */
#mascotBtn{
  transform-style: preserve-3d;
  will-change: transform;
}

/* Typing indicator (can be reused by backend) */
.typing{
  display: inline-flex; gap: 6px; align-items: center;
}
.typing .dot{
  width: 6px; height: 6px; border-radius: 50%;
  background: rgba(255,255,255,0.8);
  animation: bounce 1.2s ease-in-out infinite;
}
.typing .dot:nth-child(2){ animation-delay: .15s; }
.typing .dot:nth-child(3){ animation-delay: .3s; }
@keyframes bounce{
  0%, 80%, 100%{ transform: translateY(0); opacity: 0.6;}
  40%{ transform: translateY(-6px); opacity: 1; }
}
</style>

</head>
<body>
<div id="luxuryBackdrop" aria-hidden="true"></div>

<div class="header">
    <div class="header-left">
        <button class="header-btn" id="sidebarBtn" title="Toggle Control Panel">
            <span>☰</span>
            <span>Controls</span>
        </button>
        <div class="logo-section">
            <div class="logo-icon">🌍</div>
            <div class="header-text">
                <h1>Global Air Quality Intelligence Platform</h1>
                <h2>AI-Driven Environmental Monitoring for a Green Economy</h2>
            </div>
        </div>
    </div>
    <div class="header-actions">
        <div class="header-btn">
            <div class="status-indicator"></div>
            <span>Live Data</span>
        </div>
    </div>
</div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-tabs">
        <button class="tab-btn active" data-tab="data">📊 Data Explorer</button>
        <button class="tab-btn" data-tab="settings">⚙️ Configuration</button>
    </div>
    
    <div class="sidebar-content">
        <div class="tab-panel active" id="dataPanel">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🔍</div>
                    <div class="section-title">Location Intelligence</div>
                </div>
                <div class="search-container">
                    <input class="search-input" id="searchInput" placeholder="Search any city worldwide..." />
                    <div class="search-icon">🔍</div>
                </div>
                <button class="search-btn" id="searchBtn">Analyze Location</button>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🏭</div>
                    <div class="section-title">Critical Air Quality Zones</div>
                </div>
                <div class="cities-container" id="topCities">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading critical zones...</div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🌍</div>
                    <div class="section-title">Google AQI Network</div>
                </div>
                <div class="cities-container" id="googleAqiList">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Connecting to Google AQI...</div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">📈</div>
                    <div class="section-title">Data Sources</div>
                </div>
                <ul class="notes">
                    <li>Live stations: OpenAQ via Esri Living Atlas</li>
                    <li>World cities: Major cities worldwide</li>
                    <li>Regional AQI: Google Air Quality API</li>
                    <li>Ocean currents: Global ocean circulation (animated)</li>
                    <li>Fire data: NASA VIIRS thermal hotspots (24hr)</li>
                </ul>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
                    <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">System Status</div>
                    <div id="status">Initializing connections...</div>
                </div>
            </div>
        </div>


            <div class="section-card" id="globalSnapshot">
                <div class="section-header">
                    <div class="section-icon">💎</div>
                    <div class="section-title">Global Snapshot</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" data-stat="stations">0</div>
                        <div class="stat-label">Live Stations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" data-stat="cities">0</div>
                        <div class="stat-label">Cities Monitored</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" data-stat="fires">0</div>
                        <div class="stat-label">Active Fires (24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">🌊</div>
                        <div class="stat-label">Ocean Currents</div>
                    </div>
                </div>
            </div>


        <div class="tab-panel" id="settingsPanel">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🗺️</div>
                    <div class="section-title">Map Visualization</div>
                </div>
                <div class="settings-grid">
                    <div class="basemap-option active" data-basemap="satellite">Satellite Imagery</div>
                    <div class="basemap-option" data-basemap="streets">Street Map</div>
                    <div class="basemap-option" data-basemap="hybrid">Hybrid View</div>
                    <div class="basemap-option" data-basemap="terrain">Terrain</div>
                    <div class="basemap-option" data-basemap="dark-gray">Dark Theme</div>
                    <div class="basemap-option" data-basemap="topo">Topographic</div>
                    <div class="basemap-option" data-basemap="gray">Light Gray</div>
                    <div class="basemap-option" data-basemap="oceans">Ocean View</div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">📊</div>
                    <div class="section-title">Data Layer Controls</div>
                </div>
                <div class="layer-control">
                    <label><span>PM2.5 Stations (OpenAQ)</span></label>
                    <input checked type="checkbox" id="layerAQI"/>
                </div>
                <div class="layer-control">
                    <label><span>Cities (Google AQI)</span></label>
                    <input checked type="checkbox" id="layerGoogleAQI"/>
                </div>
                <div class="layer-control">
                    <label><span>🌊 Flow Animation (Active)</span></label>
                    <input checked type="checkbox" id="layerFlow"/>
                </div>
                <div class="layer-control">
                    <label><span>🔥 Active Fire Hotspots</span></label>
                    <input checked type="checkbox" id="layerFire"/>
                </div>
                <div class="layer-control">
                    <label><span>World Cities</span></label>
                    <input checked type="checkbox" id="layerCities"/>
                </div>
                <div class="layer-control">
                    <label><span>Legend</span></label>
                    <input checked type="checkbox" id="layerLegend"/>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🔥</div>
                    <div class="section-title">Fire Intensity Filter</div>
                </div>
                <div class="flow-control">
                    <label>Minimum Brightness (K): <span class="flow-control-value" id="brightnessValue">365</span></label>
                    <input type="range" id="brightnessSlider" min="365" max="500" value="365" step="5">
                    <div style="font-size: 13px; color: var(--text-muted); margin-top: 12px; line-height: 1.6; font-weight: 500;">
                        Adjust to show only fires above a certain intensity. Higher values focus on more significant fires.
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">🎮</div>
                    <div class="section-title">Animation Settings</div>
                </div>
                <div class="flow-control">
                    <label>Flow Speed: <span class="flow-control-value" id="speedValue">6</span></label>
                    <input type="range" id="windSpeed" min="1" max="20" value="6">
                </div>
                <div class="flow-control">
                    <label>Density: <span class="flow-control-value" id="densityValue">0.7</span></label>
                    <input type="range" id="windDensity" min="0.1" max="1" step="0.1" value="0.7">
                </div>
                <div class="flow-control">
                    <label>Trail Length: <span class="flow-control-value" id="trailValue">120</span></label>
                    <input type="range" id="windTrail" min="50" max="300" value="120">
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setWindPreset('subtle')">Subtle</button>
                    <button class="preset-btn active" onclick="setWindPreset('normal')">Normal</button>
                    <button class="preset-btn" onclick="setWindPreset('intense')">Intense</button>
                </div>
            </div>
        </div>
    </div>
</aside>

<div id="viewDiv">
    <div id="loading">Loading map...</div>
    <div id="overlayStatus"></div>
</div>

<div id="mascotContainer">
    <button id="mascotBtn" title="Click to chat with AQI Assistant">
        <img src="mascot.png" alt="AQI Warrior mascot" />
    </button>
    <div id="chatBubble" class="left">
        <div id="chatInterface">
            <div id="chatHeader">
                <span>🌍 AQI Assistant</span>
                <button id="closeChat" title="Close chat">×</button>
            </div>
            <div id="chatMessages">
                <div class="message bot">Hi! I'm your AQI Assistant. Ask me about air quality anywhere in the world. Try: "What's the PM2.5 in Beijing?" or "Show me the most polluted cities."</div>
            </div>
            <div id="chatInputArea">
                <input id="chatInput" type="text" placeholder="Ask about air quality..." />
                <button id="chatSend">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    require([
      "esri/Map","esri/views/MapView",
      "esri/layers/FeatureLayer","esri/layers/GeoJSONLayer",
      "esri/layers/ImageryLayer","esri/layers/MapImageLayer",
      "esri/layers/ImageryTileLayer","esri/renderers/FlowRenderer",
      "esri/widgets/Legend","esri/config"
    ], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryLayer, MapImageLayer, ImageryTileLayer, FlowRenderer, Legend, esriConfig) {

      let googleAqiLayer = null;
      let googleAqiData = null;
      let fireLayer = null;
      let flowLayer = null;

      const fireBaseDefinition = "ACQ_DATE >= CURRENT_DATE - 1";

      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map, center: [105, 35], zoom: 4,
        popup: { dockEnabled: true, dockOptions:{ buttonEnabled: false, breakpoint: false, position: "bottom-right" } }
      });

      try { esriConfig.request.corsEnabledServers.push(window.location.origin); } catch(e) {}

      const toast = (msg, ms = 2200) => {
        const el = document.getElementById("overlayStatus");
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(el._t);
        el._t = setTimeout(() => el.style.display = "none", ms);
      };
      
      const pm25ClusterConfig = {
        type: "cluster",
        clusterRadius: "80px",
        popupTemplate: {
          title: "Cluster Summary",
          content: "This cluster represents <b>{cluster_count}</b> stations with an average PM2.5 value of <b>{cluster_avg_value}</b> µg/m³.",
          fieldInfos: [{
            fieldName: "cluster_count", format: { places: 0, digitSeparator: true }
          }, {
            fieldName: "cluster_avg_value", format: { places: 1, digitSeparator: true }
          }]
        },
        clusterMinSize: "20px",
        clusterMaxSize: "50px",
        labelingInfo: [{
          deconflictionStrategy: "none",
          labelExpressionInfo: { expression: "Text($feature.cluster_count, '#,###')" },
          symbol: { type: "text", color: "#000", font: { weight: "bold", family: "Inter", size: "12px" } },
          labelPlacement: "center-center",
        }],
        summaryStatistics: [{
            onStatisticField: "value",
            outStatisticFieldName: "cluster_avg_value",
            statisticType: "avg"
        }]
      };

      function createGoogleAqiLayer(geoJsonData) {
        const blob = new Blob([JSON.stringify(geoJsonData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        return new GeoJSONLayer({
          url: url,
          title: "Cities (Google AQI)",
          copyright: "© Google Air Quality API - Live Data",
          featureReduction: {
            type: "cluster",
            clusterRadius: "80px",
            popupTemplate: {
                title: "Cluster Summary",
                content: "This cluster represents <b>{cluster_count}</b> cities with an average AQI of <b>{cluster_avg_aqi}</b>.",
                fieldInfos: [
                    { fieldName: "cluster_count", format: { places: 0, digitSeparator: true } },
                    { fieldName: "cluster_avg_aqi", format: { places: 0, digitSeparator: true } }
                ]
            },
            clusterMinSize: "20px",
            clusterMaxSize: "50px",
            labelingInfo: [{
                deconflictionStrategy: "none",
                labelExpressionInfo: { expression: "Text($feature.cluster_count, '#,###')" },
                symbol: { type: "text", color: "#ffffff", haloColor: "#000000", haloSize: "1px", font: { weight: "bold", family: "Inter", size: "12px" } },
                labelPlacement: "center-center",
            }],
            summaryStatistics: [{
                onStatisticField: "aqi",
                outStatisticFieldName: "cluster_avg_aqi",
                statisticType: "avg"
            }]
          },
          renderer: {
            type: "class-breaks",
            field: "aqi",
            classBreakInfos: [
              { minValue: 0, maxValue: 50, symbol: { type: "simple-marker", style: "triangle", size: 12, color: "#00e400", outline: { color: "#fff", width: 1.5 } }, label: "Good (0–50)" },
              { minValue: 51, maxValue: 100, symbol: { type: "simple-marker", style: "triangle", size: 14, color: "#ffff00", outline: { color: "#fff", width: 1.5 } }, label: "Moderate (51–100)" },
              { minValue: 101, maxValue: 150, symbol: { type: "simple-marker", style: "triangle", size: 16, color: "#ff7e00", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy for Sensitive (101–150)" },
              { minValue: 151, maxValue: 200, symbol: { type: "simple-marker", style: "triangle", size: 18, color: "#ff0000", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy (151–200)" },
              { minValue: 201, maxValue: 300, symbol: { type: "simple-marker", style: "triangle", size: 20, color: "#8f3f97", outline: { color: "#fff", width: 1.5 } }, label: "Very Unhealthy (201–300)" },
              { minValue: 301, maxValue: 9999, symbol: { type: "simple-marker", style: "triangle", size: 22, color: "#7e0023", outline: { color: "#fff", width: 1.5 } }, label: "Hazardous (300+)" }
            ]
          },
          popupTemplate: {
            title: "{name} - Google AQI",
            content: `<div style="line-height:1.5"><b>🌬️ US AQI:</b> <span style="font-size:18px;font-weight:bold;">{aqi}</span><br><b>📊 Category:</b> {category}<br><b>💨 Dominant Pollutant:</b> {main_pollutant}<br><b>🕒 Last Updated:</b> {time}<br><b>📍 Location:</b> {name}<br><b>📊 Data Source:</b> {source}</div>`
          }
        });
      }

      async function loadGoogleAqiData() {
        try {
          toast("Loading Google AQI data...", 3000);
          const response = await fetch('/.netlify/functions/google-aqi');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          googleAqiData = await response.json();
          window.googleAqiData = googleAqiData;
          if (googleAqiData.warning) console.warn("API Warning:", googleAqiData.warning);
          googleAqiLayer = createGoogleAqiLayer(googleAqiData);
          window.googleAqiLayer = googleAqiLayer;
          map.add(googleAqiLayer, 1);
          await googleAqiLayer.load();
          toast("✅ Google AQI data loaded!");
          updateStatus();
          updateLegend();
          updateGoogleAqiList(googleAqiData);
        } catch (error) {
          console.error("Failed to load Google AQI data:", error);
          toast("❌ Failed to load Google AQI data");
          document.getElementById("googleAqiList").innerHTML = `<div style="opacity:.85; color: #ffdddd; padding: 10px;">Failed to load.</div>`;
          updateStatus();
        }
      }
      
      function updateGoogleAqiList(geoJsonData) {
          const listElement = document.getElementById("googleAqiList");
          if (!geoJsonData || !geoJsonData.features || geoJsonData.features.length === 0) {
              listElement.innerHTML = '<div style="opacity:.85; padding: 10px;">No data available</div>';
              return;
          }
          const cities = geoJsonData.features.map(f => f.properties).sort((a, b) => b.aqi - a.aqi);
          const getAqiClass = aqi => aqi <= 50 ? "good" : aqi <= 100 ? "mod" : "bad";
          listElement.innerHTML = "";
          cities.forEach(city => {
              const row = document.createElement("div");
              row.className = "city-item";
              row.innerHTML = `
                  <div class="city-info">
                      <div class="city-name">${city.name}</div>
                      <div class="city-details">Google AQI Data</div>
                  </div>
                  <span class="tag ${getAqiClass(city.aqi)}">${city.aqi}</span>
              `;
              row.addEventListener("click", () => {
                  const feature = geoJsonData.features.find(f => f.properties.name === city.name);
                  if (feature) view.goTo({ center: feature.geometry.coordinates, zoom: 11 }, { duration: 1500 });
              });
              listElement.appendChild(row);
          });
      }

      const pm25Layer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
        title:"PM2.5 Stations (OpenAQ)", outFields:["*"],
        featureReduction: pm25ClusterConfig,
        popupTemplate:{ title:"{location} ({country_name})", content:`<div style="line-height:1.5"><b>City:</b> {city}<br><b>PM2.5:</b> {value} {unit}<br><b>Provider:</b> {provider_name}<br><b>Updated:</b> {lastUpdated}<br><a href="{url}" target="_blank" rel="noopener">Station link</a></div>` },
        renderer:{ type:"class-breaks", field:"value", classBreakInfos:[
          {minValue:0,maxValue:10,symbol:{type:"simple-marker",size:8,color:"#00e400",outline:{color:"#fff",width:1}},label:"Good (0–10)"},
          {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10,color:"#ffff00",outline:{color:"#fff",width:1}},label:"Moderate (10–25)"},
          {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12,color:"#ff7e00",outline:{color:"#fff",width:1}},label:"USG (25–50)"},
          {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14,color:"#ff0000",outline:{color:"#fff",width:1}},label:"Unhealthy (50–75)"},
          {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16,color:"#8f3f97",outline:{color:"#fff",width:1}},label:"Very Unhealthy (75–100)"},
          {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18,color:"#7e0023",outline:{color:"#fff",width:1}},label:"Hazardous (100+)"}
        ]}
      });
      map.add(pm25Layer);
      window.pm25Layer = pm25Layer;
      const citiesLayer = new FeatureLayer({
        url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
        title:"World Cities", definitionExpression:"POP > 100000",
        renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
        labelingInfo:[{ symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
          labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000 }],
        popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
      });
      map.add(citiesLayer);

      flowLayer = new ImageryTileLayer({
        url:"https://tiledimageservices.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Spilhaus_UV_ocean_currents/ImageServer",
        title:"Global Ocean Currents", opacity:0.8, visible:true,
        renderer: new FlowRenderer({
          type:"flow", density:0.7, flowSpeed:6, trailLength:120, trailWidth:"2px", maxPathLength:180,
          visualVariables:[{ type:"color", field:"Magnitude", stops:[
            {color:[30,100,150,0.6],value:0},{color:[50,150,200,0.7],value:0.1},{color:[100,200,255,0.8],value:0.3},
            {color:[150,255,200,0.9],value:0.6},{color:[255,255,100,1],value:1},{color:[255,100,100,1],value:1.5}
          ]}]
        }),
        popupTemplate:{ title:"🌊 Global Ocean Currents", content:`<div style="line-height:1.5"><b>🌊 Current Speed:</b> {Magnitude} m/s<br><b>🧭 Current Direction:</b> {Direction}°<br><b>📊 Data Source:</b> Global Ocean Current Model<br><b>🌍 Coverage:</b> Worldwide Ocean Currents</div>` }
      });
      map.add(flowLayer, 2);
      window.flowLayer = flowLayer;
      fireLayer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
        title:"Active Fires & Thermal Hotspots (VIIRS)", opacity:0.9, visible:true,
        renderer:{ type:"simple", symbol:{ type:"simple-marker", style:"circle", size:8, color:[255,69,0,0.8], outline:{color:"yellow",width:1}}},
        popupTemplate:{ title:"🔥 Active Fire Detection", content:`<div style="line-height:1.5"><b>🔥 Fire Brightness:</b> {BRIGHT_TI4} K<br><b>📅 Detection Date:</b> {ACQ_DATE}<br><b>🕒 Detection Time:</b> {ACQ_TIME}<br><b>🛰️ Satellite:</b> {SATELLITE}<br><b>📍 Confidence:</b> {CONFIDENCE}<br><b>📍 Coordinates:</b> {LATITUDE}, {LONGITUDE}<br><b>📊 Data Source:</b> NASA VIIRS</div>` },
        definitionExpression: `${fireBaseDefinition} AND (BRIGHT_TI4 >= 365)` // Initial filter
      });
      map.add(fireLayer, 4);
      window.fireLayer = fireLayer;
      let legendWidget = null;
      function updateLegend() {
        if (!legendWidget) return;
        const layerInfos = [];
        if (pm25Layer && pm25Layer.visible) layerInfos.push({ layer:pm25Layer, title:"PM2.5 (μg/m³) — Live Stations" });
        if (googleAqiLayer && googleAqiLayer.visible) layerInfos.push({ layer:googleAqiLayer, title:"Cities (Google AQI)" });
        if (flowLayer && flowLayer.visible) layerInfos.push({ layer:flowLayer, title:"🌊 Animated Flow" });
        if (fireLayer && fireLayer.visible) layerInfos.push({ layer:fireLayer, title:"Active Fires & Thermal Hotspots (VIIRS)" });
        legendWidget.layerInfos = layerInfos;
      }

      view.whenLayerView(pm25Layer).then(() => {
        legendWidget = new Legend({ view, layerInfos:[] });
        view.ui.add(legendWidget, "bottom-left");
        document.getElementById("loading").style.display = "none";
        loadGoogleAqiData();
        updateStatus();
        updateLegend();
        refreshTopCities();
        setInterval(refreshTopCities, 30 * 60 * 1000);
      });

      function updateStatus() {
        pm25Layer.queryFeatureCount().then(c => {
            const statusParts = [ `✓ PM2.5 stations connected (${c.toLocaleString()})` ];
            if (googleAqiLayer && googleAqiLayer.loaded) {
                statusParts.push(`✓ Google AQI active (${googleAqiData?.features.length || 0} cities)`);
            } else {
                statusParts.push(googleAqiLayer ? `... Google AQI loading...` : `❌ Google AQI failed to load.`);
            }
            statusParts.push(`✓ Animated flow streamlines active`);
            document.getElementById("status").innerHTML = statusParts.join('<br>');
        }).catch(() => {
            document.getElementById("status").textContent = "⚠️ Could not connect to all data sources.";
        });
      }

      async function refreshTopCities(){
        const box=document.getElementById("topCities"); 
        box.innerHTML='<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Updating...</div></div>';
        try{
          const q=pm25Layer.createQuery();
          q.where="value BETWEEN 0 AND 500 AND city IS NOT NULL AND unit IN ('µg/m³','ug/m3')";
          q.groupByFieldsForStatistics=["city","country_name"];
          q.outStatistics=[{statisticType:"avg",onStatisticField:"value",outStatisticFieldName:"avg_pm25"}, {statisticType:"count",onStatisticField:"value",outStatisticFieldName:"n_stations"}];
          q.havingClause="COUNT(value) >= 3"; q.orderByFields=["avg_pm25 DESC"]; q.num=10; q.returnGeometry=false;
          const res = await pm25Layer.queryFeatures(q);
          if(!res.features.length){ 
            box.innerHTML='<div style="opacity:.85; padding: 10px;">No data right now.</div>'; 
            return; 
          }
          const getAqiClass = v => v <= 10 ? "good" : v <= 25 ? "mod" : "bad";
          box.innerHTML = "";
          res.features.forEach(f=>{
            const a=f.attributes, v=a.avg_pm25;
            const row=document.createElement("div");
            row.className="city-item";
            row.innerHTML=`
                <div class="city-info">
                    <div class="city-name">${a.city}, ${a.country_name}</div>
                    <div class="city-details">Avg of ${a.n_stations} stations</div>
                </div>
                <span class="tag ${getAqiClass(v)}">${Math.round(v)}</span>
            `;
            row.addEventListener("click",()=>zoomToCity(a.city,a.country_name));
            box.appendChild(row);
          });
        }catch(e){ 
          console.error(e); 
          box.innerHTML='<div style="opacity:.85; padding: 10px; color: #ffdddd;">Failed to load top cities.</div>'; 
        }
      }

      async function zoomToCity(city,country){
        const q = pm25Layer.createQuery();
        const esc = s => String(s).replace(/'/g,"''");
        q.where=`city='${esc(city)}' AND country_name='${esc(country)}' AND value BETWEEN 0 AND 500`;
        q.outFields=["*"]; q.returnGeometry=true; q.num=1;
        const res = await pm25Layer.queryFeatures(q);
        if(res.features.length) view.goTo({ center: res.features[0].geometry, zoom:11 }, { duration:1500 });
      }
      window.zoomToCity = zoomToCity;

      // Sidebar and Tab Management
      document.getElementById("sidebarBtn").addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        const viewDiv = document.getElementById("viewDiv");
        const isOpen = sidebar.classList.toggle("open");
        viewDiv.classList.toggle("sidebar-open", isOpen);
        setTimeout(() => window.dispatchEvent(new Event("resize")), 300);
      });

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          this.classList.add('active');
          document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
        });
      });
      
      document.querySelectorAll(".basemap-option").forEach(opt=>{
        opt.addEventListener("click", function(){
          map.basemap = this.dataset.basemap;
          document.querySelectorAll(".basemap-option").forEach(o=>o.classList.remove("active"));
          this.classList.add("active");
        });
      });

      // Layer controls
      document.getElementById("layerAQI").addEventListener("change", e => { pm25Layer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerGoogleAQI").addEventListener("change", e => { if (googleAqiLayer) googleAqiLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerFlow").addEventListener("change", e => { if (flowLayer) flowLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerFire").addEventListener("change", e => { if (fireLayer) fireLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerCities").addEventListener("change", e => citiesLayer.visible = e.target.checked);
      document.getElementById("layerLegend").addEventListener("change", e => { if(legendWidget) legendWidget.visible = e.target.checked; });
      
      const brightnessSlider = document.getElementById("brightnessSlider");
      const brightnessValue = document.getElementById("brightnessValue");

      brightnessSlider.addEventListener("input", (event) => {
          const minBrightness = parseInt(event.target.value);
          brightnessValue.textContent = minBrightness;
          fireLayer.definitionExpression = `${fireBaseDefinition} AND (BRIGHT_TI4 >= ${minBrightness})`;
      });

      // Flow animation controls
      const setupFlowControl = (inputId, valueId, property) => {
          const input = document.getElementById(inputId);
          const valueDisplay = document.getElementById(valueId);
          input.addEventListener("input", function() {
              const value = this.type === 'range' && this.step === '0.1' ? parseFloat(this.value) : parseInt(this.value);
              valueDisplay.textContent = value;
              if (flowLayer?.renderer?.type === "flow") {
                  flowLayer.renderer[property] = value;
              }
          });
      };
      setupFlowControl("windSpeed", "speedValue", "flowSpeed");
      setupFlowControl("windDensity", "densityValue", "density");
      setupFlowControl("windTrail", "trailValue", "trailLength");

      function performSearch(){
        const term = document.getElementById("searchInput").value.toLowerCase().trim();
        if (!term) return;
        
        if (googleAqiData?.features) {
          const match = googleAqiData.features.find(f => f.properties.name.toLowerCase().includes(term));
          if (match) {
            view.goTo({ center: match.geometry.coordinates, zoom: 12 }, { duration: 1500 });
            toast(`🔍 Found ${match.properties.name} in Google AQI data`);
            return;
          }
        }
        
        const query = citiesLayer.createQuery();
        query.where = `LOWER(CITY_NAME) LIKE '%${term.replace(/'/g, "''")}%'`;
        query.outFields = ["CITY_NAME"];
        query.returnGeometry = true;
        citiesLayer.queryFeatures(query).then(result => {
            if (result.features.length > 0) {
                const feature = result.features[0];
                view.goTo(feature.geometry);
                toast(`🔍 Found ${feature.attributes.CITY_NAME}`);
            } else {
                toast("City not found in available data.", 2500);
            }
        });
      }
      document.getElementById("searchBtn").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") performSearch(); });
    });

    function setWindPreset(preset) {
        if (!window.flowLayer?.renderer?.type === "flow") return;
        const renderer = window.flowLayer.renderer;
        
        document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.preset-btn[onclick="setWindPreset('${preset}')"]`).classList.add('active');
        
        const presets = {
            subtle: { density: 0.3, flowSpeed: 3, trailLength: 80 },
            normal: { density: 0.6, flowSpeed: 6, trailLength: 120 },
            intense: { density: 0.9, flowSpeed: 12, trailLength: 180 }
        };
        const config = presets[preset] || presets.normal;
        
        Object.assign(renderer, config);
        
        document.getElementById("windSpeed").value = config.flowSpeed;
        document.getElementById("windDensity").value = config.density;
        document.getElementById("windTrail").value = config.trailLength;
        document.getElementById("speedValue").textContent = config.flowSpeed;
        document.getElementById("densityValue").textContent = config.density;
        document.getElementById("trailValue").textContent = config.trailLength;
    }
    window.setWindPreset = setWindPreset;

    // Mascot and Chat Bubble Controller
    (function() {
        const mascotContainer = document.getElementById('mascotContainer');
        const mascotBtn = document.getElementById('mascotBtn');
        const chatBubble = document.getElementById('chatBubble');
        const closeChat = document.getElementById('closeChat');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        let isDragging = false, hasDragged = false;
        let dragStartX, dragStartY, containerStartX, containerStartY, clickStartTime;
        const CLICK_TIME_THRESHOLD = 300, CLICK_MOVE_THRESHOLD = 5;
        let chatHistory = [];

        function loadPosition() {
            try {
                const pos = JSON.parse(localStorage.getItem('mascotPosition'));
                if (pos) {
                    mascotContainer.style.left = pos.x + 'px';
                    mascotContainer.style.top = pos.y + 'px';
                }
            } catch (e) {}
        }

        function savePosition() {
            try {
                const rect = mascotContainer.getBoundingClientRect();
                localStorage.setItem('mascotPosition', JSON.stringify({ x: rect.left, y: rect.top }));
            } catch (e) {}
        }

        function updateBubblePosition() {
            const rect = mascotContainer.getBoundingClientRect();
            chatBubble.classList.toggle('left', rect.left > window.innerWidth - 500);
            chatBubble.classList.toggle('right', rect.left <= window.innerWidth - 500);
        }

        function toggleChat() {
            const isOpen = chatBubble.classList.toggle('open');
            if (isOpen) {
                updateBubblePosition();
                chatInput.focus();
            }
        }

        mascotBtn.addEventListener('mousedown', function(e) {
            isDragging = true;
            hasDragged = false;
            clickStartTime = Date.now();
            const rect = mascotContainer.getBoundingClientRect();
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            containerStartX = rect.left;
            containerStartY = rect.top;
            mascotBtn.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - dragStartX, deltaY = e.clientY - dragStartY;
            if (Math.abs(deltaX) > CLICK_MOVE_THRESHOLD || Math.abs(deltaY) > CLICK_MOVE_THRESHOLD) hasDragged = true;
            const newX = containerStartX + deltaX, newY = containerStartY + deltaY;
            const maxX = window.innerWidth - 84, maxY = window.innerHeight - 84;
            mascotContainer.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            mascotContainer.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
            if (chatBubble.classList.contains('open')) updateBubblePosition();
        });

        document.addEventListener('mouseup', function() {
            if (!isDragging) return;
            isDragging = false;
            mascotBtn.classList.remove('dragging');
            if (!hasDragged && (Date.now() - clickStartTime < CLICK_TIME_THRESHOLD)) toggleChat();
            else savePosition();
        });

        closeChat.addEventListener('click', () => chatBubble.classList.remove('open'));

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            addMessage(text, true);
            chatHistory.push({ role: "user", content: text });
            chatInput.value = '';
            chatInput.disabled = true;
            chatSend.disabled = true;
            const thinkingMsg = addMessage('Analyzing...', false);

            try {
                const response = await fetch('/.netlify/functions/AQI-Chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userMessage: text, history: chatHistory.slice(0, -1) })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                thinkingMsg.textContent = data.reply || "I couldn't process that request.";
                chatHistory.push({ role: "assistant", content: data.reply });

                if (data.action?.type === 'zoomTo') {
                    const { city, country } = data.action;
                    if (window.zoomToCity) {
                        document.getElementById('overlayStatus').textContent = `🗺️ Zooming to ${city}...`;
                        document.getElementById('overlayStatus').style.display = 'block';
                        window.zoomToCity(city, country);
                    }
                }
            } catch (error) {
                console.error('Chat error:', error);
                thinkingMsg.textContent = 'Sorry, I couldn\'t connect. Please try again.';
                chatHistory.pop();
            } finally {
                chatInput.disabled = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
        window.addEventListener('resize', () => { if (chatBubble.classList.contains('open')) updateBubblePosition(); });
        loadPosition();
    })();
  </script>
</body>
</html>