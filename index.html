<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AirLux — Global Air Quality Intelligence</title>

<link href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

<style>
:root {
  --bg-primary: #05070D;
  --bg-glass: rgba(15, 20, 34, 0.6);
  --ink-primary: #E5ECFF;
  --ink-secondary: #8A9BB5;
  --stroke-primary: rgba(255, 255, 255, 0.12);
  --stroke-secondary: rgba(255, 255, 255, 0.2);
  --accent-cyan: #00F2FE;
  --accent-glow: 0 0 12px rgba(0, 242, 254, 0.3), 0 0 24px rgba(0, 242, 254, 0.2);
  --brass: linear-gradient(135deg, #F6E39A, #D4AF37, #B88A2B);
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --shadow-hud: 0 24px 80px rgba(0,0,0,0.4);
}
*{box-sizing: border-box}
html, body {
  height: 100%;
  margin: 0;
  background: var(--bg-primary);
  color: var(--ink-primary);
  font-family: 'Inter', sans-serif;
  overflow: hidden;
}

/* --- THE IMMERSIVE STAGE (MAP) --- */
.stage { position: fixed; inset: 0; }
#viewDiv { position: absolute; inset: 0; }
#loading { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-weight: 600; font-size: 18px; color: var(--ink-secondary); }
#toast { position: absolute; top: 18px; left: 50%; transform: translateX(-50%); z-index: 1002; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--stroke-primary); background:var(--bg-glass); backdrop-filter: blur(20px); display: none; }

/* Custom ArcGIS Popup Styling */
.esri-popup .esri-popup__main-container { background: var(--bg-glass); border: 1px solid var(--stroke-primary); backdrop-filter: blur(20px); color: var(--ink-primary); border-radius: 12px; }
.esri-popup .esri-popup__header { background: none; color: var(--ink-primary); border-bottom: 1px solid var(--stroke-primary); }
.esri-popup .esri-popup__content { color: var(--ink-primary); }
.esri-popup .esri-popup__feature-buttons, .esri-popup .esri-popup__footer { background: rgba(0,0,0,0.2); }

/* --- THE UNIFIED COMMAND DECK --- */
.command-deck { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 1000; transition: all 0.5s var(--ease-out); display: flex; flex-direction: column; align-items: center; gap: 12px; }
.deck-core { display: flex; align-items: center; padding: 8px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 999px; backdrop-filter: blur(24px) saturate(1.5); box-shadow: var(--shadow-hud); transition: all 0.5s var(--ease-out); }
.deck-brand { width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center; font: 700 18px 'Playfair Display', serif; background: var(--brass); color: #1a1200; margin-right: 8px; flex-shrink: 0; }
.deck-tools { display: flex; align-items: center; gap: 4px; }
.deck-tools .btn { width: 48px; height: 48px; border-radius: 50%; background: transparent; border: none; color: var(--ink-secondary); font-size: 20px; cursor: pointer; transition: all 0.2s ease; display: grid; place-items: center; }
.deck-tools .btn:hover { background: rgba(255,255,255,0.1); color: var(--ink-primary); }
.deck-tools .btn.active { background: var(--accent-cyan); color: #000; box-shadow: var(--accent-glow); }
.deck-divider { width: 1px; height: 24px; background: var(--stroke-primary); margin: 0 12px; }
.deck-metrics { display: flex; align-items: center; gap: 20px; padding-right: 16px; }
.metric { text-align: right; }
.metric .val { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
.metric .lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--ink-secondary); }
.command-deck:not(:hover):not(.panel-open) .deck-tools, .command-deck:not(:hover):not(.panel-open) .deck-divider, .command-deck:not(:hover):not(.panel-open) .deck-metrics { display: none; }
.command-deck:not(:hover):not(.panel-open) .deck-core { padding: 6px; }
.deck-panel { width: 600px; padding: 12px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 22px; backdrop-filter: blur(24px) saturate(1.5); box-shadow: var(--shadow-hud); opacity: 0; transform: translateY(20px); pointer-events: none; transition: all 0.4s var(--ease-out); visibility: hidden; }
.command-deck.panel-open .deck-panel { opacity: 1; transform: translateY(0); pointer-events: auto; visibility: visible; }
.search-bar { display: flex; gap: 10px; }
.search-bar input { flex: 1; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--stroke-primary); background: rgba(5,7,13,.8); color: var(--ink-primary); outline: none; font-size: 16px; font-weight: 500; }
.search-bar input::placeholder { color: var(--ink-secondary); }
.search-bar button { padding: 0 24px; border-radius: 12px; border: none; background: var(--accent-cyan); color: #000; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; cursor: pointer; box-shadow: var(--accent-glow); }

/* --- THE INTELLIGENCE / SETTINGS PANEL (RIGHT) --- */
.side-panel { position: fixed; inset: 16px 16px 108px auto; width: 420px; z-index: 1001; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 28px; backdrop-filter: blur(28px) saturate(1.8); box-shadow: var(--shadow-hud); padding: 20px; overflow-y: auto; transform: translateX(110%); transition: transform 0.6s var(--ease-out), opacity 0.6s var(--ease-out); opacity: 0; visibility: hidden; }
.side-panel.open { transform: translateX(0); opacity: 1; visibility: visible; }
.panel-section { margin-bottom: 24px; }
.panel-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--stroke-primary); }
.panel-header .icon { font-size: 20px; }
.panel-header .title { font-size: 18px; font-weight: 600; }
.list { display: flex; flex-direction: column; gap: 8px; }
.list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: background .2s ease, border-color .2s ease; border: 1px solid transparent; }
.list-row:hover { background: rgba(255,255,255,0.1); }
.list-row.active { background: rgba(0, 242, 254, 0.1); border-color: var(--accent-cyan); }
.tag { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; color: #fff; }
.tag.good { background: linear-gradient(135deg, #10b981, #059669); }
.tag.mod { background: linear-gradient(135deg, #f59e0b, #d97706); }
.tag.bad { background: linear-gradient(135deg, #ef4444, #dc2626); }
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.settings-control { display:flex; flex-direction:column; gap: 8px; color: var(--ink-secondary); }
.settings-control input[type="range"] { width: 100%; }
.preset-buttons { display: flex; gap: 8px; }
.preset-buttons .list-row { flex: 1; justify-content: center; }

/* --- LAYER PILLS --- */
.layer-pills { position: fixed; top: 16px; right: 16px; z-index: 999; display: flex; gap: 8px; }
.pill { padding: 8px 14px; border-radius: 999px; background: var(--bg-glass); border: 1px solid var(--stroke-primary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; opacity: 0.7; transition: all 0.2s ease; backdrop-filter: blur(12px); }
.pill:hover { opacity: 1; background: rgba(15, 20, 34, 0.8); }
.pill.active { opacity: 1; border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: var(--accent-glow); }
.pill .dot { display: none; }
.pill.active .dot { display: block; width: 8px; height: 8px; border-radius: 50%; background: var(--accent-cyan);}

/* --- AI ASSISTANT CHAT MODAL --- */
#chatModal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90vw; max-width: 600px; height: 75vh; max-height: 700px; z-index: 2000; background: var(--bg-glass); border: 1px solid var(--stroke-primary); border-radius: 28px; backdrop-filter: blur(28px) saturate(1.8); box-shadow: var(--shadow-hud); display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: all 0.4s var(--ease-out); }
#chatModal.open { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
#chatHeader { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--stroke-primary); font-weight: 600; font-size: 18px; }
#closeChat { background: none; border: none; color: var(--ink-secondary); font-size: 24px; cursor: pointer; transition: color .2s ease; }
#closeChat:hover { color: var(--ink-primary); }
#chatMessages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
.message { max-width: 80%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; }
.message.user { align-self: flex-end; background: var(--accent-cyan); color: #000; border-radius: 18px 18px 4px 18px; }
.message.bot { align-self: flex-start; background: rgba(255,255,255,0.08); border-radius: 18px 18px 18px 4px; }
.message.bot.typing { font-style: italic; color: var(--ink-secondary); }
#chatInputArea { padding: 16px; border-top: 1px solid var(--stroke-primary); display: flex; gap: 12px; }
#chatInput { flex: 1; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--stroke-primary); background: rgba(5,7,13,.8); color: var(--ink-primary); font-size: 16px; }
#chatSend { padding: 0 24px; border-radius: 12px; border: none; background: var(--accent-cyan); color: #000; font-weight: 700; cursor: pointer; box-shadow: var(--accent-glow); }

/* --- RESPONSIVE --- */
@media (max-width: 1024px) {
    .deck-metrics { display: none; }
    .side-panel { width: 380px; }
    .deck-panel { width: 90vw; max-width: 500px; }
}
@media (max-width: 640px) {
    .deck-divider { display: none; }
    .side-panel { inset: 10px 10px 95px 10px; width: auto; }
    .layer-pills { left: 10px; right: 10px; justify-content: center; flex-wrap: wrap; }
}
</style>
</head>
<body>

<main class="stage">
  <div id="viewDiv">
    <div id="loading">Initializing Global Intelligence...</div>
    <div id="toast"></div>
  </div>
</main>

<div class="layer-pills">
    <div class="pill active" data-layer="aqi" title="PM2.5 Stations (OpenAQ)"><span class="dot"></span>PM2.5</div>
    <div class="pill active" data-layer="gaqi" title="Google AQI Cities"><span class="dot"></span>Google AQI</div>
    <div class="pill active" data-layer="fire" title="Active Fires"><span class="dot"></span>Fires</div>
    <div class="pill active" data-layer="flow" title="Ocean Flow"><span class="dot"></span>Flow</div>
</div>

<div class="command-deck" id="commandDeck">
    <div class="deck-panel" id="analysisPanel">
        <div class="search-bar">
            <input id="searchInput" placeholder="Analyze any city or region..."/>
            <button id="searchBtn">Analyze</button>
        </div>
    </div>
    <div class="deck-core">
        <div class="deck-brand">AL</div>
        <div class="deck-tools">
            <button class="btn" id="btnAnalyze" title="Analyze">🔍</button>
            <button class="btn" id="btnIntelligence" title="Global Intelligence">🌍</button>
            <button class="btn" id="btnSettings" title="Settings">⚙️</button>
            <button class="btn" id="btnAssistant" title="AI Assistant">💬</button>
        </div>
        <div class="deck-divider"></div>
        <div class="deck-metrics">
            <div class="val" id="kStations">0</div><div class="lbl">Live Stations</div>
            <div class="val" id="kCities">0</div><div class="lbl">Cities Monitored</div>
            <div class="val" id="kFires">0</div><div class="lbl">Active Fires</div>
        </div>
    </div>
</div>

<aside class="side-panel" id="sidePanel"></aside>

<div id="chatModal">
    <div id="chatHeader"><span>AI Assistant</span><button id="closeChat">×</button></div>
    <div id="chatMessages"><div class="message bot">Ask me about air quality anywhere. Try "What's the PM2.5 in Delhi?" or "How is the air in Jakarta right now?".</div></div>
    <div id="chatInputArea"><input id="chatInput" placeholder="Send a message..." autocomplete="off" /><button id="chatSend">Send</button></div>
</div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/GeoJSONLayer",
  "esri/layers/ImageryLayer", "esri/layers/ImageryTileLayer", "esri/renderers/FlowRenderer",
  "esri/widgets/Legend", "esri/config", "esri/geometry/Point", "esri/rest/locator"
], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryLayer, ImageryTileLayer, FlowRenderer, Legend, esriConfig, Point, locator) {

    // --- GLOBAL VARIABLES ---
    let googleAqiLayer = null, fireLayer = null, flowLayer = null, pm25Layer = null, view = null, map = null;
    let chatHistory = [];
    const geocodeUrl = "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";

    // --- INITIALIZATION ---
    function initialize() {
        setupMap();
        setupUIInteractions();
        setupChatAssistant();
        view.when(onMapReady);
    }

    // --- MAP SETUP ---
    function setupMap() {
        map = new Map({ basemap: "satellite" });
        view = new MapView({
            container: "viewDiv", map, center: [115, -2], zoom: 5,
            popup: { dockEnabled: true, dockOptions: { buttonEnabled: false, breakpoint: false, position: "bottom-right" } },
            ui: { components: ["attribution"] }
        });

        pm25Layer = new FeatureLayer({ /* ... Full definition ... */ });
        flowLayer = new ImageryTileLayer({
            url: "https://tiledimageservices.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Spilhaus_UV_ocean_currents/ImageServer",
            renderer: new FlowRenderer({
                density: 0.7, flowSpeed: 6, trailLength: 120, trailWidth: "2px",
            })
        });
        fireLayer = new FeatureLayer({
            url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
            definitionExpression: "ACQ_DATE >= CURRENT_DATE - 1 AND (BRIGHT_TI4 >= 365)"
        });
        
        map.addMany([pm25Layer, fireLayer, flowLayer]);
    }

    function onMapReady() {
        document.getElementById("loading").style.display = "none";
        loadGoogleAqiData();
        updateCounters();
    }

    // --- UI INTERACTIONS ---
    function setupUIInteractions() {
        const btnAnalyze = document.getElementById('btnAnalyze');
        const btnIntelligence = document.getElementById('btnIntelligence');
        const btnSettings = document.getElementById('btnSettings');
        
        btnAnalyze.addEventListener('click', e => togglePanel(e, 'analyze'));
        btnIntelligence.addEventListener('click', e => showIntelligencePanel(e));
        btnSettings.addEventListener('click', e => showSettingsPanel(e));
        view.on('click', closeAllPanels);
        
        document.getElementById("searchBtn").addEventListener("click", locateByText);
        document.getElementById("searchInput").addEventListener("keydown", e => { if (e.key === "Enter") locateByText(); });
    }
    
    function togglePanel(e, panelType) {
        e.stopPropagation();
        const commandDeck = document.getElementById('commandDeck');
        const sidePanel = document.getElementById('sidePanel');
        const btn = e.currentTarget;

        const isPanelOpen = commandDeck.classList.contains('panel-open') || sidePanel.classList.contains('open');
        const isCurrentBtnActive = btn.classList.contains('active');

        closeAllPanels();

        if (!isPanelOpen || !isCurrentBtnActive) {
            btn.classList.add('active');
            if (panelType === 'analyze') {
                commandDeck.classList.add('panel-open');
            } else {
                sidePanel.classList.add('open');
            }
        }
    }

    function closeAllPanels() {
        document.getElementById('commandDeck').classList.remove('panel-open');
        document.getElementById('sidePanel').classList.remove('open');
        document.querySelectorAll('.deck-tools .btn').forEach(b => b.classList.remove('active'));
    }

    // --- INTELLIGENCE PANEL ---
    function showIntelligencePanel(e) {
        togglePanel(e, 'intelligence');
        const panel = document.getElementById('sidePanel');
        panel.innerHTML = `
            <section class="panel-section">
                <div class="panel-header"><div class="icon">🌍</div><div class="title">Global Hotspots</div></div>
                <div class="list" id="topCities"><div style="opacity:.8">Loading...</div></div>
            </section>
            <section class="panel-section">
              <div class="panel-header"><div class="icon">🏭</div><div class="title">Google AQI Network</div></div>
              <div class="list" id="googleAqiList"><div style="opacity:.8">Connecting...</div></div>
            </section>
        `;
        // Functions to populate these lists would be called here
    }

    // --- SETTINGS PANEL ---
    function showSettingsPanel(e) {
        togglePanel(e, 'settings');
        const panel = document.getElementById('sidePanel');
        panel.innerHTML = `
            <section class="panel-section">
                <div class="panel-header"><div class="icon">🗺️</div><div class="title">Map Visualization</div></div>
                <div class="settings-grid">
                    <div class="list-row basemap-option ${map.basemap.id === 'satellite' ? 'active' : ''}" data-basemap="satellite">Satellite</div>
                    <div class="list-row basemap-option ${map.basemap.id === 'streets-vector' ? 'active' : ''}" data-basemap="streets-vector">Streets</div>
                    <div class="list-row basemap-option ${map.basemap.id === 'hybrid' ? 'active' : ''}" data-basemap="hybrid">Hybrid</div>
                    <div class="list-row basemap-option ${map.basemap.id === 'dark-gray-vector' ? 'active' : ''}" data-basemap="dark-gray-vector">Dark</div>
                </div>
            </section>
            <section class="panel-section">
                <div class="panel-header"><div class="icon">🔥</div><div class="title">Fire Intensity Filter</div></div>
                <div class="settings-control">
                    <label>Minimum Brightness (K): <b id="brightnessValue">365</b></label>
                    <input type="range" id="brightnessSlider" min="365" max="500" value="365" step="5">
                </div>
            </section>
            <section class="panel-section">
                <div class="panel-header"><div class="icon">🌊</div><div class="title">Flow Animation</div></div>
                <div class="settings-control">
                    <label>Speed: <b id="speedValue">${flowLayer.renderer.flowSpeed}</b></label>
                    <input type="range" id="windSpeed" min="1" max="20" value="${flowLayer.renderer.flowSpeed}">
                    <label>Density: <b id="densityValue">${flowLayer.renderer.density}</b></label>
                    <input type="range" id="windDensity" min="0.1" max="1" step="0.1" value="${flowLayer.renderer.density}">
                    <div class="preset-buttons">
                        <button class="list-row preset-btn" data-p="subtle">Subtle</button>
                        <button class="list-row preset-btn active" data-p="normal">Normal</button>
                        <button class="list-row preset-btn" data-p="intense">Intense</button>
                    </div>
                </div>
            </section>
        `;
        addSettingsEventListeners();
    }

    function addSettingsEventListeners() {
        // Basemaps
        document.querySelectorAll(".basemap-option").forEach(el => {
            el.addEventListener("click", () => {
                document.querySelectorAll(".basemap-option").forEach(x => x.classList.remove("active"));
                el.classList.add("active");
                map.basemap = el.dataset.basemap;
            });
        });
        
        // Fire slider
        const brightSlider = document.getElementById("brightnessSlider");
        brightSlider.addEventListener("input", () => {
            document.getElementById("brightnessValue").textContent = brightSlider.value;
            fireLayer.definitionExpression = `ACQ_DATE >= CURRENT_DATE - 1 AND (BRIGHT_TI4 >= ${brightSlider.value})`;
            updateCounters();
        });

        // Flow controls
        const applyFlow = () => {
            const s = Number(document.getElementById("windSpeed").value);
            const d = Number(document.getElementById("windDensity").value);
            document.getElementById("speedValue").textContent = s;
            document.getElementById("densityValue").textContent = d;
            const r = flowLayer.renderer.clone();
            r.flowSpeed = s; r.density = d;
            flowLayer.renderer = r;
        };
        document.getElementById("windSpeed").addEventListener("input", applyFlow);
        document.getElementById("windDensity").addEventListener("input", applyFlow);
        document.querySelectorAll(".preset-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const preset = btn.dataset.p;
                let speed, density;
                if (preset === 'subtle') { speed = 3; density = 0.4; }
                else if (preset === 'intense') { speed = 12; density = 0.9; }
                else { speed = 6; density = 0.7; }
                document.getElementById("windSpeed").value = speed;
                document.getElementById("windDensity").value = density;
                document.querySelectorAll(".preset-btn").forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                applyFlow();
            });
        });
    }
    
    // --- GOOGLE AQI & CHAT (Functions from previous step) ---
    async function loadGoogleAqiData() { /* ... function from previous step ... */ }
    function setupChatAssistant() { /* ... function from previous step ... */ }
    async function sendMessage() { /* ... function from previous step ... */ }
    function addMessageToChat(content, role) { /* ... function from previous step ... */ }
    function handleAIAction(action) { /* ... function from previous step ... */ }
    
    // --- UTILITIES ---
    function showToast(msg, ms = 2200) { /* ... function from previous step ... */ }
    function updateCounters() { /* ... function from previous step ... */ }
    async function locateByText() { /* ... function from previous step ... */ }

    // --- START THE APP ---
    initialize();
});
</script>

</body>
</html>