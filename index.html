<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Global AQI Dashboard - Tsinghua University</title>
<link href="https://js.arcgis.com/4.29/esri/themes/light/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>
<style>
    /* General Resets and Typography */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;overflow:hidden;background:#1a1a1a}

    /* Header Styling */
    .header{background:linear-gradient(135deg,#7A2B7A 0%,#222 100%);height:60px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1001;position:relative}
    .header-left{display:flex;align-items:center;gap:16px}
    .header h1{font-size:17px;font-weight:600}
    .header h2{font-size:13px;opacity:.85;font-style:italic;font-weight:400;margin-top:2px}
    .header-btn{background:rgba(255,255,255,.15);border:0;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .2s}
    .header-btn:hover{background:rgba(255,255,255,.25)}

    /* Main View & Sidebar Container */
    #viewDiv{position:absolute;top:60px;left:0;right:0;bottom:0;transition:left .3s cubic-bezier(.4,0,.2,1)}
    #viewDiv.sidebar-open{left:340px}

    /* Unified Sidebar Styling */
    .sidebar{position:fixed;top:60px;width:340px;height:calc(100vh - 60px);background:linear-gradient(180deg,#5c215c 0%,#2e2e2e 100%);color:#fff;z-index:1000;display:flex;flex-direction:column;left:-340px;transition:left .3s cubic-bezier(.4,0,.2,1)}
    .sidebar.open{left:0;box-shadow:3px 0 15px rgba(0,0,0,.4)}
    
    /* Sidebar Tabs */
    .sidebar-tabs{display:flex;background:rgba(0,0,0,.25);border-bottom:1px solid rgba(255,255,255,.1)}
    .tab-btn{flex:1;padding:14px;background:0 0;border:0;color:rgba(255,255,255,.7);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;border-bottom:3px solid transparent}
    .tab-btn:hover{background:rgba(255,255,255,.1);color:#fff}
    .tab-btn.active{color:#fff;border-bottom-color:#00aaff}
    
    .sidebar-content{flex:1;overflow-y:auto;padding:18px}
    .tab-panel{display:none}.tab-panel.active{display:block}

    /* Section & Control Styling */
    h3{border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:10px;margin:20px 0 12px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
    h3:first-child{margin-top:0}
    
    .control-group{background:rgba(0,0,0,.2);border-radius:8px;padding:14px;margin:12px 0}
    
    .search-input{width:100%;padding:12px;border:1px solid transparent;border-radius:8px;background:rgba(255,255,255,.1);color:#fff;margin:6px 0 10px;transition:all .2s}
    .search-input::placeholder{color:rgba(255,255,255,.6)}
    .search-input:focus{background:rgba(255,255,255,.2);box-shadow:0 0 0 2px #0079c1;outline:0}
    .search-btn{width:100%;padding:12px;background:#008cdd;border:0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;transition:background .2s}
    .search-btn:hover{background:#00aaff}

    .city-item{display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer;transition:background .2s;border-radius:4px}
    .city-item:hover{background:rgba(255,255,255,.1)}
    .tag{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag.good{background:#00e400;color:#000}.tag.mod{background:#ffff00;color:#000}.tag.bad{background:#ff4444;color:#fff}

    .notes{opacity:.9;font-size:13px;line-height:1.6;padding:0 4px}
    .notes li{margin-left:18px;margin-bottom:4px}
    #status{opacity:.9;font-size:13px;line-height:1.6;padding:4px}
    
    /* Settings Panel Styles */
    .basemap-option{background:rgba(255,255,255,.12);padding:10px 14px;margin:8px 0;border-radius:8px;cursor:pointer;user-select:none;transition:all .2s}
    .basemap-option:hover{background:rgba(255,255,255,.22);transform:translateY(-1px)}
    .basemap-option.active{background:#008cdd;box-shadow:0 4px 12px rgba(0,0,0,.35);font-weight:700}

    .layer-control{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .layer-control:last-child{border-bottom:0}
    .layer-control label{display:flex;align-items:center;cursor:pointer;gap:8px}
    .layer-control input{width:18px;height:18px}
    
    .flow-type-btn{width:100%;padding:12px;margin:4px 0;background:rgba(255,255,255,.12);border:0;color:#fff;border-radius:8px;cursor:pointer;user-select:none;transition:all .2s;font-size:13px;text-align:left}
    .flow-type-btn:hover{background:rgba(255,255,255,.22);transform:translateY(-1px)}
    .flow-type-btn.active{background:#008cdd;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.3)}

    .flow-control{margin:12px 0}
    .flow-control label{display:block;margin-bottom:6px;font-size:13px}
    .flow-control input[type="range"]{width:100%;-webkit-appearance:none;appearance:none;height:6px;background:rgba(0,0,0,.3);border-radius:3px;outline:0}
    .flow-control input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none;appearance:none;width:18px;height:18px;background:#00aaff;border-radius:50%;cursor:pointer}
    .flow-control-value{font-weight:bold;color:#00e400}
    
    .preset-buttons{display:flex;gap:8px;margin-top:10px}
    .preset-btn{flex:1;padding:8px 6px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:6px;cursor:pointer;font-size:12px;transition:all .2s}
    .preset-btn:hover{background:rgba(255,255,255,.2)}
    .preset-btn.active{background:#008cdd;border-color:#00aaff}

    #flowInfo{opacity:.9;font-size:12px;line-height:1.5;background:rgba(0,0,0,.2);padding:10px;border-radius:6px;margin:8px 0}
    #flowInfo strong{color:#00aaff}

    /* Map Elements */
    .esri-legend{background:rgba(20,20,20,.85)!important;color:#fff!important;border:1px solid rgba(255,255,255,.2)!important;border-radius:10px!important;box-shadow:0 8px 18px rgba(0,0,0,.35)!important}
    .esri-legend__service-label{color:#fff!important}
    .esri-legend__layer-caption{color:#ddd!important}

    #loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#8B2B8B;font-size:20px}
    #overlayStatus{position:absolute;top:78px;right:12px;z-index:1002;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;display:none;box-shadow:0 4px 10px rgba(0,0,0,.3)}

    /* Mascot and Chat Bubble Styles */
    #mascotContainer{position:fixed;z-index:2000;left:calc(100% - 120px);top:calc(100% - 140px);user-select:none}
    #mascotBtn{background:0 0;border:0;padding:0;cursor:move;display:block;transition:transform .2s}
    #mascotBtn:hover{transform:scale(1.05)}
    #mascotBtn.dragging{cursor:grabbing;transform:scale(1.1)}
    #mascotBtn img{width:84px;height:84px;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,.4))}

    #chatBubble{position:absolute;display:flex;width:380px;height:480px;background:linear-gradient(135deg,#1e1e2fEE,#1a1d26EE);border:1px solid rgba(255,255,255,.2);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.5);overflow:hidden;backdrop-filter:blur(10px);transform:scale(.95);opacity:0;transition:transform .2s ease-out,opacity .2s ease-out;pointer-events:none}
    #chatBubble.open{display:flex;transform:scale(1);opacity:1;pointer-events:auto}
    #chatBubble::after{content:"";position:absolute;width:0;height:0;border:12px solid transparent}
    #chatBubble.left{right:100px;top:-200px}
    #chatBubble.left::after{right:-24px;top:210px;border-left-color:rgba(30,30,47,.93)}
    #chatBubble.right{left:100px;top:-200px}
    #chatBubble.right::after{left:-24px;top:210px;border-right-color:rgba(30,30,47,.93)}

    #chatInterface{display:flex;flex-direction:column;height:100%;width:100%}
    #chatHeader{background:linear-gradient(135deg,#9a3bb8,#612aa1);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-radius:16px 16px 0 0}
    #closeChat{background:0 0;border:0;color:#fff;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background .2s}
    #closeChat:hover{background:rgba(255,255,255,.2)}
    #chatMessages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .message{padding:10px 14px;border-radius:12px;max-width:85%;word-wrap:break-word;font-size:14px;line-height:1.4}
    .message.user{align-self:flex-end;background:#2a2d36;color:#fff}
    .message.bot{align-self:flex-start;background:linear-gradient(135deg,#f2ecf4,#e8e0eb);color:#111}
    #chatInputArea{display:flex;padding:12px;background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.1)}
    #chatInput{flex:1;padding:10px 14px;border:0;background:rgba(255,255,255,.1);color:#fff;border-radius:8px 0 0 8px;font-size:14px;transition:background .2s}
    #chatInput::placeholder{color:rgba(255,255,255,.5)}
    #chatInput:focus{background:rgba(255,255,255,.2);outline:0}
    #chatSend{padding:10px 20px;border:0;background:#008cdd;color:#fff;font-weight:600;cursor:pointer;border-radius:0 8px 8px 0;transition:background .2s}
    #chatSend:hover:not(:disabled){background:#00aaff}
    #chatSend:disabled{opacity:.5;cursor:not-allowed}

    /* Scrollbar */
    .sidebar-content::-webkit-scrollbar,
    #chatMessages::-webkit-scrollbar{width:8px}
    .sidebar-content::-webkit-scrollbar-track,
    #chatMessages::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}
    .sidebar-content::-webkit-scrollbar-thumb,
    #chatMessages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:4px}
    .sidebar-content::-webkit-scrollbar-thumb:hover,
    #chatMessages::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.35)}
</style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <button class="header-btn" id="sidebarBtn" title="Toggle Panel">‚ò∞</button>
        <div>
            <h1>Group 62 IEDE Research Topic</h1>
            <h2>AI-Driven Environmental Monitoring for a Green Economy</h2>
        </div>
    </div>
</div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-tabs">
        <button class="tab-btn active" data-tab="data">üìä Data & Search</button>
        <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
    </div>
    <div class="sidebar-content">
        <div class="tab-panel active" id="dataPanel">
            <h3>üîç Location Search</h3>
            <div class="search">
                <input class="search-input" id="searchInput" placeholder="Enter city name‚Ä¶"/>
                <button class="search-btn" id="searchBtn">Search Location</button>
            </div>
            
            <h3>üè≠ Most Polluted Cities (Live)</h3>
            <div id="topCities"><div style="opacity:.85; padding:10px;">Loading‚Ä¶</div></div>
            
            <h3>üåç Google AQI Cities</h3>
            <div id="googleAqiList"><div style="opacity:.85; padding:10px;">Loading data...</div></div>
            
            <h3>üìà Notes</h3>
            <ul class="notes">
                <li>Live stations: OpenAQ via Esri Living Atlas</li>
                <li>World cities: Major cities worldwide</li>
                <li>Regional AQI: Google Air Quality API</li>
                <li>Wind data: NLDAS Hurricane Ida (animated)</li>
                <li>Ocean currents: Global ocean circulation (animated)</li>
                <li>Fire data: NASA VIIRS thermal hotspots (24hr)</li>
            </ul>
            
            <h3>‚ÑπÔ∏è Status</h3>
            <div id="status"></div>
        </div>

        <div class="tab-panel" id="settingsPanel">
            <h3>üó∫Ô∏è Map Style</h3>
            <div class="basemap-option active" data-basemap="satellite">Satellite</div>
            <div class="basemap-option" data-basemap="streets">Streets</div>
            <div class="basemap-option" data-basemap="hybrid">Hybrid</div>
            <div class="basemap-option" data-basemap="terrain">Terrain</div>
            <div class="basemap-option" data-basemap="dark-gray">Dark Gray</div>
            <div class="basemap-option" data-basemap="topo">Topographic</div>
            <div class="basemap-option" data-basemap="gray">Light Gray</div>
            <div class="basemap-option" data-basemap="oceans">Oceans</div>

            <h3>üìä Data Layers</h3>
            <div class="control-group">
                <div class="layer-control"><label><span>PM2.5 Stations (OpenAQ)</span><input checked type="checkbox" id="layerAQI"/></label></div>
                <div class="layer-control"><label><span>Cities (Google AQI)</span><input checked type="checkbox" id="layerGoogleAQI"/></label></div>
                <div class="layer-control"><label><span>üåä Flow Animation (Active)</span><input checked type="checkbox" id="layerFlow"/></label></div>
                <div class="layer-control"><label><span>üå°Ô∏è Weather Stations</span><input type="checkbox" id="layerWeatherStations"/></label></div>
                <div class="layer-control"><label><span>üî• Active Fire Hotspots</span><input checked type="checkbox" id="layerFire"/></label></div>
                <div class="layer-control"><label><span>World Cities</span><input checked type="checkbox" id="layerCities"/></label></div>
                <div class="layer-control"><label><span>Legend</span><input checked type="checkbox" id="layerLegend"/></label></div>
            </div>

            <h3>üåä Flow Animation Type</h3>
            <div class="control-group">
                <button class="flow-type-btn active" onclick="switchFlowType('ocean')" data-type="ocean">üåä Global Ocean Currents</button>
                <button class="flow-type-btn" onclick="switchFlowType('wind-na')" data-type="wind-na">üå™Ô∏è North America Wind</button>
                <button class="flow-type-btn" onclick="switchFlowType('wind-global')" data-type="wind-global">üå¨Ô∏è Global Wind Field</button>
                <div id="flowInfo">
                    <strong>üåä Global Ocean Currents:</strong><br>‚Ä¢ Worldwide coverage<br>‚Ä¢ Shows global ocean circulation<br>‚Ä¢ Real ocean current patterns
                </div>
            </div>

            <h3>üéÆ Flow Animation Settings</h3>
            <div class="control-group">
                <div class="flow-control">
                    <label>Flow Speed: <span class="flow-control-value" id="speedValue">6</span></label>
                    <input type="range" id="windSpeed" min="1" max="20" value="6">
                </div>
                <div class="flow-control">
                    <label>Density: <span class="flow-control-value" id="densityValue">0.7</span></label>
                    <input type="range" id="windDensity" min="0.1" max="1" step="0.1" value="0.7">
                </div>
                <div class="flow-control">
                    <label>Trail Length: <span class="flow-control-value" id="trailValue">120</span></label>
                    <input type="range" id="windTrail" min="50" max="300" value="120">
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setWindPreset('subtle')">Subtle</button>
                    <button class="preset-btn active" onclick="setWindPreset('normal')">Normal</button>
                    <button class="preset-btn" onclick="setWindPreset('intense')">Intense</button>
                </div>
            </div>
        </div>
    </div>
</aside>

<div id="viewDiv">
    <div id="loading">Loading map‚Ä¶</div>
    <div id="overlayStatus"></div>
</div>

<div id="mascotContainer">
    <button id="mascotBtn" title="Click to chat with AQI Assistant">
        <img src="https://i.imgur.com/zpwE5f8.png" alt="AQI Warrior mascot" />
    </button>
    <div id="chatBubble" class="left">
        <div id="chatInterface">
            <div id="chatHeader">
                <span>üåç AQI Assistant</span>
                <button id="closeChat" title="Close chat">√ó</button>
            </div>
            <div id="chatMessages">
                <div class="message bot">Hi! I'm your AQI Assistant. Ask me about air quality anywhere in the world. Try: "What's the PM2.5 in Beijing?" or "Show me the most polluted cities."</div>
            </div>
            <div id="chatInputArea">
                <input id="chatInput" type="text" placeholder="Ask about air quality..." />
                <button id="chatSend">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    require([
      "esri/Map","esri/views/MapView",
      "esri/layers/FeatureLayer","esri/layers/GeoJSONLayer",
      "esri/layers/ImageryLayer","esri/layers/MapImageLayer",
      "esri/layers/ImageryTileLayer","esri/renderers/FlowRenderer",
      "esri/widgets/Legend","esri/config"
    ], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryLayer, MapImageLayer, ImageryTileLayer, FlowRenderer, Legend, esriConfig) {

      let googleAqiLayer = null;
      let googleAqiData = null;
      let windLayer = null;
      let weatherStationsLayer = null;
      let fireLayer = null;
      
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map, center: [105, 35], zoom: 4,
        popup: { dockEnabled: true, dockOptions:{ buttonEnabled: false, breakpoint: false, position: "bottom-right" } }
      });

      function switchFlowType(type) {
        globalOceanCurrentsLayer.visible = false;
        northAmericaWindLayer.visible = false;
        globalWindLayer.visible = false;
        
        document.querySelectorAll('.flow-type-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.flow-type-btn[data-type="${type}"]`).classList.add('active');
        
        switch(type) {
            case 'ocean':
                window.currentFlowLayer = globalOceanCurrentsLayer;
                updateFlowInfo('ocean');
                break;
            case 'wind-na':
                window.currentFlowLayer = northAmericaWindLayer;
                updateFlowInfo('wind-na');
                break;
            case 'wind-global':
                window.currentFlowLayer = globalWindLayer;
                updateFlowInfo('wind-global');
                break;
        }
        window.currentFlowLayer.visible = document.getElementById('layerFlow').checked;
        windLayer = window.currentFlowLayer;
        updateLegend();
      }

      function updateFlowInfo(type) {
        const infoDiv = document.getElementById('flowInfo');
        const content = {
            'ocean': `<strong>üåä Global Ocean Currents:</strong><br>‚Ä¢ Worldwide coverage<br>‚Ä¢ Shows global ocean circulation<br>‚Ä¢ Real ocean current patterns`,
            'wind-na': `<strong>üå™Ô∏è North America Wind:</strong><br>‚Ä¢ Hurricane Ida data (Aug 2021)<br>‚Ä¢ High-resolution wind patterns<br>‚Ä¢ Dramatic storm visualization`,
            'wind-global': `<strong>üå¨Ô∏è Global Wind Field:</strong><br>‚Ä¢ NDFD wind forecast data<br>‚Ä¢ Limited global coverage<br>‚Ä¢ Atmospheric wind patterns`
        };
        infoDiv.innerHTML = content[type] || '';
      }

      window.switchFlowType = switchFlowType;
      window.updateFlowInfo = updateFlowInfo;

      try { esriConfig.request.corsEnabledServers.push(window.location.origin); } catch(e) {}

      const toast = (msg, ms = 2200) => {
        const el = document.getElementById("overlayStatus");
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(el._t);
        el._t = setTimeout(() => el.style.display = "none", ms);
      };

      function createGoogleAqiLayer(geoJsonData) {
        const blob = new Blob([JSON.stringify(geoJsonData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        return new GeoJSONLayer({
          url: url,
          title: "Cities (Google AQI)",
          copyright: "¬© Google Air Quality API - Live Data",
          renderer: {
            type: "class-breaks",
            field: "aqi",
            classBreakInfos: [
              { minValue: 0, maxValue: 50, symbol: { type: "simple-marker", style: "triangle", size: 12, color: "#00e400", outline: { color: "#fff", width: 1.5 } }, label: "Good (0‚Äì50)" },
              { minValue: 51, maxValue: 100, symbol: { type: "simple-marker", style: "triangle", size: 14, color: "#ffff00", outline: { color: "#fff", width: 1.5 } }, label: "Moderate (51‚Äì100)" },
              { minValue: 101, maxValue: 150, symbol: { type: "simple-marker", style: "triangle", size: 16, color: "#ff7e00", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy for Sensitive (101‚Äì150)" },
              { minValue: 151, maxValue: 200, symbol: { type: "simple-marker", style: "triangle", size: 18, color: "#ff0000", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy (151‚Äì200)" },
              { minValue: 201, maxValue: 300, symbol: { type: "simple-marker", style: "triangle", size: 20, color: "#8f3f97", outline: { color: "#fff", width: 1.5 } }, label: "Very Unhealthy (201‚Äì300)" },
              { minValue: 301, maxValue: 9999, symbol: { type: "simple-marker", style: "triangle", size: 22, color: "#7e0023", outline: { color: "#fff", width: 1.5 } }, label: "Hazardous (300+)" }
            ]
          },
          popupTemplate: {
            title: "{name} - Google AQI",
            content: `<div style="line-height:1.5"><b>üå¨Ô∏è US AQI:</b> <span style="font-size:18px;font-weight:bold;">{aqi}</span><br><b>üìä Category:</b> {category}<br><b>üí® Dominant Pollutant:</b> {main_pollutant}<br><b>üïí Last Updated:</b> {time}<br><b>üìç Location:</b> {name}<br><b>üìä Data Source:</b> {source}</div>`
          }
        });
      }

      async function loadGoogleAqiData() {
        try {
          toast("Loading Google AQI data...", 3000);
          const response = await fetch('/.netlify/functions/google-aqi');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          googleAqiData = await response.json();
          if (googleAqiData.warning) console.warn("API Warning:", googleAqiData.warning);
          googleAqiLayer = createGoogleAqiLayer(googleAqiData);
          map.add(googleAqiLayer, 1);
          await googleAqiLayer.load();
          toast("‚úÖ Google AQI data loaded!");
          updateStatus();
          updateLegend();
          updateGoogleAqiList(googleAqiData);
        } catch (error) {
          console.error("Failed to load Google AQI data:", error);
          toast("‚ùå Failed to load Google AQI data");
          document.getElementById("googleAqiList").innerHTML = `<div style="opacity:.85; color: #ffdddd; padding: 10px;">Failed to load.</div>`;
          updateStatus();
        }
      }
      
      function updateGoogleAqiList(geoJsonData) {
          const listElement = document.getElementById("googleAqiList");
          if (!geoJsonData || !geoJsonData.features || geoJsonData.features.length === 0) {
              listElement.innerHTML = '<div style="opacity:.85; padding: 10px;">No data available</div>';
              return;
          }
          const cities = geoJsonData.features.map(f => f.properties).sort((a, b) => b.aqi - a.aqi);
          const getAqiClass = aqi => aqi <= 50 ? "tag good" : aqi <= 100 ? "tag mod" : "tag bad";
          listElement.innerHTML = "";
          cities.forEach(city => {
              const row = document.createElement("div");
              row.className = "city-item";
              row.innerHTML = `<span>${city.name}</span><span class="${getAqiClass(city.aqi)}">${city.aqi}</span>`;
              row.addEventListener("click", () => {
                  const feature = geoJsonData.features.find(f => f.properties.name === city.name);
                  if (feature) view.goTo({ center: feature.geometry.coordinates, zoom: 11 }, { duration: 1500 });
              });
              listElement.appendChild(row);
          });
      }

      const pm25Layer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
        title:"PM2.5 Stations (OpenAQ)", outFields:["*"],
        popupTemplate:{ title:"{location} ({country_name})", content:`<div style="line-height:1.5"><b>City:</b> {city}<br><b>PM2.5:</b> {value} {unit}<br><b>Provider:</b> {provider_name}<br><b>Updated:</b> {lastUpdated}<br><a href="{url}" target="_blank" rel="noopener">Station link</a></div>` },
        renderer:{ type:"class-breaks", field:"value", classBreakInfos:[
          {minValue:0,maxValue:10,symbol:{type:"simple-marker",size:8,color:"#00e400",outline:{color:"#fff",width:1}},label:"Good (0‚Äì10)"},
          {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10,color:"#ffff00",outline:{color:"#fff",width:1}},label:"Moderate (10‚Äì25)"},
          {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12,color:"#ff7e00",outline:{color:"#fff",width:1}},label:"USG (25‚Äì50)"},
          {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14,color:"#ff0000",outline:{color:"#fff",width:1}},label:"Unhealthy (50‚Äì75)"},
          {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16,color:"#8f3f97",outline:{color:"#fff",width:1}},label:"Very Unhealthy (75‚Äì100)"},
          {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18,color:"#7e0023",outline:{color:"#fff",width:1}},label:"Hazardous (100+)"}
        ]}
      });
      map.add(pm25Layer);

      const citiesLayer = new FeatureLayer({
        url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
        title:"World Cities", definitionExpression:"POP > 100000",
        renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
        labelingInfo:[{ symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
          labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000 }],
        popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
      });
      map.add(citiesLayer);

      const globalOceanCurrentsLayer = new ImageryTileLayer({
        url:"https://tiledimageservices.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Spilhaus_UV_ocean_currents/ImageServer",
        title:"Global Ocean Currents", opacity:0.8, visible:true,
        renderer: new FlowRenderer({
          type:"flow", density:0.7, flowSpeed:6, trailLength:120, trailWidth:"2px", maxPathLength:180,
          visualVariables:[{ type:"color", field:"Magnitude", stops:[
            {color:[30,100,150,0.6],value:0},{color:[50,150,200,0.7],value:0.1},{color:[100,200,255,0.8],value:0.3},
            {color:[150,255,200,0.9],value:0.6},{color:[255,255,100,1],value:1},{color:[255,100,100,1],value:1.5}
          ]}]
        }),
        popupTemplate:{ title:"üåä Global Ocean Currents", content:`<div style="line-height:1.5"><b>üåä Current Speed:</b> {Magnitude} m/s<br><b>üß≠ Current Direction:</b> {Direction}¬∞<br><b>üìä Data Source:</b> Global Ocean Current Model<br><b>üåç Coverage:</b> Worldwide Ocean Currents</div>` }
      });

      const northAmericaWindLayer = new ImageryTileLayer({
        url:"https://tiledimageservices.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NLDAS_Hourly_8_30_2021/ImageServer",
        title:"North America Wind Flow", opacity:0.85, visible:false,
        renderer: new FlowRenderer({
          type:"flow", density:0.6, flowSpeed:8, trailLength:150, trailWidth:"2px", maxPathLength:200,
          visualVariables:[{ type:"color", field:"Magnitude", stops:[
            {color:[65,150,255,0.7],value:0},{color:[100,200,255,0.8],value:3},{color:[150,255,150,0.9],value:8},
            {color:[255,255,100,0.9],value:15},{color:[255,150,50,1],value:25},{color:[255,50,50,1],value:35}
          ]}]
        }),
        popupTemplate:{ title:"üå™Ô∏è Hurricane Ida Wind Data", content:`<div style="line-height:1.5"><b>üí® Wind Speed:</b> {Magnitude} m/s<br><b>üß≠ Wind Direction:</b> {Direction}¬∞<br><b>üìä Data Source:</b> NLDAS Hourly Wind Data<br><b>üïí Time Period:</b> Hurricane Ida (Aug 30, 2021)</div>` }
      });

      const globalWindLayer = new ImageryTileLayer({
        url:"https://sampleserver6.arcgisonline.com/arcgis/rest/services/ScientificData/NDFD_wind/ImageServer",
        title:"Global Wind Field", opacity:0.8, visible:false,
        renderer: new FlowRenderer({
          type:"flow", density:0.5, flowSpeed:5, trailLength:100, trailWidth:"1.5px", maxPathLength:150,
          visualVariables:[{ type:"color", field:"Magnitude", stops:[
            {color:[100,200,100,0.7],value:0},{color:[150,255,150,0.8],value:5},{color:[255,255,100,0.9],value:15},
            {color:[255,150,50,1],value:25},{color:[255,50,50,1],value:35}
          ]}]
        }),
        popupTemplate:{ title:"üå¨Ô∏è Wind Field Data", content:`<div style="line-height:1.5"><b>üí® Wind Speed:</b> {Magnitude} knots<br><b>üß≠ Wind Direction:</b> {Direction}¬∞<br><b>üìä Data Source:</b> NDFD Wind Data</div>` }
      });

      map.add(globalOceanCurrentsLayer, 2);
      map.add(northAmericaWindLayer, 2);
      map.add(globalWindLayer, 2);

      windLayer = globalOceanCurrentsLayer;
      window.currentFlowLayer = globalOceanCurrentsLayer;

      weatherStationsLayer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Current_Weather_and_Wind_Station_Data/FeatureServer/0",
        title:"Weather Stations", opacity:0.7, visible:false,
        renderer:{ type:"simple", symbol:{ type:"simple-marker", style:"triangle", size:8, color:[255,215,0,0.8], outline:{color:"white",width:1}}, visualVariables:[{type:"rotation",field:"WIND_DIRECT",rotationType:"geographic"},{type:"size",field:"WIND_SPEED",minDataValue:0,maxDataValue:50,minSize:6,maxSize:18}] },
        popupTemplate:{ title:"üå°Ô∏è Weather Station: {STATION_NAME}", content:`<div style="line-height:1.5"><b>üå¨Ô∏è Wind Speed:</b> {WIND_SPEED} km/h<br><b>üß≠ Wind Direction:</b> {WIND_DIRECT}¬∞<br><b>üå°Ô∏è Temperature:</b> {TEMP} ¬∞C<br><b>üíß Humidity:</b> {R_HUMIDITY}%<br><b>‚òÅÔ∏è Cloud Coverage:</b> {COVERAGE}<br><b>üåà Visibility:</b> {VISIBILITY} km<br><b>üìç Location:</b> {STATION_NAME}<br><b>üïí Observation Time:</b> {DATE_TIME}</div>` }
      });
      map.add(weatherStationsLayer, 3);

      fireLayer = new FeatureLayer({
        url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
        title:"Active Fires & Thermal Hotspots (VIIRS)", opacity:0.9, visible:true,
        renderer:{ type:"simple", symbol:{ type:"simple-marker", style:"circle", size:8, color:[255,69,0,0.8], outline:{color:"yellow",width:1}}},
        popupTemplate:{ title:"üî• Active Fire Detection", content:`<div style="line-height:1.5"><b>üî• Fire Brightness:</b> {BRIGHT_TI4} K<br><b>üìÖ Detection Date:</b> {ACQ_DATE}<br><b>üïê Detection Time:</b> {ACQ_TIME}<br><b>üõ∞Ô∏è Satellite:</b> {SATELLITE}<br><b>üìç Confidence:</b> {CONFIDENCE}<br><b>üìç Coordinates:</b> {LATITUDE}, {LONGITUDE}<br><b>üìä Data Source:</b> NASA VIIRS</div>` },
        definitionExpression: "ACQ_DATE >= CURRENT_DATE - 1"
      });
      map.add(fireLayer, 4);

      let legendWidget = null;
      function updateLegend() {
        if (!legendWidget) return;
        const layerInfos = [];
        if (pm25Layer && pm25Layer.visible) layerInfos.push({ layer:pm25Layer, title:"PM2.5 (Œºg/m¬≥) ‚Äî Live Stations" });
        if (googleAqiLayer && googleAqiLayer.visible) layerInfos.push({ layer:googleAqiLayer, title:"Cities (Google AQI)" });
        if (window.currentFlowLayer && window.currentFlowLayer.visible) layerInfos.push({ layer:window.currentFlowLayer, title:"üåä Animated Flow" });
        if (weatherStationsLayer && weatherStationsLayer.visible) layerInfos.push({ layer:weatherStationsLayer, title:"üå°Ô∏è Weather Stations" });
        if (fireLayer && fireLayer.visible) layerInfos.push({ layer:fireLayer, title:"Active Fires & Thermal Hotspots (VIIRS)" });
        legendWidget.layerInfos = layerInfos;
      }

      view.whenLayerView(pm25Layer).then(() => {
        legendWidget = new Legend({ view, layerInfos:[] });
        view.ui.add(legendWidget, "bottom-left");
        document.getElementById("loading").style.display = "none";
        loadGoogleAqiData();
        updateStatus();
        updateLegend();
        refreshTopCities();
        setInterval(refreshTopCities, 30 * 60 * 1000);
      });

      function updateStatus() {
        pm25Layer.queryFeatureCount().then(c => {
            const statusParts = [ `‚úì PM2.5 stations connected (${c.toLocaleString()})` ];
            if (googleAqiLayer && googleAqiLayer.loaded) {
                statusParts.push(`‚úì Google AQI active (${googleAqiData?.features.length || 0} cities)`);
            } else {
                statusParts.push(googleAqiLayer ? `... Google AQI loading...` : `‚ùå Google AQI failed to load.`);
            }
            statusParts.push(`‚úì Animated flow streamlines active`);
            document.getElementById("status").innerHTML = statusParts.join('<br>');
        }).catch(() => {
            document.getElementById("status").textContent = "‚ö†Ô∏è Could not connect to all data sources.";
        });
      }

      async function refreshTopCities(){
        const box=document.getElementById("topCities"); box.innerHTML='<div style="opacity:.85; padding: 10px;">Updating‚Ä¶</div>';
        try{
          const q=pm25Layer.createQuery();
          q.where="value BETWEEN 0 AND 500 AND city IS NOT NULL AND unit IN ('¬µg/m¬≥','ug/m3')";
          q.groupByFieldsForStatistics=["city","country_name"];
          q.outStatistics=[{statisticType:"avg",onStatisticField:"value",outStatisticFieldName:"avg_pm25"}, {statisticType:"count",onStatisticField:"value",outStatisticFieldName:"n_stations"}];
          q.havingClause="COUNT(value) >= 3"; q.orderByFields=["avg_pm25 DESC"]; q.num=10; q.returnGeometry=false;
          const res = await pm25Layer.queryFeatures(q);
          if(!res.features.length){ box.innerHTML='<div style="opacity:.85; padding: 10px;">No data right now.</div>'; return; }
          const cls = v => v <= 10 ? "tag good" : v <= 25 ? "tag mod" : "tag bad";
          box.innerHTML = "";
          res.features.forEach(f=>{
            const a=f.attributes, v=a.avg_pm25;
            const row=document.createElement("div");
            row.className="city-item";
            row.innerHTML=`<span>${a.city}, ${a.country_name}</span><span class="${cls(v)}" title="Avg of ${a.n_stations} stations">${Math.round(v)}</span>`;
            row.addEventListener("click",()=>zoomToCity(a.city,a.country_name));
            box.appendChild(row);
          });
        }catch(e){ console.error(e); box.innerHTML='<div style="opacity:.85; padding: 10px; color: #ffdddd;">Failed to load top cities.</div>'; }
      }

      async function zoomToCity(city,country){
        const q = pm25Layer.createQuery();
        const esc = s => String(s).replace(/'/g,"''");
        q.where=`city='${esc(city)}' AND country_name='${esc(country)}' AND value BETWEEN 0 AND 500`;
        q.outFields=["*"]; q.returnGeometry=true; q.num=1;
        const res = await pm25Layer.queryFeatures(q);
        if(res.features.length) view.goTo({ center: res.features[0].geometry, zoom:11 }, { duration:1500 });
      }
      window.zoomToCity = zoomToCity;

      // Sidebar and Tab Management
      document.getElementById("sidebarBtn").addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        const viewDiv = document.getElementById("viewDiv");
        const isOpen = sidebar.classList.toggle("open");
        viewDiv.classList.toggle("sidebar-open", isOpen);
        setTimeout(() => window.dispatchEvent(new Event("resize")), 300);
      });

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          this.classList.add('active');
          document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
        });
      });
      
      document.querySelectorAll(".basemap-option").forEach(opt=>{
        opt.addEventListener("click", function(){
          map.basemap = this.dataset.basemap;
          document.querySelectorAll(".basemap-option").forEach(o=>o.classList.remove("active"));
          this.classList.add("active");
        });
      });

      // Layer controls
      document.getElementById("layerAQI").addEventListener("change", e => { pm25Layer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerGoogleAQI").addEventListener("change", e => { if (googleAqiLayer) googleAqiLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerFlow").addEventListener("change", e => { if (window.currentFlowLayer) window.currentFlowLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerWeatherStations").addEventListener("change", e => { if (weatherStationsLayer) weatherStationsLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerFire").addEventListener("change", e => { if (fireLayer) fireLayer.visible = e.target.checked; updateLegend(); });
      document.getElementById("layerCities").addEventListener("change", e => citiesLayer.visible = e.target.checked);
      document.getElementById("layerLegend").addEventListener("change", e => { if(legendWidget) legendWidget.visible = e.target.checked; });

      // Flow animation controls
      const setupFlowControl = (inputId, valueId, property) => {
          const input = document.getElementById(inputId);
          const valueDisplay = document.getElementById(valueId);
          input.addEventListener("input", function() {
              const value = this.type === 'range' && this.step === '0.1' ? parseFloat(this.value) : parseInt(this.value);
              valueDisplay.textContent = value;
              if (window.currentFlowLayer?.renderer?.type === "flow") {
                  window.currentFlowLayer.renderer[property] = value;
              }
          });
      };
      setupFlowControl("windSpeed", "speedValue", "flowSpeed");
      setupFlowControl("windDensity", "densityValue", "density");
      setupFlowControl("windTrail", "trailValue", "trailLength");

      function performSearch(){
        const term = document.getElementById("searchInput").value.toLowerCase().trim();
        if (!term) return;
        
        if (googleAqiData?.features) {
          const match = googleAqiData.features.find(f => f.properties.name.toLowerCase().includes(term));
          if (match) {
            view.goTo({ center: match.geometry.coordinates, zoom: 12 }, { duration: 1500 });
            toast(`üîç Found ${match.properties.name} in Google AQI data`);
            return;
          }
        }
        
        const query = citiesLayer.createQuery();
        query.where = `LOWER(CITY_NAME) LIKE '%${term.replace(/'/g, "''")}%'`;
        query.outFields = ["CITY_NAME"];
        query.returnGeometry = true;
        citiesLayer.queryFeatures(query).then(result => {
            if (result.features.length > 0) {
                const feature = result.features[0];
                view.goTo(feature.geometry);
                toast(`üîç Found ${feature.attributes.CITY_NAME}`);
            } else {
                toast("City not found in available data.", 2500);
            }
        });
      }
      document.getElementById("searchBtn").addEventListener("click", performSearch);
      document.getElementById("searchInput").addEventListener("keypress", e => { if(e.key === "Enter") performSearch(); });
    });

    function setWindPreset(preset) {
        if (!window.currentFlowLayer?.renderer?.type === "flow") return;
        const renderer = window.currentFlowLayer.renderer;
        
        document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.preset-btn[onclick="setWindPreset('${preset}')"]`).classList.add('active');
        
        const presets = {
            subtle: { density: 0.3, flowSpeed: 3, trailLength: 80 },
            normal: { density: 0.6, flowSpeed: 6, trailLength: 120 },
            intense: { density: 0.9, flowSpeed: 12, trailLength: 180 }
        };
        const config = presets[preset] || presets.normal;
        
        Object.assign(renderer, config);
        
        document.getElementById("windSpeed").value = config.flowSpeed;
        document.getElementById("windDensity").value = config.density;
        document.getElementById("windTrail").value = config.trailLength;
        document.getElementById("speedValue").textContent = config.flowSpeed;
        document.getElementById("densityValue").textContent = config.density;
        document.getElementById("trailValue").textContent = config.trailLength;
    }
    window.setWindPreset = setWindPreset;

    // Mascot and Chat Bubble Controller
    (function() {
        const mascotContainer = document.getElementById('mascotContainer');
        const mascotBtn = document.getElementById('mascotBtn');
        const chatBubble = document.getElementById('chatBubble');
        const closeChat = document.getElementById('closeChat');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        let isDragging = false, hasDragged = false;
        let dragStartX, dragStartY, containerStartX, containerStartY, clickStartTime;
        const CLICK_TIME_THRESHOLD = 300, CLICK_MOVE_THRESHOLD = 5;
        let chatHistory = [];

        function loadPosition() {
            try {
                const pos = JSON.parse(localStorage.getItem('mascotPosition'));
                if (pos) {
                    mascotContainer.style.left = pos.x + 'px';
                    mascotContainer.style.top = pos.y + 'px';
                }
            } catch (e) {}
        }

        function savePosition() {
            try {
                const rect = mascotContainer.getBoundingClientRect();
                localStorage.setItem('mascotPosition', JSON.stringify({ x: rect.left, y: rect.top }));
            } catch (e) {}
        }

        function updateBubblePosition() {
            const rect = mascotContainer.getBoundingClientRect();
            chatBubble.classList.toggle('left', rect.left > window.innerWidth - 500);
            chatBubble.classList.toggle('right', rect.left <= window.innerWidth - 500);
        }

        function toggleChat() {
            const isOpen = chatBubble.classList.toggle('open');
            if (isOpen) {
                updateBubblePosition();
                chatInput.focus();
            }
        }

        mascotBtn.addEventListener('mousedown', function(e) {
            isDragging = true;
            hasDragged = false;
            clickStartTime = Date.now();
            const rect = mascotContainer.getBoundingClientRect();
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            containerStartX = rect.left;
            containerStartY = rect.top;
            mascotBtn.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - dragStartX, deltaY = e.clientY - dragStartY;
            if (Math.abs(deltaX) > CLICK_MOVE_THRESHOLD || Math.abs(deltaY) > CLICK_MOVE_THRESHOLD) hasDragged = true;
            const newX = containerStartX + deltaX, newY = containerStartY + deltaY;
            const maxX = window.innerWidth - 84, maxY = window.innerHeight - 84;
            mascotContainer.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            mascotContainer.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
            if (chatBubble.classList.contains('open')) updateBubblePosition();
        });

        document.addEventListener('mouseup', function() {
            if (!isDragging) return;
            isDragging = false;
            mascotBtn.classList.remove('dragging');
            if (!hasDragged && (Date.now() - clickStartTime < CLICK_TIME_THRESHOLD)) toggleChat();
            else savePosition();
        });

        closeChat.addEventListener('click', () => chatBubble.classList.remove('open'));

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            addMessage(text, true);
            chatHistory.push({ role: "user", content: text });
            chatInput.value = '';
            chatInput.disabled = true;
            chatSend.disabled = true;
            const thinkingMsg = addMessage('Analyzing...', false);

            try {
                const response = await fetch('/.netlify/functions/AQI-Chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userMessage: text, history: chatHistory.slice(0, -1) })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                thinkingMsg.textContent = data.reply || "I couldn't process that request.";
                chatHistory.push({ role: "assistant", content: data.reply });

                if (data.action?.type === 'zoomTo') {
                    const { city, country } = data.action;
                    if (window.zoomToCity) {
                        document.getElementById('overlayStatus').textContent = `üó∫Ô∏è Zooming to ${city}...`;
                        window.zoomToCity(city, country);
                    }
                }
            } catch (error) {
                console.error('Chat error:', error);
                thinkingMsg.textContent = 'Sorry, I couldn\'t connect. Please try again.';
                chatHistory.pop();
            } finally {
                chatInput.disabled = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
        window.addEventListener('resize', () => { if (chatBubble.classList.contains('open')) updateBubblePosition(); });
        loadPosition();
    })();
  </script>
</body>
</html>