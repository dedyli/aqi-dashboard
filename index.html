<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AirLux ‚Äî Global Air Quality Intelligence</title>

<!-- ArcGIS -->
<link href="https://js.arcgis.com/4.29/esri/themes/light/main.css" rel="stylesheet"/>
<script src="https://js.arcgis.com/4.29/"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg-0: #0b0f17;
  --bg-1: #0f1422;
  --ink-0: #ffffff;
  --ink-1: #e5ecff;
  --ink-2: #a8b1c7;
  --glass: rgba(255,255,255,0.05);
  --glass-2: rgba(255,255,255,0.08);
  --glass-3: rgba(255,255,255,0.12);
  --stroke-1: rgba(255,255,255,0.12);
  --stroke-2: rgba(255,255,255,0.2);
  --shadow-xl: 0 30px 120px rgba(0,0,0,0.35);
  --shadow-lg: 0 18px 60px rgba(0,0,0,0.3);
  --radius-lg: 22px;
  --radius-xl: 30px;
  --gold: #d4af37;
  --foil: linear-gradient(135deg,#fff7cc 0%,#f6e39a 15%,#e6cc72 32%,#d4af37 55%,#b88a2b 70%,#f1e3a3 100%);
  --primary-grad: linear-gradient(135deg,#6ea8ff 0%, #7a6ff0 40%, #5536e4 100%);
  --accent-grad: linear-gradient(135deg,#00f2fe,#4facfe);
  --danger-grad: linear-gradient(135deg,#ff7e5f,#feb47b);
  --success-grad: linear-gradient(135deg,#3bd1a9,#0ea37d);
  --ease: cubic-bezier(.22,.61,.36,1);
}
*{box-sizing:border-box}
html,body{height:100%;background:radial-gradient(1200px 700px at 10% -10%,#1b255233,transparent 60%), linear-gradient(180deg,#0a0e18,#05070d 40%,#05070d);color:var(--ink-0);font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;overflow:hidden}
a{text-decoration:none;color:inherit}

/* Lux header */
.header{
  position:fixed;inset:0 0 auto 0;height:84px;display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;border-bottom:1px solid var(--stroke-1);backdrop-filter: blur(24px) saturate(160%);
  background:linear-gradient(180deg, rgba(20,24,40,.65), rgba(20,24,40,.35));
  z-index:1001;
}
.brand{display:flex;align-items:center;gap:16px}
.logo{
  width:48px;height:48px;border-radius:14px;display:grid;place-items:center;
  background:var(--foil); color:#1a1200; font-weight:900; font-size:20px; box-shadow:var(--shadow-lg);
}
.title{
  display:flex;flex-direction:column
}
.title h1{
  font:800 22px/1.1 "Playfair Display", serif;
  letter-spacing:.2px; margin:0;
  background:linear-gradient(90deg,#ffffff,#f7f1d3,#ffffff);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
}
.title span{font-size:12px;color:var(--ink-2);letter-spacing:.6px;text-transform:uppercase}

/* Left rail */
.rail{
  position:fixed;inset:84px auto 0 0;width:84px;border-right:1px solid var(--stroke-1);
  background:linear-gradient(180deg, rgba(18,22,34,.65), rgba(18,22,34,.35));backdrop-filter: blur(18px) saturate(160%);
  display:flex;flex-direction:column;align-items:center;padding:14px 10px;gap:10px;z-index:1000;
}
.rail .btn{
  width:56px;height:56px;border-radius:16px;background:var(--glass);display:grid;place-items:center;
  border:1px solid var(--stroke-1);cursor:pointer;transition:transform .25s var(--ease), background .25s var(--ease), border-color .25s var(--ease);
}
.rail .btn:hover{transform:translateY(-2px);background:var(--glass-2);border-color:var(--stroke-2)}
.rail .btn.active{background:var(--accent-grad);border-color:transparent}

/* Stage (map area) */
.stage{position:fixed;inset:84px 0 0 84px}
#viewWrap{position:absolute;inset:0;border-left:1px solid var(--stroke-1)}
#viewDiv{position:absolute;inset:0}

/* Command bar */
.commandbar{
  position:absolute;top:16px;left:50%;transform:translateX(-50%);
  display:flex;gap:8px;align-items:center;z-index:1002;
  background:linear-gradient(180deg, rgba(255,255,255,.08),rgba(255,255,255,.04));
  padding:10px;border-radius:999px;border:1px solid var(--stroke-1);backdrop-filter: blur(20px);
  box-shadow:var(--shadow-lg);
}
.commandbar input{
  width:360px;padding:14px 16px 14px 18px;border-radius:999px;border:1px solid var(--stroke-1);
  background:rgba(5,7,13,.6);color:var(--ink-1);outline:none;font-weight:600;letter-spacing:.2px;
}
.commandbar input::placeholder{color:#94a3b8}
.commandbar button{
  padding:12px 16px;border-radius:999px;border:1px solid var(--stroke-1);
  background:var(--accent-grad);color:white;font-weight:800;text-transform:uppercase;letter-spacing:.6px;cursor:pointer;
}

/* Layer pills (top-right) */
.pills{
  position:absolute;top:16px;right:18px;display:flex;gap:8px;flex-wrap:wrap;z-index:1002;max-width:46vw;justify-content:flex-end
}
.pill{padding:10px 14px;border-radius:999px;background:var(--glass);border:1px solid var(--stroke-1);cursor:pointer;font-size:12px;font-weight:700;letter-spacing:.4px;display:flex;align-items:center;gap:8px}
.pill input{display:none}
.pill.active{background:var(--glass-3);border-color:var(--stroke-2);box-shadow:0 6px 24px rgba(0,0,0,.15)}
.pill .dot{width:10px;height:10px;border-radius:50%;background:#4facfe}

/* Stats dock (bottom center) */
.statsDock{
  position:absolute;left:50%;bottom:18px;transform:translateX(-50%);
  display:grid;grid-template-columns:repeat(4, minmax(220px, 1fr));gap:14px;z-index:1002;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--stroke-1);border-radius:var(--radius-xl);padding:16px 18px;backdrop-filter: blur(18px);
  min-width:220px; box-shadow:var(--shadow-lg)
}
.card .k{
  font-family:"JetBrains Mono", monospace; font-weight:800; font-size:28px; line-height:1.1;
  background:var(--foil); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  letter-spacing:-0.5px;
}
.card .l{font-size:12px;color:var(--ink-2);text-transform:uppercase;letter-spacing:.5px}

/* Drawer (right) */
.drawer{
  position:fixed;inset:84px 0 0 auto;width:480px;transform:translateX(520px);
  transition:transform .4s var(--ease);z-index:1003;border-left:1px solid var(--stroke-1);
  background:linear-gradient(180deg, rgba(20,24,40,.8), rgba(20,24,40,.5)); backdrop-filter: blur(26px) saturate(180%);
}
.drawer.open{transform:translateX(0)}
.drawer .tabs{display:flex;padding:10px;gap:8px;border-bottom:1px solid var(--stroke-1)}
.tab{flex:1;text-align:center;padding:14px;border-radius:12px;background:var(--glass);border:1px solid var(--stroke-1);cursor:pointer;font-weight:700}
.tab.active{background:var(--accent-grad);border-color:transparent}
.panel{display:none;max-height:calc(100vh - 84px - 56px);overflow:auto;padding:22px}
.panel.active{display:block}

/* Section blocks */
.section{border:1px solid var(--stroke-1);border-radius:18px;padding:18px;margin-bottom:18px;background:rgba(255,255,255,.03)}
.section .head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.section .head .icon{width:40px;height:40px;border-radius:12px;background:var(--glass-2);display:grid;place-items:center;border:1px solid var(--stroke-1)}
.section .head .title{font-weight:800}

/* Lists */
.list{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto}
.row{display:flex;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--stroke-1);border-radius:14px;background:rgba(255,255,255,.03);cursor:pointer}
.tag{padding:8px 12px;border-radius:999px;font-size:12px;font-weight:800;text-transform:uppercase;border:1px solid rgba(255,255,255,.12)}
.tag.good{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.tag.mod{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.tag.bad{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}

/* Chat dock */
#mascotContainer{position:fixed;z-index:2000;right:18px;bottom:18px}
#mascotBtn{background:none;border:none;cursor:move;filter:drop-shadow(0 16px 40px rgba(0,0,0,.45))}
#mascotBtn img{width:160px;height:160px;border-radius:50%;border:3px solid rgba(255,255,255,.15)}
#chatBubble{
  position:fixed;right:200px;bottom:18px;width:480px;height:560px;border-radius:26px;border:1px solid var(--stroke-1);
  background:linear-gradient(180deg, rgba(24,28,44,.95), rgba(24,28,44,.85));backdrop-filter: blur(26px) saturate(180%);
  box-shadow:var(--shadow-xl);transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:all .35s var(--ease)
}
#chatBubble.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
#chatHeader{padding:18px 22px;background:var(--primary-grad);display:flex;align-items:center;justify-content:space-between;border-radius:26px 26px 0 0}
#chatMessages{height:calc(100% - 160px);overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.message{max-width:85%;padding:12px 14px;border-radius:14px;font-size:14px;line-height:1.5}
.message.user{align-self:flex-end;background:var(--accent-grad);color:#fff}
.message.bot{align-self:flex-start;background:rgba(255,255,255,.06);border:1px solid var(--stroke-1)}
#chatInputArea{display:flex;gap:10px;padding:14px;border-top:1px solid var(--stroke-1);background:rgba(0,0,0,.15)}
#chatInput{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke-1);background:rgba(255,255,255,.06);color:var(--ink-0)}
#chatSend{padding:12px 16px;border-radius:12px;border:1px solid var(--stroke-1);background:var(--accent-grad);color:#fff;font-weight:800;letter-spacing:.4px}

/* Overlay toast */
#overlayStatus{position:absolute;top:18px;left:18px;z-index:1002;padding:14px 18px;border-radius:14px;border:1px solid var(--stroke-1);background:rgba(24,28,44,.8);backdrop-filter: blur(20px);display:none}

/* Loading */
#loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:800;font-size:20px;color:#a5b4fc}

/* Responsive */
@media (max-width: 1024px){
  .statsDock{grid-template-columns:repeat(2,minmax(220px,1fr))}
  .commandbar input{width:58vw}
  .drawer{width:92vw}
}
@media (max-width: 640px){
  .rail{width:70px}
  .stage{left:70px}
  #chatBubble{right:16px;width:92vw}
  .statsDock{grid-template-columns:repeat(2,minmax(160px,1fr))}
  .commandbar{left:auto;right:16px;transform:none}
  .pills{left:16px;right:auto;justify-content:flex-start}
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="brand">
    <div class="logo">AQ</div>
    <div class="title">
      <h1>AirLux ‚Äì Global Air Quality Intelligence</h1>
      <span>AI-Driven Environmental Monitoring</span>
    </div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <div class="pill active" title="Live Data"><span class="dot"></span>Live Data</div>
  </div>
</header>

<!-- Left rail -->
<nav class="rail">
  <div class="btn" id="btnSearch" title="Search (S)">üîé</div>
  <div class="btn" id="btnInsights" title="Insights">üìä</div>
  <div class="btn" id="btnSettings" title="Settings">‚öôÔ∏è</div>
  <div class="btn" id="btnChat" title="Chat">üí¨</div>
</nav>

<!-- Stage -->
<main class="stage">
  <div id="viewWrap">
    <div id="viewDiv">
      <div id="loading">Loading map‚Ä¶</div>
      <div id="overlayStatus"></div>
    </div>

    <!-- Commandbar (global search) -->
    <div class="commandbar" id="cmdBar">
      <input id="searchInput" placeholder="Search any city worldwide‚Ä¶" />
      <button id="searchBtn">Analyze</button>
    </div>

    <!-- Layer pills -->
    <div class="pills">
      <label class="pill active" data-layer="aqi"><input type="checkbox" id="layerAQI" checked><span class="dot"></span>PM2.5 Stations</label>
      <label class="pill active" data-layer="gaqi"><input type="checkbox" id="layerGoogleAQI" checked><span class="dot"></span>Google AQI Cities</label>
      <label class="pill active" data-layer="flow"><input type="checkbox" id="layerFlow" checked><span class="dot"></span>Ocean Flow</label>
      <label class="pill active" data-layer="fire"><input type="checkbox" id="layerFire" checked><span class="dot"></span>Active Fires</label>
      <label class="pill active" data-layer="cities"><input type="checkbox" id="layerCities" checked><span class="dot"></span>World Cities</label>
      <label class="pill active" data-layer="legend"><input type="checkbox" id="layerLegend" checked><span class="dot"></span>Legend</label>
    </div>

    <!-- Stats dock -->
    <section class="statsDock" id="statsDock">
      <div class="card">
        <div class="k" id="kStations">0</div>
        <div class="l">Live Stations</div>
      </div>
      <div class="card">
        <div class="k" id="kCities">0</div>
        <div class="l">Cities Monitored</div>
      </div>
      <div class="card">
        <div class="k" id="kFires">0</div>
        <div class="l">Active Fires (24h)</div>
      </div>
      <div class="card">
        <div class="k">üåä</div>
        <div class="l">Ocean Currents</div>
      </div>
    </section>
  </div>
</main>

<!-- Drawer (Insights + Settings) -->
<aside class="drawer" id="drawer">
  <div class="tabs">
    <div class="tab active" data-tab="insights">Insights</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- Insights panel -->
  <div class="panel active" id="panelInsights">
    <section class="section">
      <div class="head"><div class="icon">üîç</div><div class="title">Location Intelligence</div></div>
      <p style="color:var(--ink-2);margin-bottom:12px">Use the top search bar to analyze any city. Results will reflect below.</p>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üè≠</div><div class="title">Critical Air Quality Zones</div></div>
      <div class="list" id="topCities">
        <div style="opacity:.8">Loading critical zones‚Ä¶</div>
      </div>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üåç</div><div class="title">Google AQI Network</div></div>
      <div class="list" id="googleAqiList">
        <div style="opacity:.8">Connecting to Google AQI‚Ä¶</div>
      </div>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üìà</div><div class="title">Data Sources & System Status</div></div>
      <ul style="color:var(--ink-2);line-height:1.8;margin:0 0 12px 18px">
        <li>Live stations: OpenAQ via Esri Living Atlas</li>
        <li>World cities: Major cities worldwide</li>
        <li>Regional AQI: Google Air Quality API</li>
        <li>Ocean currents: Global ocean circulation (animated)</li>
        <li>Fire data: NASA VIIRS thermal hotspots (24hr)</li>
      </ul>
      <div id="status" style="color:var(--ink-1);font-weight:600"></div>
    </section>
  </div>

  <!-- Settings panel -->
  <div class="panel" id="panelSettings">
    <section class="section">
      <div class="head"><div class="icon">üó∫Ô∏è</div><div class="title">Map Visualization</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="row basemap-option active" data-basemap="satellite">Satellite Imagery</div>
        <div class="row basemap-option" data-basemap="streets">Street Map</div>
        <div class="row basemap-option" data-basemap="hybrid">Hybrid View</div>
        <div class="row basemap-option" data-basemap="terrain">Terrain</div>
        <div class="row basemap-option" data-basemap="dark-gray">Dark Theme</div>
        <div class="row basemap-option" data-basemap="topo">Topographic</div>
        <div class="row basemap-option" data-basemap="gray">Light Gray</div>
        <div class="row basemap-option" data-basemap="oceans">Ocean View</div>
      </div>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üìä</div><div class="title">Data Layer Controls</div></div>
      <div class="row"><span>PM2.5 Stations (OpenAQ)</span><input checked type="checkbox" id="layerAQI_dup"/></div>
      <div class="row"><span>Cities (Google AQI)</span><input checked type="checkbox" id="layerGoogleAQI_dup"/></div>
      <div class="row"><span>üåä Flow Animation (Active)</span><input checked type="checkbox" id="layerFlow_dup"/></div>
      <div class="row"><span>üî• Active Fire Hotspots</span><input checked type="checkbox" id="layerFire_dup"/></div>
      <div class="row"><span>World Cities</span><input checked type="checkbox" id="layerCities_dup"/></div>
      <div class="row"><span>Legend</span><input checked type="checkbox" id="layerLegend_dup"/></div>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üî•</div><div class="title">Fire Intensity Filter</div></div>
      <div style="color:var(--ink-2);margin-bottom:8px">Minimum Brightness (K): <b id="brightnessValue">365</b></div>
      <input type="range" id="brightnessSlider" min="365" max="500" value="365" step="5" style="width:100%">
      <div style="color:var(--ink-2);margin-top:8px">Higher values focus on more significant fires.</div>
    </section>

    <section class="section">
      <div class="head"><div class="icon">üéÆ</div><div class="title">Animation Settings</div></div>
      <div style="display:grid;gap:12px">
        <label>Flow Speed: <b id="speedValue">6</b></label>
        <input type="range" id="windSpeed" min="1" max="20" value="6">
        <label>Density: <b id="densityValue">0.7</b></label>
        <input type="range" id="windDensity" min="0.1" max="1" step="0.1" value="0.7">
        <label>Trail Length: <b id="trailValue">120</b></label>
        <input type="range" id="windTrail" min="50" max="300" value="120">
        <div style="display:flex;gap:10px">
          <button class="row preset-btn" data-p="subtle">Subtle</button>
          <button class="row preset-btn active" data-p="normal">Normal</button>
          <button class="row preset-btn" data-p="intense">Intense</button>
        </div>
      </div>
    </section>
  </div>
</aside>

<!-- Mascot + Chat -->
<div id="mascotContainer">
  <button id="mascotBtn" title="Click to chat with AQI Assistant">
    <img src="mascot.png" alt="AQI Warrior mascot"/>
  </button>
</div>
<div id="chatBubble" aria-live="polite">
  <div id="chatHeader">
    <span>üåç AQI Assistant</span>
    <button id="closeChat" title="Close chat" style="background:none;border:none;color:white;font-size:24px;cursor:pointer">√ó</button>
  </div>
  <div id="chatMessages">
    <div class="message bot">Hi! I'm your AQI Assistant. Ask me about air quality anywhere in the world. Try: "What's the PM2.5 in Beijing?" or "Show me the most polluted cities."</div>
  </div>
  <div id="chatInputArea">
    <input id="chatInput" placeholder="Ask about air quality‚Ä¶" />
    <button id="chatSend">Send</button>
  </div>
</div>

<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/FeatureLayer","esri/layers/GeoJSONLayer",
  "esri/layers/ImageryLayer","esri/layers/MapImageLayer",
  "esri/layers/ImageryTileLayer","esri/renderers/FlowRenderer",
  "esri/widgets/Legend","esri/config"
], function(Map, MapView, FeatureLayer, GeoJSONLayer, ImageryLayer, MapImageLayer, ImageryTileLayer, FlowRenderer, Legend, esriConfig) {

  // Globals
  let googleAqiLayer = null;
  let googleAqiData = null;
  let fireLayer = null;
  let flowLayer = null;
  let legendWidget = null;
  const fireBaseDefinition = "ACQ_DATE >= CURRENT_DATE - 1";

  // Map
  const map = new Map({ basemap: "satellite" });
  const view = new MapView({
    container: "viewDiv",
    map, center: [105, 35], zoom: 4,
    popup: { dockEnabled: true, dockOptions:{ buttonEnabled: false, breakpoint: false, position: "bottom-right" } }
  });

  try { esriConfig.request.corsEnabledServers.push(window.location.origin); } catch(e) {}

  // Toast
  const toast = (msg, ms = 2200) => {
    const el = document.getElementById("overlayStatus");
    el.textContent = msg; el.style.display = "block";
    clearTimeout(el._t); el._t = setTimeout(() => el.style.display = "none", ms);
  };

  // PM2.5 Layer (OpenAQ)
  const pm25ClusterConfig = {
    type: "cluster",
    clusterRadius: "80px",
    popupTemplate: {
      title: "Cluster Summary",
      content: "This cluster represents <b>{cluster_count}</b> stations with an average PM2.5 value of <b>{cluster_avg_value}</b> ¬µg/m¬≥.",
      fieldInfos: [{
        fieldName: "cluster_count", format: { places: 0, digitSeparator: true }
      }, { fieldName: "cluster_avg_value", format: { places: 1, digitSeparator: true } }]
    },
    clusterMinSize: "20px",
    clusterMaxSize: "50px",
    labelingInfo: [{
      deconflictionStrategy: "none",
      labelExpressionInfo: { expression: "Text($feature.cluster_count, '#,###')" },
      symbol: { type: "text", color: "#000", font: { weight: "bold", family: "Inter", size: "12px" } },
      labelPlacement: "center-center",
    }],
    summaryStatistics: [{
      onStatisticField: "value",
      outStatisticFieldName: "cluster_avg_value",
      statisticType: "avg"
    }]
  };

  const pm25Layer = new FeatureLayer({
    url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Air_Quality_PM25_Latest_Results/FeatureServer/0",
    title:"PM2.5 Stations (OpenAQ)", outFields:["*"],
    featureReduction: pm25ClusterConfig,
    popupTemplate:{ title:"{location} ({country_name})", content:`<div style="line-height:1.5"><b>City:</b> {city}<br><b>PM2.5:</b> {value} {unit}<br><b>Provider:</b> {provider_name}<br><b>Updated:</b> {lastUpdated}<br><a href="{url}" target="_blank" rel="noopener">Station link</a></div>` },
    renderer:{ type:"class-breaks", field:"value", classBreakInfos:[
      {minValue:0,maxValue:10,symbol:{type:"simple-marker",size:8,color:"#00e400",outline:{color:"#fff",width:1}},label:"Good (0‚Äì10)"},
      {minValue:10.1,maxValue:25,symbol:{type:"simple-marker",size:10,color:"#ffff00",outline:{color:"#fff",width:1}},label:"Moderate (10‚Äì25)"},
      {minValue:25.1,maxValue:50,symbol:{type:"simple-marker",size:12,color:"#ff7e00",outline:{color:"#fff",width:1}},label:"USG (25‚Äì50)"},
      {minValue:50.1,maxValue:75,symbol:{type:"simple-marker",size:14,color:"#ff0000",outline:{color:"#fff",width:1}},label:"Unhealthy (50‚Äì75)"},
      {minValue:75.1,maxValue:100,symbol:{type:"simple-marker",size:16,color:"#8f3f97",outline:{color:"#fff",width:1}},label:"Very Unhealthy (75‚Äì100)"},
      {minValue:100.1,maxValue:9999,symbol:{type:"simple-marker",size:18,color:"#7e0023",outline:{color:"#fff",width:1}},label:"Hazardous (100+)"}
    ]}
  });
  map.add(pm25Layer);
  window.pm25Layer = pm25Layer;

  // Cities layer (reference)
  const citiesLayer = new FeatureLayer({
    url:"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Cities/FeatureServer/0",
    title:"World Cities", definitionExpression:"POP > 100000",
    renderer:{ type:"simple", symbol:{ type:"simple-marker", size:3, color:[255,255,255,0.4], outline:{ width:.5, color:[0,0,0,.2] } } },
    labelingInfo:[{ symbol:{ type:"text", color:"white", haloColor:"black", haloSize:.5, font:{ family:"Arial", size:8 } },
      labelPlacement:"above-center", labelExpressionInfo:{ expression:"$feature.CITY_NAME" }, minScale:10000000 }],
    popupTemplate:{ title:"{CITY_NAME}, {CNTRY_NAME}", content:"Population: {POP:NumberFormat}" }
  });
  map.add(citiesLayer);

  // Flow layer (ocean currents)
  flowLayer = new ImageryTileLayer({
    url:"https://tiledimageservices.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Spilhaus_UV_ocean_currents/ImageServer",
    title:"Global Ocean Currents", opacity:0.8, visible:true,
    renderer: new FlowRenderer({
      type:"flow", density:0.7, flowSpeed:6, trailLength:120, trailWidth:"2px", maxPathLength:180,
      visualVariables:[{ type:"color", field:"Magnitude", stops:[
        {color:[30,100,150,0.6],value:0},{color:[50,150,200,0.7],value:0.1},{color:[100,200,255,0.8],value:0.3},
        {color:[150,255,200,0.9],value:0.6},{color:[255,255,100,1],value:1},{color:[255,100,100,1],value:1.5}
      ]}]
    }),
    popupTemplate:{ title:"üåä Global Ocean Currents", content:`<div style="line-height:1.5"><b>üåä Current Speed:</b> {Magnitude} m/s<br><b>üß≠ Current Direction:</b> {Direction}¬∞<br><b>üìä Data Source:</b> Global Ocean Current Model<br><b>üåç Coverage:</b> Worldwide Ocean Currents</div>` }
  });
  map.add(flowLayer, 2);
  window.flowLayer = flowLayer;

  // Fire layer
  fireLayer = new FeatureLayer({
    url:"https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
    title:"Active Fires & Thermal Hotspots (VIIRS)", opacity:0.9, visible:true,
    renderer:{ type:"simple", symbol:{ type:"simple-marker", style:"circle", size:8, color:[255,69,0,0.8], outline:{color:"yellow",width:1}}},
    popupTemplate:{ title:"üî• Active Fire Detection", content:`<div style="line-height:1.5"><b>üî• Fire Brightness:</b> {BRIGHT_TI4} K<br><b>üìÖ Detection Date:</b> {ACQ_DATE}<br><b>üïí Detection Time:</b> {ACQ_TIME}<br><b>üõ∞Ô∏è Satellite:</b> {SATELLITE}<br><b>üìç Confidence:</b> {CONFIDENCE}<br><b>üìç Coordinates:</b> {LATITUDE}, {LONGITUDE}<br><b>üìä Data Source:</b> NASA VIIRS</div>` },
    definitionExpression: `${fireBaseDefinition} AND (BRIGHT_TI4 >= 365)`
  });
  map.add(fireLayer, 4);
  window.fireLayer = fireLayer;

  // Legend
  legendWidget = new Legend({ view, layerInfos:[] });
  view.ui.add(legendWidget, "bottom-left");

  function updateLegend(){
    if (!legendWidget) return;
    const layerInfos = [];
    if (pm25Layer.visible) layerInfos.push({ layer:pm25Layer, title:"PM2.5 (Œºg/m¬≥) ‚Äî Live Stations" });
    if (googleAqiLayer && googleAqiLayer.visible) layerInfos.push({ layer:googleAqiLayer, title:"Cities (Google AQI)" });
    if (flowLayer.visible) layerInfos.push({ layer:flowLayer, title:"üåä Animated Flow" });
    if (fireLayer.visible) layerInfos.push({ layer:fireLayer, title:"Active Fires & Thermal Hotspots (VIIRS)" });
    legendWidget.layerInfos = layerInfos;
  }

  // Google AQI
  function createGoogleAqiLayer(geoJsonData) {
    const blob = new Blob([JSON.stringify(geoJsonData)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    return new GeoJSONLayer({
      url: url,
      title: "Cities (Google AQI)",
      copyright: "¬© Google Air Quality API - Live Data",
      featureReduction: {
        type: "cluster",
        clusterRadius: "80px",
        popupTemplate: {
          title: "Cluster Summary",
          content: "This cluster represents <b>{cluster_count}</b> cities with an average AQI of <b>{cluster_avg_aqi}</b>.",
          fieldInfos: [
            { fieldName: "cluster_count", format: { places: 0, digitSeparator: true } },
            { fieldName: "cluster_avg_aqi", format: { places: 0, digitSeparator: true } }
          ]
        },
        clusterMinSize: "20px",
        clusterMaxSize: "50px",
        labelingInfo: [{
          deconflictionStrategy: "none",
          labelExpressionInfo: { expression: "Text($feature.cluster_count, '#,###')" },
          symbol: { type: "text", color: "#ffffff", haloColor: "#000000", haloSize: "1px", font: { weight: "bold", family: "Inter", size: "12px" } },
          labelPlacement: "center-center",
        }],
        summaryStatistics: [{
          onStatisticField: "aqi",
          outStatisticFieldName: "cluster_avg_aqi",
          statisticType: "avg"
        }]
      },
      renderer: {
        type: "class-breaks",
        field: "aqi",
        classBreakInfos: [
          { minValue: 0, maxValue: 50, symbol: { type: "simple-marker", style: "triangle", size: 12, color: "#00e400", outline: { color: "#fff", width: 1.5 } }, label: "Good (0‚Äì50)" },
          { minValue: 51, maxValue: 100, symbol: { type: "simple-marker", style: "triangle", size: 14, color: "#ffff00", outline: { color: "#fff", width: 1.5 } }, label: "Moderate (51‚Äì100)" },
          { minValue: 101, maxValue: 150, symbol: { type: "simple-marker", style: "triangle", size: 16, color: "#ff7e00", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy for Sensitive (101‚Äì150)" },
          { minValue: 151, maxValue: 200, symbol: { type: "simple-marker", style: "triangle", size: 18, color: "#ff0000", outline: { color: "#fff", width: 1.5 } }, label: "Unhealthy (151‚Äì200)" },
          { minValue: 201, maxValue: 300, symbol: { type: "simple-marker", style: "triangle", size: 20, color: "#8f3f97", outline: { color: "#fff", width: 1.5 } }, label: "Very Unhealthy (201‚Äì300)" },
          { minValue: 301, maxValue: 9999, symbol: { type: "simple-marker", style: "triangle", size: 22, color: "#7e0023", outline: { color: "#fff", width: 1.5 } }, label: "Hazardous (300+)" }
        ]
      },
      popupTemplate: {
        title: "{name} - Google AQI",
        content: `<div style="line-height:1.5"><b>üå¨Ô∏è US AQI:</b> <span style="font-size:18px;font-weight:bold;">{aqi}</span><br><b>üìä Category:</b> {category}<br><b>üí® Dominant Pollutant:</b> {main_pollutant}<br><b>üïí Last Updated:</b> {time}<br><b>üìç Location:</b> {name}<br><b>üìä Data Source:</b> {source}</div>`
      }
    });
  }

  async function loadGoogleAqiData() {
    try {
      toast("Loading Google AQI data...", 3000);
      const response = await fetch('/.netlify/functions/google-aqi');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      googleAqiData = await response.json();
      if (googleAqiData.warning) console.warn("API Warning:", googleAqiData.warning);
      googleAqiLayer = createGoogleAqiLayer(googleAqiData);
      map.add(googleAqiLayer, 1);
      await googleAqiLayer.load();
      toast("‚úÖ Google AQI data loaded!");
      updateLegend();
      updateGoogleAqiList(googleAqiData);
      updateCounters();
    } catch (error) {
      console.error("Failed to load Google AQI data:", error);
      toast("‚ùå Failed to load Google AQI data");
      document.getElementById("googleAqiList").innerHTML = `<div style="opacity:.85; color: #ffdddd; padding: 10px;">Failed to load.</div>`;
    }
  }

  function updateGoogleAqiList(geoJsonData) {
    const listElement = document.getElementById("googleAqiList");
    if (!geoJsonData || !geoJsonData.features || geoJsonData.features.length === 0) {
      listElement.innerHTML = '<div style="opacity:.85; padding: 10px;">No data available</div>';
      return;
    }
    const cities = geoJsonData.features.map(f => f.properties).sort((a, b) => b.aqi - a.aqi);
    const getAqiClass = aqi => aqi <= 50 ? "good" : aqi <= 100 ? "mod" : "bad";
    listElement.innerHTML = "";
    cities.forEach(city => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${city.name}</div>
          <div style="font-size:12px;color:#94a3b8">Google AQI Data</div>
        </div>
        <span class="tag ${getAqiClass(city.aqi)}">${city.aqi}</span>
      `;
      row.addEventListener("click", () => {
        const feature = geoJsonData.features.find(f => f.properties.name === city.name);
        if (feature) view.goTo({ center: feature.geometry.coordinates, zoom: 11 }, { duration: 1500 });
      });
      listElement.appendChild(row);
    });
  }

  // Top cities from PM2.5 (OpenAQ)
  async function refreshTopCities(){
    try{
      const q = await pm25Layer.queryFeatures({
        where: "value IS NOT NULL",
        outFields: ["value","location","city","country_name","unit"],
        orderByFields: ["value DESC"],
        num: 30,
        returnGeometry: true
      });
      const list = document.getElementById("topCities");
      list.innerHTML = "";
      q.features.slice(0, 20).forEach(f => {
        const attr = f.attributes;
        const row = document.createElement("div");
        row.className = "row";
        const aqiClass = attr.value <= 10 ? "good" : (attr.value <= 25 ? "mod" : "bad");
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${attr.location || attr.city || "Unknown"}</div>
            <div style="font-size:12px;color:#94a3b8">${attr.city || ""} ${attr.country_name ? "‚Ä¢ " + attr.country_name : ""}</div>
          </div>
          <span class="tag ${aqiClass}">${Math.round(attr.value)} ${attr.unit || ""}</span>
        `;
        row.addEventListener("click", () => {
          if (f.geometry) view.goTo({ center: f.geometry, zoom: 11 }, { duration: 1500 });
        });
        list.appendChild(row);
      });
    }catch(e){
      console.error(e);
      document.getElementById("topCities").innerHTML = '<div style="opacity:.8">Failed to load.</div>';
    }
  }

  // Counters
  function animateNumber(el, to, duration=1100){
    if (!el) return;
    const from = 0;
    const start = performance.now();
    function frame(t){
      const p = Math.min(1, (t - start)/duration);
      const val = Math.floor(from + (to - from) * (0.5 - 0.5*Math.cos(Math.PI*p)));
      el.textContent = val.toLocaleString();
      if (p < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }
  function updateCounters(){
    pm25Layer.queryFeatureCount().then(c => animateNumber(document.getElementById("kStations"), c || 0));
    const n = (googleAqiData && Array.isArray(googleAqiData.features)) ? googleAqiData.features.length : 0;
    animateNumber(document.getElementById("kCities"), n);
    fireLayer.queryFeatureCount().then(c => animateNumber(document.getElementById("kFires"), c || 0));
  }

  // Status
  async function updateStatus(){
    try{
      const c1 = await pm25Layer.queryFeatureCount();
      const c2 = googleAqiLayer ? await googleAqiLayer.queryFeatureCount() : 0;
      const c3 = await fireLayer.queryFeatureCount();
      const parts = [`‚úì PM2.5 stations connected (${c1.toLocaleString()})`];
      if (c2) parts.push(`‚úì Google AQI cities (${c2.toLocaleString()})`);
      parts.push(`‚úì Active fires indexed (${c3.toLocaleString()})`);
      document.getElementById("status").textContent = parts.join(" ‚Ä¢ ");
    }catch(e){
      document.getElementById("status").textContent = "Initializing connections‚Ä¶";
    }
  }

  // Search
  async function locateByText(){
    const v = (document.getElementById("searchInput").value || "").trim();
    if (!v) return;
    try{
      const fetchUrl = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&SingleLine=${encodeURIComponent(v)}&outFields=Match_addr,Addr_type&maxLocations=1`;
      const res = await fetch(fetchUrl);
      const j = await res.json();
      if (j.candidates && j.candidates.length){
        const loc = j.candidates[0].location;
        view.goTo({ center: [loc.x, loc.y], zoom: 11 }, { duration: 1200 });
        toast(`üìç ${j.candidates[0].address}`);
      }else{
        toast("No results found");
      }
    }catch(e){
      toast("Search failed");
    }
  }

  // Load sequence
  view.whenLayerView(pm25Layer).then(() => {
    legendWidget.layerInfos = [];
    document.getElementById("loading").style.display = "none";
    loadGoogleAqiData();
    refreshTopCities();
    updateCounters();
    updateStatus();
    setInterval(refreshTopCities, 30 * 60 * 1000);
  });

  // UI wiring ‚Äî rail buttons
  const drawer = document.getElementById("drawer");
  const btnInsights = document.getElementById("btnInsights");
  const btnSettings = document.getElementById("btnSettings");
  const btnChat = document.getElementById("btnChat");
  const btnSearch = document.getElementById("btnSearch");
  const tabs = [...document.querySelectorAll(".tab")];
  const panels = {insights: document.getElementById("panelInsights"), settings: document.getElementById("panelSettings")};

  function openDrawer(name){
    tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
    Object.keys(panels).forEach(k => panels[k].classList.toggle("active", k===name));
    drawer.classList.add("open");
  }
  btnInsights.addEventListener("click", ()=>openDrawer("insights"));
  btnSettings.addEventListener("click", ()=>openDrawer("settings"));
  btnSearch.addEventListener("click", ()=>document.getElementById("searchInput").focus());

  // Tabs
  tabs.forEach(t => t.addEventListener("click", ()=>openDrawer(t.dataset.tab)));

  // Close drawer when clicking outside (optional)
  view.on("click", ()=> drawer.classList.remove("open"));

  // Commandbar search
  document.getElementById("searchBtn").addEventListener("click", locateByText);
  document.getElementById("searchInput").addEventListener("keydown", e => { if (e.key==="Enter") locateByText(); });

  // Layer pills + duplicates in settings panel
  function syncVisibility(id, layer, state){
    const box = document.getElementById(id);
    const dup = document.getElementById(id+"_dup");
    if (box) box.checked = state;
    if (dup) dup.checked = state;
    if (layer) layer.visible = state;
    updateLegend();
  }
  const pillMap = {
    aqi: { id:"layerAQI", layer: pm25Layer },
    gaqi:{ id:"layerGoogleAQI", layer: ()=>googleAqiLayer },
    flow:{ id:"layerFlow", layer: flowLayer },
    fire:{ id:"layerFire", layer: fireLayer },
    cities:{ id:"layerCities", layer: citiesLayer },
    legend:{ id:"layerLegend", layer: null }
  };

  document.querySelectorAll(".pill").forEach(el => {
    el.addEventListener("click", (e)=>{
      const key = el.dataset.layer;
      const meta = pillMap[key];
      const active = !el.classList.contains("active");
      el.classList.toggle("active", active);
      if (key === "legend"){
        legendWidget.visible = active;
        const box = document.getElementById("layerLegend");
        const dup = document.getElementById("layerLegend_dup");
        if (box) box.checked = active;
        if (dup) dup.checked = active;
      }else{
        const layerObj = typeof meta.layer === "function" ? meta.layer() : meta.layer;
        syncVisibility(meta.id, layerObj, active);
      }
    });
  });

  ["AQI","GoogleAQI","Flow","Fire","Cities","Legend"].forEach(k => {
    const base = "layer"+k;
    const box = document.getElementById(base);
    const dup = document.getElementById(base+"_dup");
    function bind(el){
      if (!el) return;
      el.addEventListener("change", ()=>{
        const state = el.checked;
        const other = el===box ? dup : box;
        if (other) other.checked = state;
        // apply
        switch(k){
          case "AQI": pm25Layer.visible = state; break;
          case "GoogleAQI": if (googleAqiLayer) googleAqiLayer.visible = state; break;
          case "Flow": flowLayer.visible = state; break;
          case "Fire": fireLayer.visible = state; break;
          case "Cities": citiesLayer.visible = state; break;
          case "Legend": legendWidget.visible = state; break;
        }
        updateLegend();
      });
    }
    bind(box); bind(dup);
  });

  // Basemap options
  document.querySelectorAll(".basemap-option").forEach(el => {
    el.addEventListener("click", ()=>{
      document.querySelectorAll(".basemap-option").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      const name = el.getAttribute("data-basemap");
      map.basemap = name;
    });
  });

  // Fire brightness slider
  const bright = document.getElementById("brightnessSlider");
  const brightVal = document.getElementById("brightnessValue");
  bright.addEventListener("input", ()=>{
    brightVal.textContent = bright.value;
    const q = `${fireBaseDefinition} AND (BRIGHT_TI4 >= ${bright.value})`;
    fireLayer.definitionExpression = q;
    updateCounters();
  });

  // Flow settings
  function setWindPreset(p){
    document.querySelectorAll(".preset-btn").forEach(b=>b.classList.toggle("active", b.dataset.p===p));
    const speed = document.getElementById("windSpeed");
    const density = document.getElementById("windDensity");
    const trail = document.getElementById("windTrail");
    if (p==="subtle"){ speed.value=3; density.value=0.4; trail.value=90; }
    if (p==="normal"){ speed.value=6; density.value=0.7; trail.value=120; }
    if (p==="intense"){ speed.value=12; density.value=0.9; trail.value=180; }
    applyFlow();
  }
  function applyFlow(){
    const s = Number(document.getElementById("windSpeed").value);
    const d = Number(document.getElementById("windDensity").value);
    const t = Number(document.getElementById("windTrail").value);
    document.getElementById("speedValue").textContent = s;
    document.getElementById("densityValue").textContent = d;
    document.getElementById("trailValue").textContent = t;
    const r = flowLayer.renderer.clone();
    r.flowSpeed = s; r.density = d; r.trailLength = t;
    flowLayer.renderer = r;
  }
  document.querySelectorAll(".preset-btn").forEach(b=>b.addEventListener("click",()=>setWindPreset(b.dataset.p)));
  ["windSpeed","windDensity","windTrail"].forEach(id => document.getElementById(id).addEventListener("input", applyFlow));

  // Chat + mascot
  const chat = document.getElementById("chatBubble");
  function toggleChat(open){
    chat.classList.toggle("open", open===undefined ? !chat.classList.contains("open") : open);
  }
  document.getElementById("btnChat").addEventListener("click", ()=>toggleChat());
  document.getElementById("closeChat").addEventListener("click", ()=>toggleChat(false));
  const mascotBtn = document.getElementById("mascotBtn");
  mascotBtn.addEventListener("click", ()=>toggleChat());

  // Mascot drag
  (function(){
    const container = document.getElementById("mascotContainer");
    let dragging=false, sx=0, sy=0, sl=0, st=0;
    mascotBtn.addEventListener("mousedown", (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=container.getBoundingClientRect(); sl=r.left; st=r.top; e.preventDefault(); });
    window.addEventListener("mousemove", (e)=>{ if(!dragging) return; const nl=sl + (e.clientX - sx); const nt=st + (e.clientY - sy); container.style.left = nl+"px"; container.style.top = nt+"px"; container.style.right="auto"; container.style.bottom="auto"; });
    window.addEventListener("mouseup", ()=> dragging=false);
  })();

  // Drawer default open on load
  setTimeout(()=> openDrawer("insights"), 800);

  // Utility to expose functions
  window.setWindPreset = setWindPreset;

  // After GAQI load, refresh status periodically
  setInterval(()=>{ updateStatus(); updateCounters(); }, 5*60*1000);

}); // end require
</script>

</body>
</html>